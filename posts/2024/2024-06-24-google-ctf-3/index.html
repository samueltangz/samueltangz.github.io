<!DOCTYPE html>
<html lang="en-us" dir="ltr" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Google CTF 2024 (III): IDEA | Mystify</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=Libre+Baskerville:ital,wght@0,400..700;1,400..700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css"
  integrity="sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA==" crossorigin="anonymous"
  referrerpolicy="no-referrer" />
<link rel="stylesheet" href="/css/main.min.27b43d01a5c4432e35e87df4c1026d71d0e56b69b492a4e65a5564c213f27fa9.css" integrity="sha256-J7Q9AaXEQy416H30wQJtcdDla2m0kqTmWlVkwhPyf6k=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/prism.min.ebb6c0bd3fe6ed4e16ec09f3b52903ee18ddfb21e33b6882030d951a91b213e4.css" integrity="sha256-67bAvT/m7U4W7AnztSkD7hjd&#43;yHjO2iCAw2VGpGyE&#43;Q=" crossorigin="anonymous">

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.min.js"
  integrity="sha512-nKXmKvJyiGQy343jatQlzDprflyB5c+tKCzGP3Uq67v+lmzfnZUi/ZT+fc6ITZfSC5HhaBKUIvr/nTLCV+7F+Q==" crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
        <script src="/js/main.f2979a93a325fecf9605263bd141398a311c8e23388ed7dcff74f92f7e632866.js" integrity="sha256-8peak6Ml/s&#43;WBSY70UE5ijEcjiM4jtfc/3T5L35jKGY=" crossorigin="anonymous"></script>
        <script src="/js/prism.0ecb34b0181efd0f9aa6d1a8fc2e4814ffbdd9acc78d93d02a94e01f64f87f35.js" integrity="sha256-Dss0sBge/Q&#43;aptGo/C5IFP&#43;92azHjZPQKpTgH2T4fzU=" crossorigin="anonymous"></script>



</head>
<body class="overflow-y-scroll">
  <nav class="navbar navbar-expand-lg sticky-top bg-body-tertiary">
  <div class="container">
    <a class="navbar-brand" href="/">Mystify</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <div class="navbar-nav">
        
        
          <a class="nav-link " href="/about-me/">
            About Me 
          </a>
        
          <a class="nav-link " href="/blogroll/">
            Blogroll 
          </a>
        
          <a class="nav-link " href="/crypto-in-ctf/">
            Crypto in CTF 
          </a>
        
      </div>
    </div>
  </div>
</nav>

  <main>
    <div class="container mt-3">
      
  <div class="row justify-content-center">
    <div class="col-8">
      <h1 class="post-title">Google CTF 2024 (III): IDEA</h1>

      
      <div class="text-muted pb-4">
        
          
          
          <time datetime="2024-06-24T02:00:02&#43;08:00">2024-06-24</time>
        
        
        <span class="px-1">::</span>
        
        
          <span class="badge rounded-pill bg-secondary">
            <a href="https://mystiz.hk/tags/ctf/" class="text-muted text-decoration-none">#ctf</a>
          </span>
        
          <span class="badge rounded-pill bg-secondary">
            <a href="https://mystiz.hk/tags/google-ctf/" class="text-muted text-decoration-none">#google-ctf</a>
          </span>
        
          <span class="badge rounded-pill bg-secondary">
            <a href="https://mystiz.hk/tags/challenge-writing/" class="text-muted text-decoration-none">#challenge-writing</a>
          </span>
        
      </div>
      

      <div class="post-content js-toc-content"><div>
          <p>IDEA is a challenge written by <a href="https://twitter.com/0xdeuterium" target="_blank" rel="nofollow">@0xdeuterium</a>. He even provided me the paper to refer, my only contribution to the challenge is to optimize the original solution so that we don't need 65K-ish oracle calls.</p>
<h2 id="challenge-summary">Challenge Summary<a href="#challenge-summary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<blockquote>
<p>We have a new idea about a cipher which we think may provide pretty good privacy.
So bruce for impact as we may patent our new proposed encryption standard.</p>
<p><code>nc idea.2024.ctfcompetition.com 1337</code></p>
<p>Attachments: <a href="https://github.com/google/google-ctf/tree/main/2024/quals/crypto-idea/attachments"
   
   target="_blank" rel="noopener noreferrer" >idea.zip</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg></p>
</blockquote>
<p>In this challenge, we are asked to break the IDEA cipher with three rounds. We are given 2024 credits, and there are two operations provided by the server:</p>
<ol>
<li>Encrypt a given message under the current key (uses 1 credit).</li>
<li>Flip a bit, specified by the players, of the key (uses 100 credits).</li>
</ol>
<p>The objective is to recover the original key without using up the credits.</p>
<h2 id="solution">Solution<a href="#solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="background">Background<a href="#background" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="alert success">
  ðŸ’° <strong>The solution is money-saving!</strong> My solution does not require multithreading and could complete within the time limit. We will simply reconnect to the server if there are a lot of possible solutions (in particular after step 3) and hope that there are less false positives with another key.
</div>

<p>Section 4.2 of J. Kelsey, B. Schneier, D. Wagner's paper<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> has a brief solution on how to recover the key. Our solution intends to optimize the algorithm by reducing the number of ciphertexts required, as well as the running time by using multiple strategies like meet-in-the-middle.</p>
<p>The below figure shows one round of the IDEA cipher. In our reduced-round scenario, we have $(m_1, m_2, m_3, m_4) = (s_{0, 11}, s_{0, 13}, s_{0, 12}, s_{0, 14})$ and $(c_1, c_2, c_3, c_4) = (s_{4, 1}, s_{4, 2}, s_{4, 3}, s_{4, 4})$ being respectively the plaintext and the ciphertext. Note that for the last round, we have $s_{3, 12} \boxplus k_{4, 2} = c_2$ and $s_{3, 13} \boxplus k_{4, 3} = c_3$ instead of $s_{3, 13} \boxplus k_{4, 2} = c_2$ and $s_{3, 12} \boxplus k_{4, 3} = c_3$.</p>


<figure>
  <img src="/images/2024-06-24-google-ctf/idea-one-round.png" title="One round of the IDEA cipher.">
  
  <figcaption>One round of the IDEA cipher.</figcaption>
  
</figure>



<figure>
  <img src="/images/2024-06-24-google-ctf/idea-last-round.png" title="The last round of the IDEA cipher. The edges $s_{3, 12}$ and $s_{3, 13}$ are not crossed.">
  
  <figcaption>The last round of the IDEA cipher. The edges $s_{3, 12}$ and $s_{3, 13}$ are not crossed.</figcaption>
  
</figure>

<p>In this writeup, we denote $c^* := \mathcal{E}(K^*, m)$ be the ciphertext of $m$ encrypted with key $K^*$, and $s^*_{i,j}$ as its intermediate values.</p>
<h3 id="the-key-schedule">The key schedule<a href="#the-key-schedule" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>IDEA uses a 128-bit key (namely $K$) and its subkeys use a contiguous bit segment. The below table shows the bits used for the subkey $k_{i,j}$. As an example, $k_{1, 1}$ uses bit 127 up to 112, inclusive, which is the top 16 bits of $K$; $k_{4, 3}$ uses the lowest 14 bits of $K$ followed by its top two bits.</p>
<table class="table table-striped table-bordered">
  <thead>
    
    <tr>
      
      <th>
        $i$ \ $j$
      </th>
      
      <th>
        1
      </th>
      
      <th>
        2
      </th>
      
      <th>
        3
      </th>
      
      <th>
        4
      </th>
      
      <th>
        5
      </th>
      
      <th>
        6
      </th>
      
    </tr>
    
  </thead>
  <tbody>
    
    <tr>
      
      <td>
        <strong>1</strong>
      </td>
      
      <td>
        127...112
      </td>
      
      <td>
        111...96
      </td>
      
      <td>
        95...80
      </td>
      
      <td>
        79...64
      </td>
      
      <td>
        63...48
      </td>
      
      <td>
        47...32
      </td>
      
    </tr>
    
    <tr>
      
      <td>
        <strong>2</strong>
      </td>
      
      <td>
        31...16
      </td>
      
      <td>
        15...0
      </td>
      
      <td>
        102...87
      </td>
      
      <td>
        86...71
      </td>
      
      <td>
        70...55
      </td>
      
      <td>
        54...39
      </td>
      
    </tr>
    
    <tr>
      
      <td>
        <strong>3</strong>
      </td>
      
      <td>
        38...23
      </td>
      
      <td>
        22...7
      </td>
      
      <td>
        6...119
      </td>
      
      <td>
        118...103
      </td>
      
      <td>
        77...62
      </td>
      
      <td>
        61...46
      </td>
      
    </tr>
    
    <tr>
      
      <td>
        <strong>4</strong>
      </td>
      
      <td>
        45...30
      </td>
      
      <td>
        29...14
      </td>
      
      <td>
        13...126
      </td>
      
      <td>
        125...110
      </td>
      
      <td>
        
      </td>
      
      <td>
        
      </td>
      
    </tr>
    
  </tbody>
</table>
<p>We can view the usage of $K$'s bits. For instance, the most significant bit (bit 127) of $K$ will be used by three subkeys: $k_{1, 1}$, $k_{3, 3}$ and $k_{4, 3}$, bit 109 is only used twice, however, by $k_{1, 2}$ and $k_{3, 4}$.</p>
<h3 id="step-1-recovering-k_4-1-and-k_4-3-with-a-bit-flip-and-4-calls">Step 1: Recovering $k_{4, 1}$ and $k_{4, 3}$ with a bit flip and 4 calls<a href="#step-1-recovering-k_4-1-and-k_4-3-with-a-bit-flip-and-4-calls" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>To recover $k_{4, 1}$ and $k_{4, 3}$, we can compute:</p>
<p>$$
\begin{aligned}
&amp; c^{(\text{A}, 1)} := \mathcal{E}(K, (0, 0, 0, 0)), \qquad c^{(\text{B}, 1)} := \mathcal{E}(K', (0, 2^{15}, 0, 0)) \\
&amp; c^{(\text{A}, 2)} := \mathcal{E}(K, (0, 0, 0, 1)), \qquad c^{(\text{B}, 2)} := \mathcal{E}(K', (0, 2^{15}, 0, 1)),
\end{aligned}
$$</p>
<p>where $K' = K \oplus 2^{111}$. As an example, $c^{(\text{A}, 1)}$ is the ciphertext when we encrypt $(0, 0, 0, 0)$ using the default key.</p>
<p>By flipping bit 111 of the key, only three subkeys would be changed: $k_{1, 2}$, $k_{3, 4}$ and $k_{4, 4}$. In particular, $k'_{1, 2} = k_{1, 2} \oplus 2^{15}$. If we compare the intermediate state for $c^{(\text{A}, i)}$ and $c^{(\text{B}, i)}$, only the values in orange are different:</p>


<figure>
  <img src="/images/2024-06-24-google-ctf/idea-step-1.png" title="The values that differ when comparing $c^{(\text{A}, i)}$ and $c^{(\text{B}, i)}$ are colored orange.">
  
  <figcaption>The values that differ when comparing $c^{(\text{A}, i)}$ and $c^{(\text{B}, i)}$ are colored orange.</figcaption>
  
</figure>

<p>The values that are in black are the same between the two encryptions. For instance, $s^{(\text{A}, i)}_{3, 1} = s^{(\text{B}, i)}_{3, 1}$ and $s^{(\text{A}, i)}_{3, 5} = s^{(\text{B}, i)}_{3, 5}$. In particular, since $s^{(\text{A}, i)}_{3, 5} = s^{(\text{B}, i)}_{3, 5}$, we have</p>
<p>$$
\begin{aligned}
&amp; (c^{(\text{A}, i)}_1 \odot k_{4,1}^{-1}) \oplus (c^{(\text{A}, i)}_3 \boxminus k_{4,3}) \\
&amp;\quad = s^{(\text{A}, i)}_{3,11} \oplus s^{(\text{A}, i)}_{3,13} \\
&amp;\quad = (s^{(\text{A}, i)}_{3, 1} \oplus s^{(\text{A}, i)}_{3, 10}) \oplus (s^{(\text{A}, i)}_{3, 10} \oplus s^{(\text{A}, i)}_{3, 3}) \\
&amp;\quad = s^{(\text{A}, i)}_{3, 1} \oplus s^{(\text{A}, i)}_{3, 3} = s^{(\text{A}, i)}_{3, 5} = s^{(\text{B}, i)}_{3, 5} = \dots \\
&amp;\quad = (c^{(\text{B}, i)}_1 \odot k_{4,1}^{-1}) \oplus (c^{(\text{B}, i)}_3 \boxminus k_{4,3}).
\end{aligned}
$$</p>
<p>Therefore we can exhaust $(k_{4,1}, k_{4,3})$ and check if both of the below equalities hold:</p>
<p>$$
\begin{aligned}
&amp; (c^{(\text{A}, 1)}_1 \odot k_{4,1}^{-1}) \oplus (c^{(\text{B}, 1)}_1 \odot k_{4,1}^{-1}) = (c^{(\text{A}, 1)}_3 \boxminus k_{4,3}) \oplus (c^{(\text{B}, 1)}_3 \boxminus k_{4,3}), \\
&amp; (c^{(\text{A}, 2)}_1 \odot k_{4,1}^{-1}) \oplus (c^{(\text{B}, 2)}_1 \odot k_{4,1}^{-1}) = (c^{(\text{A}, 2)}_3 \boxminus k_{4,3}) \oplus (c^{(\text{B}, 2)}_3 \boxminus k_{4,3})
\end{aligned}
$$</p>
<p>We can optimize the process with the meet-in-the-middle approach by exhausting the both sides using $k_{4,1}$ and $k_{4,3}$ independently. In this way, we can reduce the time complexity from $\mathcal{O}(2^{32})$ to $\mathcal{O}(2^{16})$:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step1</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="n">candidate_key_list</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_candidate_key_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c1_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c1_3</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c1</span> <span class="c1"># Enc(k,          (0x0000, 0x0000, 0x0000, 0x0000))</span>
</span></span><span class="line"><span class="cl">    <span class="n">c2_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c2_3</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c2</span> <span class="c1"># Enc(k ^ 2**111, (0x0000, 0x0000, 0x0000, 0x0000))</span>
</span></span><span class="line"><span class="cl">    <span class="n">c3_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c3_3</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c3</span> <span class="c1"># Enc(k,          (0x0000, 0x0000, 0x0000, 0x0001))</span>
</span></span><span class="line"><span class="cl">    <span class="n">c4_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c4_3</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c4</span> <span class="c1"># Enc(k ^ 2**111, (0x0000, 0x0000, 0x0000, 0x0001))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">candidate_key_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">middletext_to_k41_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k41</span> <span class="ow">in</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkeys</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c1_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c2_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s3_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c3_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s4_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c4_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">middletext</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1_3_11</span><span class="o">^</span><span class="n">s2_3_11</span><span class="p">,</span> <span class="n">s3_3_11</span><span class="o">^</span><span class="n">s4_3_11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">middletext_to_k41_map</span><span class="p">[</span><span class="n">middletext</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k43</span> <span class="ow">in</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkeys</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c1_3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c2_3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s3_3_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c3_3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s4_3_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c4_3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">middletext</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1_3_13</span><span class="o">^</span><span class="n">s2_3_13</span><span class="p">,</span> <span class="n">s3_3_13</span><span class="o">^</span><span class="n">s4_3_13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">k41</span> <span class="ow">in</span> <span class="n">middletext_to_k41_map</span><span class="p">[</span><span class="n">middletext</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_pk</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_pk</span><span class="o">.</span><span class="n">set_subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_pk</span><span class="o">.</span><span class="n">set_subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_candidate_key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_candidate_key_list</span>
</span></span></code></pre></div><div class="alert success">
  ðŸ“Š <strong>Status:</strong> 32/128 key bits recovered; 1 key bit flipped and 4 ciphertexts computed.
</div>

<h3 id="step-2-recovering-k_1-1-with-2-bit-flips-and-512-calls">Step 2: Recovering $k_{1, 1}$ with 2 bit flips and 512 calls<a href="#step-2-recovering-k_1-1-with-2-bit-flips-and-512-calls" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Now we want to recover $k_{1, 1}$. To do so, we let $K'' = K \oplus 2^{112}$. Now only $k_{1,1}$, $k_{3,4}$ and $k_{4,4}$ differ and $k''_{1,1} = k_{1,1} \oplus 1$.</p>
<p>Let $c^{(\text{D})}$ and $c^{(\text{E})}$ be ciphertexts encrypted with key $K$ and $K''$, respectively. This time we want to make $s^{(\text{D})}_{1,1} = s^{(\text{E})}_{1,1}$, i.e., $m^{(\text{D})}_1 \odot k_{1,1} = s^{(\text{D})}_{1,1} = s^{(\text{E})}_{1,1} = m^{(\text{E})}_1 \odot (k_{1,1} \oplus 1)$. We do not have a deterministic way to set $m^{(\text{D})}_1$ and $m^{(\text{E})}_1$ because $k_{1,1}$ is unknown. However, we can obtain</p>
<p>$$
c^{(\text{D},i)} := \mathcal{E}(K, (m^{(\text{D})}_{i,1}, 0, 0, 0)) \quad \text{and} \quad c^{(\text{E},j)} := \mathcal{E}(K'', (m^{(\text{E})}_{j,1}, 0, 0, 0)),
$$</p>
<p>and check if there exists $i, j$ such that $s_{3,5}^{(\text{D},i)} = s_{3,5}^{(\text{E},j)}$. If that's the case, we have $[\dagger]$:</p>
<p>$$
m^{(\text{D})}_{i,1} \odot k_{1,1} = m^{(\text{E})}_{j,1} \odot k''_{1,1} = m^{(\text{E})}_{j,1} \odot (k_{1,1} \oplus 1).
$$</p>
<p>We then can effectively recover $k_{1,1}$ since we have $m^{(\text{D})}_{i,1}$ and $m^{(\text{E})}_{j,1}$. However, one question remain: How do we pick $m^{(\text{D})}_i$ and $m^{(\text{E})}_j$? The original paper<sup id="fnref1:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> suggests us to pick $m^{(\text{D})}_{1,1} = 0$ and $m^{(\text{E})}_{j,1} = j$ for $j = 0, 1, ..., 2^{16}-1$, but this requires 65537 oracle calls and we do not have enough credits for that.</p>
<p>Our approach required 512 calls given by $m^{(\text{D})}_i = (5^{-i}, 0, 0, 0)$ for $i = 0, 1, ..., 256$ and $m^{(\text{E})}_j = (5^{257j}, 0, 0, 0)$ for $j = 0, 1, ..., 254$. Here $a^b$ is given by</p>
<p>$$
a^b = \underbrace{a \odot a \odot \dots \odot a}_{b \ a'\text{s}}.
$$</p>
<p>We can substitute the above and rearrange $[\dagger]$ to obtain the below equality:</p>
<p>$$
k_{1,1} \odot (k_{1,1} \oplus 1)^{-1} = 5^{257j + i}.
$$</p>
<p>Since $5$ is a primitive root modulo $65537$ and we have $1, 5, 5^2, ..., 5^{65534}$ on the right hand side, we are guaranteed that we can find $k_{1,1}$ this way.</p>
<p>Additionally, considering that the two high bits of $k_{1, 1}$ are the two low bits of $k_{4, 3}$, we can filter out some of the keys using the condition <code>(k11&gt;&gt;14) &amp; 0x3 == k43 &amp; 0x3</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step2</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="n">candidate_key_list</span><span class="p">,</span> <span class="n">c5_list</span><span class="p">,</span> <span class="n">c6_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_candidate_key_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">m5_1_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">pow</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="mi">65537</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">257</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">m6_1_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">pow</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">257</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mi">65537</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">255</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># solns[x] are the solutions of k such that k / (k^1) = x.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># this could solve k * x1 == (k^1) * x2, where x = x2/x1</span>
</span></span><span class="line"><span class="cl">    <span class="n">solns</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">65536</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">65536</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">solns</span><span class="p">[</span><span class="n">div</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="o">^</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">candidate_key_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">middletext_to_m5_1_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">middletext_to_m6_1_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k41</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k43</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">m5_1</span><span class="p">,</span> <span class="n">c5</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m5_1_list</span><span class="p">,</span> <span class="n">c5_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">c5_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c5_3</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c5</span> <span class="c1"># Enc(k, (m5_1, 0x0000, 0x0000, 0x0000))</span>
</span></span><span class="line"><span class="cl">            <span class="n">s5_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c5_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s5_3_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c5_3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">middletext</span> <span class="o">=</span> <span class="n">s5_3_11</span> <span class="o">^</span> <span class="n">s5_3_13</span>
</span></span><span class="line"><span class="cl">            <span class="n">middletext_to_m5_1_map</span><span class="p">[</span><span class="n">middletext</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m5_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">m6_1</span><span class="p">,</span> <span class="n">c6</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">m6_1_list</span><span class="p">,</span> <span class="n">c6_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">c6_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c6_3</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c6</span> <span class="c1"># Enc(k, (m6_1, 0x0000, 0x0000, 0x0000))</span>
</span></span><span class="line"><span class="cl">            <span class="n">s6_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c6_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s6_3_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c6_3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">middletext</span> <span class="o">=</span> <span class="n">s6_3_11</span> <span class="o">^</span> <span class="n">s6_3_13</span>
</span></span><span class="line"><span class="cl">            <span class="n">middletext_to_m6_1_map</span><span class="p">[</span><span class="n">middletext</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m6_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">middletext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">m5_1</span><span class="p">,</span> <span class="n">m6_1</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">middletext_to_m5_1_map</span><span class="p">[</span><span class="n">middletext</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                                <span class="n">middletext_to_m6_1_map</span><span class="p">[</span><span class="n">middletext</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">k11</span> <span class="ow">in</span> <span class="n">solns</span><span class="p">[</span><span class="n">div</span><span class="p">(</span><span class="n">m6_1</span><span class="p">,</span> <span class="n">m5_1</span><span class="p">)]:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_pk</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_pk</span><span class="o">.</span><span class="n">set_subkey</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k11</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_candidate_key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_candidate_key_list</span>
</span></span></code></pre></div><div class="alert success">
  ðŸ“Š <strong>Status:</strong> 46/128 key bits recovered; 3 key bits flipped and 516 ciphertexts computed.
</div>

<h3 id="step-3-recovering-k_4-2-and-k_4-4-with-2-bit-flips-and-2-calls">Step 3: Recovering $k_{4, 2}$ and $k_{4, 4}$ with 2 bit flips and 2* calls<a href="#step-3-recovering-k_4-2-and-k_4-4-with-2-bit-flips-and-2-calls" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="alert warning">
  ðŸ§© <strong>What 2* oracle calls?</strong> The number of oracle calls is twice the number of possible $k_{1, 1}$'s we have after step 2. $k_{1, 1}$ is usually unique, but it is probable that there are ten possible $k_{1, 1}$'s.
</div>

<p>Let $K''' = K \oplus 2^{127}$ this time. This time $k_{1, 1}$, $k_{3, 3}$ and $k_{4, 3}$ will be changed, and in particular $k'''_{1, 1} = k_{1, 1} \oplus 2^{15}$. We encrypt two messages with the flipped key:</p>
<p>$$
\qquad c^{(\text{C}, 1)} := \mathcal{E}(K''', (m^{(\text{C})}_1, 0, 0, 0)) \quad \text{and} \quad c^{(\text{C}, 2)} := \mathcal{E}(K''', (m^{(\text{C})}_1, 0, 0, 1)).
$$</p>
<p>Here $m^{(\text{C}, i)}$ is given by $0 \odot k_{1, 1} \odot (k_{1, 1} \oplus 2^{15})^{-1}$, as we then could have</p>
<p>$$
\begin{aligned}
&amp; s^{(\text{A}, i)}_{1, 1} = m^{(\text{A}, i)}_1 \odot k_{1, 1} = 0 \odot k_{1, 1} \\
&amp; \quad = \left[0 \odot k_{1, 1} \odot (k_{1, 1} \oplus 2^{15})^{-1}\right] \odot (k_{1, 1} \oplus 2^{15}) \\
&amp; \quad = m^{(\text{C}, i)}_1 \odot (k_{1, 1} \oplus 2^{15}) = s^{(\text{C}, i)}_{1, 1}.
\end{aligned}
$$</p>
<p>Thus only the orange edges in the below figure will be changed.</p>


<figure>
  <img src="/images/2024-06-24-google-ctf/idea-step-3.png" title="">
  
</figure>

<p>Since $s^{(\text{A}, i)}_{3,6} = s^{(\text{C}, i)}_{3, 6}$, we have</p>
<p>$$
\begin{aligned}
&amp; (c^{(\text{A}, i)}_2 \boxminus k_{4,2}) \oplus (c^{(\text{A}, i)}_4 \odot k_{4,4}^{-1}) \\
&amp; \quad = s^{(\text{A}, i)}_{3, 12} \oplus s^{(\text{A}, i)}_{3, 14} = s^{(\text{A}, i)}_{3, 6} = s^{(\text{C}, i)}_{3, 6} = \dots \\
&amp; \quad = (c^{(\text{C}, i)}_2 \boxminus k_{4,2}) \oplus (c^{(\text{C}, i)}_4 \odot k_{4,4}^{-1}).
\end{aligned}
$$</p>
<p>Hence we can obtain a set of possible $(k_{4, 2}, k_{4, 4})$ using MITM, as what we did in step 1.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step3</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="n">candidate_key_list</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_candidate_key_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k11_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">candidate_key_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">rem</span><span class="o">.</span><span class="n">switch_key</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">112</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">127</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">k11_to_c7_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">k11_to_c8_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k11</span> <span class="ow">in</span> <span class="n">k11_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">m7_1</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">mul</span><span class="p">(</span><span class="n">k11</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">k11</span> <span class="o">^</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">15</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k11_to_c7_map</span><span class="p">[</span><span class="n">k11</span><span class="p">]</span> <span class="o">=</span> <span class="n">rem</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="n">m7_1</span><span class="o">&lt;&lt;</span><span class="mi">48</span><span class="p">)</span>     <span class="c1"># Enc(k, (m71, 0x0000, 0x0000, 0x0000))</span>
</span></span><span class="line"><span class="cl">        <span class="n">k11_to_c8_map</span><span class="p">[</span><span class="n">k11</span><span class="p">]</span> <span class="o">=</span> <span class="n">rem</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="n">m7_1</span><span class="o">&lt;&lt;</span><span class="mi">48</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># Enc(k, (m71, 0x0000, 0x0000, 0x0001))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">candidate_key_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">k11</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k42_list</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkeys</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k44_list</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkeys</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">        <span class="n">c7</span><span class="p">,</span> <span class="n">c8</span> <span class="o">=</span> <span class="n">k11_to_c7_map</span><span class="p">[</span><span class="n">k11</span><span class="p">],</span> <span class="n">k11_to_c8_map</span><span class="p">[</span><span class="n">k11</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">_</span><span class="p">,</span> <span class="n">c1_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c1_4</span> <span class="o">=</span> <span class="n">c1</span>
</span></span><span class="line"><span class="cl">        <span class="n">_</span><span class="p">,</span> <span class="n">c3_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c3_4</span> <span class="o">=</span> <span class="n">c3</span>
</span></span><span class="line"><span class="cl">        <span class="n">_</span><span class="p">,</span> <span class="n">c7_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c7_4</span> <span class="o">=</span> <span class="n">c7</span>
</span></span><span class="line"><span class="cl">        <span class="n">_</span><span class="p">,</span> <span class="n">c8_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c8_4</span> <span class="o">=</span> <span class="n">c8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">middletext_to_k42_map</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k42</span> <span class="ow">in</span> <span class="n">k42_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c1_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s3_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c3_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s7_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c7_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s8_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c8_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">middletext</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1_3_12</span><span class="o">^</span><span class="n">s7_3_12</span><span class="p">,</span> <span class="n">s3_3_12</span><span class="o">^</span><span class="n">s8_3_12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">middletext_to_k42_map</span><span class="p">[</span><span class="n">middletext</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k44</span> <span class="ow">in</span> <span class="n">k44_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c1_4</span><span class="p">,</span> <span class="n">k44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s3_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c3_4</span><span class="p">,</span> <span class="n">k44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s7_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c7_4</span><span class="p">,</span> <span class="n">k44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s8_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c8_4</span><span class="p">,</span> <span class="n">k44</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">middletext</span> <span class="o">=</span> <span class="p">(</span><span class="n">s1_3_14</span><span class="o">^</span><span class="n">s7_3_14</span><span class="p">,</span> <span class="n">s3_3_14</span><span class="o">^</span><span class="n">s8_3_14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">k42</span> <span class="ow">in</span> <span class="n">middletext_to_k42_map</span><span class="p">[</span><span class="n">middletext</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_pk</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">new_pk</span><span class="o">.</span><span class="n">set_subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">k42</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">new_pk</span><span class="o">.</span><span class="n">set_subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">k44</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_candidate_key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_candidate_key_list</span>
</span></span></code></pre></div><div class="alert success">
  ðŸ“Š <strong>Status:</strong> 64/128 key bits recovered; 6 key bits flipped and 518 ciphertexts computed.
</div>

<h3 id="step-4-recovering-k_3-5-and-k_3-6">Step 4: Recovering $k_{3, 5}$ and $k_{3, 6}$<a href="#step-4-recovering-k_3-5-and-k_3-6" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="alert info">
  ðŸ“š <strong>Note.</strong> From this step onwards, we will make use of the previous calls. No additional encryptions will be needed.
</div>

<p>In this step, we will make use of $c^{(\text{A}, 1)}, c^{(\text{B}, 1)}, c^{(\text{A}, 2)}$ and $c^{(\text{B}, 2)}$ again.</p>
<p>Knowing $k_{4, 1}, k_{4, 2}, k_{4, 3}$ and $k_{4, 4}$, we can retrieve $s_{3, 5}$ and $s_{3, 6}$ by</p>
<p>$$
\begin{aligned}
&amp; s_{3, 5} = s_{3, 11} \oplus s_{3, 13} = (c_1 \odot k_{4, 1}^{-1}) \oplus (c_3 \boxminus k_{4, 3}) \\
&amp; s_{3, 6} = s_{3, 12} \oplus s_{3, 14} = (c_2 \boxminus k_{4, 2}) \oplus (c_4 \odot k_{4, 4}^{-1})
\end{aligned}
$$</p>
<p>We also know that $s^{(\text{A}, i)}_{3, 1} = s^{(\text{B}, i)}_{3, 1}$ for $i = 1, 2$. We can unveil $s_{3, 1}$ if we have $k_{3, 5}$ and $k_{3, 6}$:</p>
<p>$$
\begin{aligned}
&amp; s_{3, 7} = s_{3, 5} \odot k_{3, 5} \\
&amp; s_{3, 8} = s_{3, 6} \boxplus s_{3, 7} \\
&amp; s_{3, 10} = s_{3, 8} \odot k_{3, 6} \\
&amp; s_{3, 1} = s_{3, 10} \oplus s_{3, 11}
\end{aligned}
$$</p>
<p>We will only accept those $(k_{3, 5}, k_{3, 6})$s such that</p>
<p>$$
s^{(\text{A}, 1)}_{3, 1} = s^{(\text{B}, 1)}_{3, 1} \quad \text{and} \quad
s^{(\text{A}, 2)}_{3, 1} = s^{(\text{B}, 2)}_{3, 1}.
$$</p>
<p>The above computation required $\mathcal{O}(2^{32})$ and can be optimized. Instead of exhausting $(k_{3, 5}, k_{3, 6})$, we can search for $(s^{(\text{A}, 1)}_{3, 7}, s^{(\text{A}, 1)}_{3, 10})$ instead. Please read the <code>step4_subsolve</code> method below for more details.</p>
<div class="alert warning">
  ðŸ <strong>Spaghetti code ahead!</strong> I should implement some class methods to retrieve the target intermediate values with breadth-first search or so, instead of computing the values one by one...
</div>

<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Return a list of (x, y)&#39;s such that (x + y) ^ [x + (y ^ a)] = b</span>
</span></span><span class="line"><span class="cl"><span class="nd">@cache</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step4_subsolve</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">solns</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Here we use the substitution u = (x + y) ^ b, and</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># perform MITM with (b ^ u) - u = y - (y ^ a).</span>
</span></span><span class="line"><span class="cl">    <span class="n">lhs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">lhs</span><span class="p">[</span><span class="n">sub</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">u</span><span class="p">),</span> <span class="n">u</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">rhs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">rhs</span><span class="p">[</span><span class="n">sub</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xor</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">))]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">lhs</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">rhs</span><span class="p">[</span><span class="n">v</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">x</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">xor</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">u</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">solns</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">solns</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step4</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="n">candidate_key_list</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_candidate_key_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c1_1</span><span class="p">,</span> <span class="n">c1_2</span><span class="p">,</span> <span class="n">c1_3</span><span class="p">,</span> <span class="n">c1_4</span> <span class="o">=</span> <span class="n">c1</span>
</span></span><span class="line"><span class="cl">    <span class="n">c2_1</span><span class="p">,</span> <span class="n">c2_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span>    <span class="n">c2_4</span> <span class="o">=</span> <span class="n">c2</span>
</span></span><span class="line"><span class="cl">    <span class="n">c3_1</span><span class="p">,</span> <span class="n">c3_2</span><span class="p">,</span> <span class="n">c3_3</span><span class="p">,</span> <span class="n">c3_4</span> <span class="o">=</span> <span class="n">c3</span>
</span></span><span class="line"><span class="cl">    <span class="n">c4_1</span><span class="p">,</span> <span class="n">c4_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span>    <span class="n">c4_4</span> <span class="o">=</span> <span class="n">c4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">track</span><span class="p">(</span><span class="n">candidate_key_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">k41</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k42</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k43</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k44</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c1_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c2_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s3_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c3_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s4_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c4_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c1_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c2_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s3_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c3_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s4_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c4_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c1_3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s3_3_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c3_3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c1_4</span><span class="p">,</span> <span class="n">k44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c2_4</span><span class="p">,</span> <span class="n">k44</span> <span class="o">^</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">s3_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c3_4</span><span class="p">,</span> <span class="n">k44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s4_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c4_4</span><span class="p">,</span> <span class="n">k44</span> <span class="o">^</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_5</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s1_3_11</span><span class="p">,</span> <span class="n">s1_3_13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s3_3_5</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s3_3_11</span><span class="p">,</span> <span class="n">s3_3_13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_6</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s1_3_12</span><span class="p">,</span> <span class="n">s1_3_14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2_3_6</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s2_3_12</span><span class="p">,</span> <span class="n">s2_3_14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s3_3_6</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s3_3_12</span><span class="p">,</span> <span class="n">s3_3_14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s4_3_6</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s4_3_12</span><span class="p">,</span> <span class="n">s4_3_14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k35_and_k36_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_7_and_s1_3_10_list</span> <span class="o">=</span> <span class="n">step4_subsolve</span><span class="p">(</span><span class="n">s1_3_11</span><span class="o">^</span><span class="n">s2_3_11</span><span class="p">,</span> <span class="n">s1_3_12</span><span class="o">^</span><span class="n">s2_3_12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">s1_3_7</span><span class="p">,</span> <span class="n">s1_3_10</span> <span class="ow">in</span> <span class="n">s1_3_7_and_s1_3_10_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_8</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">s1_3_6</span><span class="p">,</span> <span class="n">s1_3_7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">k35</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">s1_3_7</span><span class="p">,</span> <span class="n">s1_3_5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">k36</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">s1_3_10</span><span class="p">,</span> <span class="n">s1_3_8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">k35_and_k36_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k35</span><span class="p">,</span> <span class="n">k36</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k35</span><span class="p">,</span> <span class="n">k36</span> <span class="ow">in</span> <span class="n">k35_and_k36_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Check against the first pair</span>
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_7</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s1_3_5</span><span class="p">,</span> <span class="n">k35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_7</span> <span class="o">=</span> <span class="n">s1_3_7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_8</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">s1_3_6</span><span class="p">,</span> <span class="n">s1_3_7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_8</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">s2_3_6</span><span class="p">,</span> <span class="n">s2_3_7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_10</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s1_3_8</span><span class="p">,</span> <span class="n">k36</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_10</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s2_3_8</span><span class="p">,</span> <span class="n">k36</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_1</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s1_3_10</span><span class="p">,</span> <span class="n">s1_3_11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_1</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s2_3_10</span><span class="p">,</span> <span class="n">s2_3_11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">s1_3_1</span> <span class="o">!=</span> <span class="n">s2_3_1</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># Check against the second pair</span>
</span></span><span class="line"><span class="cl">            <span class="n">s3_3_7</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s3_3_5</span><span class="p">,</span> <span class="n">k35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s4_3_7</span> <span class="o">=</span> <span class="n">s3_3_7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s3_3_8</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">s3_3_6</span><span class="p">,</span> <span class="n">s3_3_7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s4_3_8</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">s4_3_6</span><span class="p">,</span> <span class="n">s4_3_7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s3_3_10</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s3_3_8</span><span class="p">,</span> <span class="n">k36</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s4_3_10</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s4_3_8</span><span class="p">,</span> <span class="n">k36</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s3_3_1</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s3_3_10</span><span class="p">,</span> <span class="n">s3_3_11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s4_3_1</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s4_3_10</span><span class="p">,</span> <span class="n">s4_3_11</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">s3_3_1</span> <span class="o">!=</span> <span class="n">s4_3_1</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">new_pk</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_pk</span><span class="o">.</span><span class="n">set_subkey</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">k35</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_pk</span><span class="o">.</span><span class="n">set_subkey</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">k36</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_candidate_key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_candidate_key_list</span>
</span></span></code></pre></div><div class="alert success">
  ðŸ“Š <strong>Status:</strong> 96/128 key bits recovered.
</div>

<h3 id="step-5-recovering-k_3-4">Step 5: Recovering $k_{3, 4}$<a href="#step-5-recovering-k_3-4" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Now we have fully recovered $k_{3, 5}, k_{3, 6}, k_{4, 1}, k_{4, 2}, k_{4, 3}$ and $k_{4, 4}$, we are able to further reduce the number of rounds from 3 to 2. With that said, we are able to retrieve $s_{3, 1}, s_{3, 2}, s_{3, 3}$ and $s_{3, 4}$ given a ciphertext.</p>
<p>To recover $k_{3, 4}$, we will at $c^{(\text{A}, 1)}$ and $c^{(\text{B}, 1)}$ again. We know what $s^{(\text{A}, 1)}_{3, 4}$ and $s^{(\text{B}, 1)}_{3, 4}$ are, as well as $s^{(\text{A}, 1)}_{2, 14} = s^{(\text{B}, 1)}_{2, 14}$. Therefore, we can exhaust $k_{3, 4}$ and look for the cases when the equality holds.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step5</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="n">candidate_key_list</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_candidate_key_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c1_1</span><span class="p">,</span> <span class="n">c1_2</span><span class="p">,</span> <span class="n">c1_3</span><span class="p">,</span> <span class="n">c1_4</span> <span class="o">=</span> <span class="n">c1</span>
</span></span><span class="line"><span class="cl">    <span class="n">_</span><span class="p">,</span>    <span class="n">c2_2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span>    <span class="n">c2_4</span> <span class="o">=</span> <span class="n">c2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">candidate_key_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">k35</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k36</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k41</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k42</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k43</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k44</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c1_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c1_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c2_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c1_3</span><span class="p">,</span> <span class="n">k43</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c1_4</span><span class="p">,</span> <span class="n">k44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2_3_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c2_4</span><span class="p">,</span> <span class="n">k44</span> <span class="o">^</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_5</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s1_3_11</span><span class="p">,</span> <span class="n">s1_3_13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2_3_5</span> <span class="o">=</span> <span class="n">s1_3_5</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_6</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s1_3_12</span><span class="p">,</span> <span class="n">s1_3_14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s2_3_6</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s2_3_12</span><span class="p">,</span> <span class="n">s2_3_14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_7</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s1_3_5</span><span class="p">,</span> <span class="n">k35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">k34</span> <span class="ow">in</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkeys</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_7</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s1_3_5</span><span class="p">,</span> <span class="n">k35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_7</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s2_3_5</span><span class="p">,</span> <span class="n">k35</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_8</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">s1_3_6</span><span class="p">,</span> <span class="n">s1_3_7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_8</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">s2_3_6</span><span class="p">,</span> <span class="n">s2_3_7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_10</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s1_3_8</span><span class="p">,</span> <span class="n">k36</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_10</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">s2_3_8</span><span class="p">,</span> <span class="n">k36</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_9</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">s1_3_7</span><span class="p">,</span> <span class="n">s1_3_10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_9</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">s2_3_7</span><span class="p">,</span> <span class="n">s2_3_10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s1_3_4</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s1_3_9</span><span class="p">,</span> <span class="n">s1_3_14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_3_4</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s2_3_9</span><span class="p">,</span> <span class="n">s2_3_14</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">s1_2_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">s1_3_4</span><span class="p">,</span> <span class="n">k34</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">s2_2_14</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">s2_3_4</span><span class="p">,</span> <span class="n">k34</span> <span class="o">^</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">s1_2_14</span> <span class="o">!=</span> <span class="n">s2_2_14</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">new_pk</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_pk</span><span class="o">.</span><span class="n">set_subkey</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">k34</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_candidate_key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_candidate_key_list</span>
</span></span></code></pre></div><div class="alert success">
  ðŸ“Š <strong>Status:</strong> 103/128 key bits recovered.
</div>

<h3 id="step-6-recovering-k_1-3">Step 6: Recovering $k_{1, 3}$<a href="#step-6-recovering-k_1-3" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>We can use $c^{(\text{A}, 1)}$ to recover $k_{1, 3}$ this time. Up to now, only $k_{1, 2}, k_{1, 3}, k_{1, 4}, k_{2, 3}$ and $k_{2, 4}$ are unknown. Fortunately, we still can recover $s^{(\text{A}, 1)}_{1, 3}$ from its ciphertext. With that, we can obtain $k_{1, 3}$ with $k_{1, 3} = s^{(\text{A}, 1)}_{1, 3} \boxminus m^{(\text{A}, 1)}_3 = s^{(\text{A}, 1)}_{1, 3}$.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step6</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="n">candidate_key_list</span><span class="p">,</span> <span class="n">c1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_candidate_key_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">m1_1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span>    <span class="n">m1_3</span><span class="p">,</span> <span class="n">_</span>    <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span>
</span></span><span class="line"><span class="cl">    <span class="n">c1_1</span><span class="p">,</span> <span class="n">c1_2</span><span class="p">,</span> <span class="n">c1_3</span><span class="p">,</span> <span class="n">c1_4</span> <span class="o">=</span> <span class="n">c1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">candidate_key_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">k11</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k21</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># omitted for brevity...</span>
</span></span><span class="line"><span class="cl">        <span class="n">k43</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">k44</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">subkey</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_11</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">c1_1</span><span class="p">,</span> <span class="n">k41</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s1_3_12</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">c1_2</span><span class="p">,</span> <span class="n">k42</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># omitted for brevity...</span>
</span></span><span class="line"><span class="cl">        <span class="n">s1_1_13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">s1_2_2</span><span class="p">,</span> <span class="n">k22</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">s1_1_3</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">s1_1_10</span><span class="p">,</span> <span class="n">s1_1_13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">k13</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">s1_1_3</span><span class="p">,</span> <span class="n">m1_3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">new_pk</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_pk</span><span class="o">.</span><span class="n">set_subkey</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">k13</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_candidate_key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_candidate_key_list</span>
</span></span></code></pre></div><div class="alert success">
  ðŸ“Š <strong>Status:</strong> 119/128 key bits recovered.
</div>

<h3 id="step-7-recovering-the-entire-key">Step 7: Recovering the entire key!<a href="#step-7-recovering-the-entire-key" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>At this moment, only nine bits of $K$ are unknown. We can simply exhaust the possible keys and check if $(0, 0, 0, 0)$ encrypts to $c^{(\text{A}, 1)}$, as well as $(0, 0, 0, 1)$ encrypts to $c^{(\text{A}, 2)}$. It is very likely that the $K$ recovered is unique. With the key recovered, we can send that to retrieve our flag: <code>CTF{we_have_no_idea_on_related_key_attacks}</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">step7</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="n">candidate_key_list</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_candidate_key_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">m1</span> <span class="o">=</span> <span class="mh">0x0000_0000_0000_0000</span>
</span></span><span class="line"><span class="cl">    <span class="n">m3</span> <span class="o">=</span> <span class="mh">0x0000_0000_0000_0001</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">candidate_key_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pk</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cipher</span> <span class="o">=</span> <span class="n">IDEA</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">rounds</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">split_chunks</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span> <span class="o">!=</span> <span class="n">c1</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">split_chunks</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">m3</span><span class="p">))</span> <span class="o">!=</span> <span class="n">c3</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">new_pk</span> <span class="o">=</span> <span class="n">pk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_pk</span><span class="o">.</span><span class="n">set_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_candidate_key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_candidate_key_list</span>
</span></span></code></pre></div><div class="alert success">
  &#x1f389; <strong>Status:</strong> 128/128 key bits recovered.
</div>

<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>J. Kelsey, B. Schneier, D. Wagner (2016). &quot;Key-Schedule Cryptanalysis of IDEA, G-DES, GOST, SAFER, and Triple-DES&quot; <br><a href="https://www.schneier.com/wp-content/uploads/2016/02/paper-key-schedule.pdf"
   
   target="_blank" rel="noopener noreferrer" >https://www.schneier.com/wp-content/uploads/2016/02/paper-key-schedule.pdf</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

        </div></div>

      
      <aside class="toc-container">
        <a href="#" class="toc-title-link">
          Google CTF 2024 (III): IDEA
        </a>
        <div class="js-toc"></div>
      </aside>
      

      
      <div class="py-3">
        
          <a class="btn" href="/posts/2024/2024-07-20-hitcon-ctf/">â† HITCON CTF 2024 Writeup</a>
        

        
          <a class="btn float-end" href="/posts/2024/2024-06-24-google-ctf-2/">Google CTF 2024 (II): ZKPOK â†’</a>
        
      </div>
      

    </div>
  </div>

    </div>
  </main>
  <div class="container">
  <footer class="py-3 my-4 border-top">
    <p class="text-center text-body-secondary">&copy; 2026 Powered by <em>Hugo</em>. Theme crafted by <em>Mystiz</em> with Bootstrap 5, inspired from <em>Terminal</em>.</p>
  </footer>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css"
  integrity="sha384-Pu5+C18nP5dwykLJOhd2U4Xen7rjScHN/qusop27hdd2drI+lL5KvX7YntvT8yew" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js"
  integrity="sha384-2B8pfmZZ6JlVoScJm/5hQfNS2TI/6hPqDZInzzPc8oHpN5SgeNOf4LzREO6p5YtZ" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/contrib/auto-render.min.js"
  integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }], trust: true })"></script>

<script src="https://cdn.jsdelivr.net/npm/@viz-js/viz@3.24.0/dist/viz-global.min.js"></script>
<script>
Viz.instance().then(viz => {
  const unescape = function (s) {
    const t = s.replace(/&amp;/g, '&')
    return t.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&#34;/g, '"')
  }

  document.querySelectorAll('[class=graphviz]').forEach(node => {
    const source = unescape(node.innerText);
    console.log(source);
    const svg = viz.renderSVGElement(source, { engine: 'dot' });
    console.log(2);
    node.parentNode.appendChild(svg);
    node.style.display = 'none';
  });
});
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.js"
  integrity="sha512-BZUSsJAPNtkd+kdY/bD7hvQKZ5zlgWt++KGy/Pa/5uEJNgs0jZ6JaX6MuclRUanowuxmhb5S3LRPEa3QmrUVfA==" crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.css"
  integrity="sha512-/ANQiHMqpRl+E0zEAd250N21OOmJsYbhiJWY0Y8yG0TII47yZn1+gDNobMlf+h/FTyImprLXYgXbX3bCYyq/vg==" crossorigin="anonymous"
  referrerpolicy="no-referrer" />
<script type="text/javascript">
tocbot.init({
  headingSelector: 'h1, h2, h3, h4',
  orderedList: false,
  collapseDepth: 2,
  headingsOffset: 60,
  scrollSmoothOffset: -60
})
</script>


<script>
  document.querySelectorAll('pre code').forEach(el => {
    console.log(el)
    const lang = Array.from(el.classList).find(className => className.startsWith('language-'));
    if (!lang) return;

    
    if (lang.startsWith('language-diff-')) {
      el.classList.add('diff-highlight');
    }
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({
  startOnLoad: true,
  htmlLabels: true,
  securityLevel: "loose",
  theme: 'base',
  themeVariables: {
    background: '#22222c',
    primaryColor: '#33333c',
    primaryTextColor: '#ffe4e1',
  }
});
</script>

</body>
</html>
