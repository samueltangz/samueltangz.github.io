<!DOCTYPE html>
<html lang="en-us" dir="ltr" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TetCTF 2024: adapt | Mystify</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=Libre+Baskerville:ital,wght@0,400..700;1,400..700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css"
  integrity="sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA==" crossorigin="anonymous"
  referrerpolicy="no-referrer" />
<link rel="stylesheet" href="/css/main.min.e0d3493d996b65055f87a93e94627d58325b4f40eae7e97eed960541aab132ca.css" integrity="sha256-4NNJPZlrZQVfh6k&#43;lGJ9WDJbT0Dq5&#43;l&#43;7ZYFQaqxMso=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/prism.min.ebb6c0bd3fe6ed4e16ec09f3b52903ee18ddfb21e33b6882030d951a91b213e4.css" integrity="sha256-67bAvT/m7U4W7AnztSkD7hjd&#43;yHjO2iCAw2VGpGyE&#43;Q=" crossorigin="anonymous">

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.min.js"
  integrity="sha512-nKXmKvJyiGQy343jatQlzDprflyB5c+tKCzGP3Uq67v+lmzfnZUi/ZT+fc6ITZfSC5HhaBKUIvr/nTLCV+7F+Q==" crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
        <script src="/js/main.f2979a93a325fecf9605263bd141398a311c8e23388ed7dcff74f92f7e632866.js" integrity="sha256-8peak6Ml/s&#43;WBSY70UE5ijEcjiM4jtfc/3T5L35jKGY=" crossorigin="anonymous"></script>
        <script src="/js/prism.0ecb34b0181efd0f9aa6d1a8fc2e4814ffbdd9acc78d93d02a94e01f64f87f35.js" integrity="sha256-Dss0sBge/Q&#43;aptGo/C5IFP&#43;92azHjZPQKpTgH2T4fzU=" crossorigin="anonymous"></script>



</head>
<body class="overflow-y-scroll">
  <nav class="navbar navbar-expand-lg sticky-top bg-body-tertiary">
  <div class="container">
    <a class="navbar-brand" href="/">Mystify</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <div class="navbar-nav">
        
        
          <a class="nav-link " href="/about-me/">
            About Me 
          </a>
        
          <a class="nav-link " href="/blogroll/">
            Blogroll 
          </a>
        
          <a class="nav-link " href="/crypto-in-ctf/">
            Crypto in CTF 
          </a>
        
      </div>
    </div>
  </div>
</nav>

  <main>
    <div class="container mt-3">
      
  <div class="row justify-content-center">
    <div class="col-12 col-xl-8">
      <h1 class="post-title">TetCTF 2024: adapt</h1>

      
      <div class="text-muted pb-4">
        
          
          
          <time datetime="2024-02-03T16:25:00&#43;08:00">2024-02-03</time>
        
        
        <span class="px-1">::</span>
        
        
          <span class="badge rounded-pill bg-secondary">
            <a href="https://mystiz.hk/tags/ctf/" class="text-muted text-decoration-none">#ctf</a>
          </span>
        
          <span class="badge rounded-pill bg-secondary">
            <a href="https://mystiz.hk/tags/tetctf/" class="text-muted text-decoration-none">#tetctf</a>
          </span>
        
          <span class="badge rounded-pill bg-secondary">
            <a href="https://mystiz.hk/tags/crypto/" class="text-muted text-decoration-none">#crypto</a>
          </span>
        
      </div>
      

      <div class="post-content js-toc-content"><div>
          <p>TetCTF comes back with their great crypto challenges. I played with <a href="https://twitter.com/blackb6a" target="_blank" rel="nofollow">@blackb6a</a> and we ended up securing the ü•â third place. In this blog post, I will walk through <em>adapt</em>, a challenge which required us to make fake proofs in an IAVL tree implementation. There are only three solves during the contest period.</p>
<h2 id="challenge-summary">Challenge Summary<a href="#challenge-summary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We are started with an empty immutable AVL (IAVL) tree every connection. We can send up to 2024 messages and it will store the key-value pair <code>(message, &quot;&quot;)</code> to the tree. In this stage, we have to set the message to $m_0$ at least once. After that, we are asked to provide a proof that $m_0$ is not on the tree.</p>
<h2 id="solution">Solution<a href="#solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="part-i-background">Part I: Background<a href="#part-i-background" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p><code>cosmos/iavl@v0.19.2</code> is known to be vulnerable<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup><sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> for the Binance Bridge hack in October 2022, which has been fixed in v0.19.3. However, there is a issue in ‚â§v0.19.7 that allow us to create fake absence proofs.</p>
<h3 id="part-ii-attack-overview">Part II: Attack overview<a href="#part-ii-attack-overview" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>In short, the vulnerability appears because of the below reasons:</p>
<ol>
<li>similarity between serialization of parent nodes and leaf nodes, and</li>
<li>missing checks to heights for parent nodes.</li>
</ol>
<p>We then can create malicious leaf nodes that appeared to be parent nodes, and use that node to generate range proofs to show that an key is absent from the tree.</p>
<div class="alert warning">
  ü§ñ <strong>Where are the details?</strong> They are in the next part! I intend to skip the technical details here to let the readers to have a idea what's going on.
</div>

<p>We now present an example where we assume that there is a single node (namely üö©) in the IAVL tree. The objective is to supply a proof that üö© is absent.</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
node[shape=&amp;#34;box&amp;#34;, style=&amp;#34;rounded, filled&amp;#34;, color=&amp;#34;#ffe4e1&amp;#34;, fontcolor=&amp;#34;#ffe4e1&amp;#34;, fillcolor=&amp;#34;#33333c&amp;#34;]

flag[label=&amp;lt;üö©&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;]

  }
  </div>
</div>

<p>What we do is to insert a <em>single</em> malicious node to the left of the IAVL tree, here üòà needs to lexicographically smaller than üö© so that the malicious node is placed to the left of üö©:</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
node[shape=&amp;#34;box&amp;#34;, style=&amp;#34;rounded, filled&amp;#34;, color=&amp;#34;#ffe4e1&amp;#34;, fontcolor=&amp;#34;#ffe4e1&amp;#34;, fillcolor=&amp;#34;#33333c&amp;#34;]

root[label=&amp;lt;üìÇ&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 1&amp;lt;BR /&amp;gt;Size: 2&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;]
malicious[label=&amp;lt;üòà&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;]
flag[label=&amp;lt;üö©&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;]

root-&amp;gt;malicious
root-&amp;gt;flag

  }
  </div>
</div>

<p>This malicious node is disguised as a parent node with two child nodes, üëª and üìÅ, when supplied as a proof. We require üëª to be lexicographically greater than üö©. If we generate a range proof containing üëª as the only node, we can tell that üëª is the leftmost element in the IAVL tree. With that said, there are no keys in $(-\infty, üëª)$. Given that $üö© \in (-\infty, üëª)$, the verifier is convinced that üö© is absent.</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
node[shape=&amp;#34;box&amp;#34;, style=&amp;#34;rounded, filled&amp;#34;, color=&amp;#34;#ffe4e1&amp;#34;, fontcolor=&amp;#34;#ffe4e1&amp;#34;, fillcolor=&amp;#34;#33333c&amp;#34;]

root[label=&amp;lt;üìÇ&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 1&amp;lt;BR /&amp;gt;Size: 2&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;, fillcolor=&amp;#34;#66666c&amp;#34;]
malicious[label=&amp;lt;üòà&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;, fillcolor=&amp;#34;#66666c&amp;#34;]
malicious_left_child[label=&amp;lt;üëª&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;, fillcolor=&amp;#34;#66666c&amp;#34;, style=&amp;#34;dashed,rounded,filled&amp;#34;]
malicious_right_subtree[label=&amp;lt;üìÅ&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: ?&amp;lt;BR /&amp;gt;Size: ?&amp;lt;BR /&amp;gt;Version: ?&amp;lt;/font&amp;gt;&amp;gt;, style=&amp;#34;dashed,rounded,filled&amp;#34;]
flag[label=&amp;lt;üö©&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;]

root-&amp;gt;malicious
root-&amp;gt;flag
malicious-&amp;gt;malicious_left_child
malicious-&amp;gt;malicious_right_subtree

  }
  </div>
</div>

<h3 id="part-iii-implementation-details">Part III: Implementation details<a href="#part-iii-implementation-details" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="computing-a-node-hash-of-iavl-trees">Computing a node hash of IAVL trees<a href="#computing-a-node-hash-of-iavl-trees" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>There will be a hash for each node in IAVL trees. The parent and leaf nodes use different material to compute the hashes as defined in <a href="https://github.com/cosmos/iavl/blob/v0.19.2/node.go#L334"
   
   target="_blank" rel="noopener noreferrer" ><code>writeHashBytes</code></a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg> in <code>node.go</code>:</p>
<ul>
<li>Parent node: <code>SHA256(height || size || version || leftHash || rightHash)</code></li>
<li>Leaf node: <code>SHA256(height || size || version || key || valueHash)</code></li>
</ul>
<p>Here <code>height</code>, <code>size</code> and <code>version</code> are integers and the remaining are bytes. They are uniquely encoded so that no two parent nodes (resp. leaf nodes) could end up having the same node hash.</p>
<p>For the below node with <code>key</code> being <code>hello</code> and <code>value</code> being the empty string, we have the digest being <code>addee74d...</code>.</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
node[shape=&amp;#34;box&amp;#34;, style=&amp;#34;rounded, filled&amp;#34;, color=&amp;#34;#ffe4e1&amp;#34;, fontcolor=&amp;#34;#ffe4e1&amp;#34;, fillcolor=&amp;#34;#33333c&amp;#34;]
dummy[label=&amp;lt;hello&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;]

  }
  </div>
</div>

<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;00&#39;</span> <span class="o">+</span> <span class="c1"># height=0</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;02&#39;</span> <span class="o">+</span> <span class="c1"># size=1</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;02&#39;</span> <span class="o">+</span> <span class="c1"># version=1</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;05 68656c6c6f&#39;</span> <span class="o">+</span> <span class="c1"># key=hello</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;20 e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&#39;</span> <span class="c1"># SHA256(value)</span>
</span></span><span class="line"><span class="cl"><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># addee74d6c7b968206e8072eb5147e48dc14d1ab78dceb3a352b1e6fa144fc4f</span>
</span></span></code></pre></div><p>Now proceed to a tree. From above, we know that the digests of the left and right child nodes are respectively <code>addee74d...</code> and <code>bdfd061f...</code>.</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
node[shape=&amp;#34;box&amp;#34;, style=&amp;#34;rounded, filled&amp;#34;, color=&amp;#34;#ffe4e1&amp;#34;, fontcolor=&amp;#34;#ffe4e1&amp;#34;, fillcolor=&amp;#34;#33333c&amp;#34;]

root[label=&amp;lt;üìÇ&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 1&amp;lt;BR /&amp;gt;Size: 2&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;]
dummy1[label=&amp;lt;hello&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;]
dummy2[label=&amp;lt;world&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;/font&amp;gt;&amp;gt;]

root -&amp;gt; dummy1
root -&amp;gt; dummy2

  }
  </div>
</div>

<p>With that, we can compute the digest of üìÇ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;02&#39;</span> <span class="o">+</span> <span class="c1"># height=1</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;04&#39;</span> <span class="o">+</span> <span class="c1"># size=2</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;02&#39;</span> <span class="o">+</span> <span class="c1"># version=1</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;20 addee74d6c7b968206e8072eb5147e48dc14d1ab78dceb3a352b1e6fa144fc4f&#39;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;20 bdfd061f8989347217253be5a7ef06117d2be62fc6dde0d9752a5debc902f011&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 166c299760ef7b1e27116893a2623e38a8b3c763b831568eac46138527553bc5</span>
</span></span></code></pre></div><p>It would be theoretically infeasible to find two trees that yield the same node hash for the root node. Therefore we can use root node hashes to determine the integrity of IAVL trees.</p>
<div class="alert info">
  üòï <strong>How about the add and remove operations?</strong> We are only interested in the final shapes of the IAVL trees, the update operations will be out of scope.
</div>

<h4 id="range-proofs">Range proofs<a href="#range-proofs" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>The leaf nodes of IAVL trees are sorted. If node A is lexicographically smaller than node B, we will see node A is on the left of node B. With this property, we are able to reveal a subtree of consecutive leaf nodes to show the absence of a given node.</p>
<p>We can imagine that we have a sorted array. If $a &lt; x &lt; b$, by showing a contiguous subarray <code>[a, b]</code> we can prove that <code>x</code> does not exist in the array. Now you have to convince the verifier that <code>[a, b]</code> is a subarray, and it is contiguous.</p>
<p>By having a IAVL tree, the verifier only have to maintain the digest of the root nodes to verify proofs. For more details, please read <a href="https://github.com/cosmos/iavl/blob/master/docs/proof/proof.md"
   
   target="_blank" rel="noopener noreferrer" >the documentation on proofs in cosmos/iavl</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg>.</p>
<h3 id="part-iv-shaping-the-attack">Part IV: Shaping the attack<a href="#part-iv-shaping-the-attack" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>As mentioned before, the entire attack involves three leaf nodes: üö©, üòà and üëª. We assume that üö© is already in the tree and will only insert üòà to it. The values are always empty in the challenge and we can't alter them.</p>
<p>We will first find the key of üëª. It has to be lexicographically greater than üö©, and its node hash is lexicographically smaller than üö© at the same time.</p>
<p>In our case, the keys for üö© and üëª are <code>Please give me flag</code> and <code>QQR</code> respectively. The node hash for üëª is <code>22220311...</code> hex-encoded.</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
node[shape=&amp;#34;box&amp;#34;, style=&amp;#34;rounded, filled&amp;#34;, color=&amp;#34;#ffe4e1&amp;#34;, fontcolor=&amp;#34;#ffe4e1&amp;#34;, fillcolor=&amp;#34;#33333c&amp;#34;]

malicious_left_child[label=&amp;lt;üëª&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;BR /&amp;gt;Hash: 22220311...&amp;lt;/font&amp;gt;&amp;gt;]
flag[label=&amp;lt;üö©&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;BR /&amp;gt;Hash: a6fb1c60...&amp;lt;/font&amp;gt;&amp;gt;]

  }
  </div>
</div>

<p>Now we can simply use the hex-encoded <code>22220311...</code> as the key for üòà, and insert it to the tree. Now there are two nodes in our tree.</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
node[shape=&amp;#34;box&amp;#34;, style=&amp;#34;rounded, filled&amp;#34;, color=&amp;#34;#ffe4e1&amp;#34;, fontcolor=&amp;#34;#ffe4e1&amp;#34;, fillcolor=&amp;#34;#33333c&amp;#34;]

root[label=&amp;lt;üìÇ&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 1&amp;lt;BR /&amp;gt;Size: 2&amp;lt;BR /&amp;gt;Version: 1&amp;lt;BR /&amp;gt;Hash: 660f9501...&amp;lt;/font&amp;gt;&amp;gt;]
malicious[label=&amp;lt;üòà&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;BR /&amp;gt;Hash: 01f31a15...&amp;lt;/font&amp;gt;&amp;gt;]
flag[label=&amp;lt;üö©&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;BR /&amp;gt;Hash: a6fb1c60...&amp;lt;/font&amp;gt;&amp;gt;]

root-&amp;gt;malicious
root-&amp;gt;flag

  }
  </div>
</div>

<p>In the proof, we can disguise üòà as a parent node with üëª being its left child. We then reveal the below subtree to the verifier:</p>
<div class="text-center pb-3">
  <div class="graphviz">
  digraph {
    graph [bgcolor="transparent"]
    node [color="#ffe4e1", fontcolor="#ffe4e1", fillcolor="#33333c", style="filled"]
    edge [color="#ffe4e1", fontcolor="#ffe4e1"]

    
node[shape=&amp;#34;box&amp;#34;, style=&amp;#34;rounded, filled&amp;#34;, color=&amp;#34;#ffe4e1&amp;#34;, fontcolor=&amp;#34;#ffe4e1&amp;#34;, fillcolor=&amp;#34;#33333c&amp;#34;]

root[label=&amp;lt;üìÇ&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 1&amp;lt;BR /&amp;gt;Size: 2&amp;lt;BR /&amp;gt;Version: 1&amp;lt;BR /&amp;gt;Hash: 660f9501...&amp;lt;/font&amp;gt;&amp;gt;, fillcolor=&amp;#34;#66666c&amp;#34;]
malicious[label=&amp;lt;üòà&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;BR /&amp;gt;Hash: 01f31a15...&amp;lt;/font&amp;gt;&amp;gt;, fillcolor=&amp;#34;#66666c&amp;#34;]
malicious_left_child[label=&amp;lt;üëª&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Height: 0&amp;lt;BR /&amp;gt;Size: 1&amp;lt;BR /&amp;gt;Version: 1&amp;lt;BR /&amp;gt;Hash: 22220311...&amp;lt;/font&amp;gt;&amp;gt;, fillcolor=&amp;#34;#66666c&amp;#34;, style=&amp;#34;dashed,rounded,filled&amp;#34;]
malicious_right_subtree[label=&amp;lt;&amp;lt;font point-size=&amp;#34;30&amp;#34;&amp;gt;üìÅ&amp;lt;/font&amp;gt;&amp;lt;BR /&amp;gt;&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Hash: e3b0c442...&amp;lt;/font&amp;gt;&amp;gt;, style=plaintext, color=transparent]
flag[label=&amp;lt;&amp;lt;font point-size=&amp;#34;30&amp;#34;&amp;gt;üìÅ&amp;lt;/font&amp;gt;&amp;lt;BR /&amp;gt;&amp;lt;BR /&amp;gt;&amp;lt;font point-size=&amp;#34;11&amp;#34;&amp;gt;Hash: a6fb1c60...&amp;lt;/font&amp;gt;&amp;gt;, style=plaintext, color=transparent]

root-&amp;gt;malicious
root-&amp;gt;flag
malicious-&amp;gt;malicious_left_child
malicious-&amp;gt;malicious_right_subtree

  }
  </div>
</div>

<p>And finally the verifier is convinced that üö© is not in the tree.</p>
<p>Below is the equivalent proof that I sent to the verifier, and eventually I got the flag -- <code>TetCTF{l34f_c0ns3cut1v3n3ss_n0t_3nf0rc3d}</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;left_path&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;height&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;right&#34;</span><span class="p">:</span> <span class="s2">&#34;pvscYKxyFDUPxP0R6qEYaAMYdJC4G2VXKhgJAuAh4So=&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;height&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;right&#34;</span><span class="p">:</span> <span class="s2">&#34;47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;inner_nodes&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;leaves&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;515152&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="alert danger">
  ü§î <strong>What's in the node <code>e3b0c442...</code>?</strong> We are forced to set this because the value of leaf nodes must be empty, thus we are unable to forge a subtree. We can assume that is a &quot;corrupted&quot; subtree that no one can ever expand.
</div>

<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>sanebow (2022): &quot;BNB Hack: IAVL Spoofing Explained&quot;<br><a href="https://sanebow.me/bnb-hack-iavl-explained"
   
   target="_blank" rel="noopener noreferrer" >https://sanebow.me/bnb-hack-iavl-explained</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Immunefi (2023): &quot;Hack Analysis: Binance Bridge, October 2022&quot;<br><a href="https://medium.com/immunefi/hack-analysis-binance-bridge-october-2022-2876d39247c1"
   
   target="_blank" rel="noopener noreferrer" >https://medium.com/immunefi/hack-analysis-binance-bridge-october-2022-2876d39247c1</a><svg t="1713426496023" style="margin: 0 0 0 5px;" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8864" width="10" height="10">
    <path d="M1001.627381 394.106435a44.521739 44.521739 0 1 1-88.598261 0V208.228174l-398.914783 398.914783a54.049391 54.049391 0 1 1-76.577391-76.310261l397.579131-397.490087h-182.984348a44.78887 44.78887 0 1 1 0-89.043479h298.740869c1.335652 0 2.226087 0.534261 3.561739 0.623305s1.78087-0.623304 2.671305-0.623305a40.069565 40.069565 0 0 1 27.158261 11.620174c1.157565 0.667826 2.226087 1.513739 3.116521 2.448696 0.890435 0.979478 1.78087 2.092522 2.671305 3.161043a41.360696 41.360696 0 0 1 11.575652 27.158261c0 0.979478-0.445217 1.825391-0.445218 2.80487s0.445217 2.359652 0.445218 3.650783v298.963478zM111.192598 934.956522h712.347826v-400.695652h89.043479v400.695652a89.043478 89.043478 0 0 1-89.043479 89.043478H111.192598a89.043478 89.043478 0 0 1-89.043478-89.043478V222.608696a89.043478 89.043478 0 0 1 89.043478-89.043479h400.695652v89.043479H111.192598v712.347826z" fill="#666666" p-id="8865"></path>
</svg>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

        </div></div>

      
      <aside class="toc-container">
        <a href="#" class="toc-title-link">
          TetCTF 2024: adapt
        </a>
        <div class="js-toc"></div>
      </aside>
      

      
      <hr />
      <script src="https://giscus.app/client.js"
        data-repo="samueltangz/samueltangz.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMDI0MjQyMjE="
        data-category="General"
        data-category-id="DIC_kwDOEgagnc4C0haj"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="0"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="dark"
        data-lang="en"
        crossorigin="anonymous"
        async>
      </script>
      

      
      <hr />
      <div class="py-3">
        
          <a class="btn" href="/posts/2024/2024-02-23-intigriti-xss/">‚Üê Intigriti&#39;s XSS Challenge (February 2024)</a>
        

        
          <a class="btn float-end" href="/posts/2024/2024-01-27-hkcert-ctf-3/">HKCERT CTF 2023 Postmortem (III): The Remaining Challenges ‚Üí</a>
        
      </div>
      

    </div>
  </div>

    </div>
  </main>
  <div class="container">
  <footer class="py-3 my-4 border-top">
    <p class="text-center text-body-secondary">&copy; 2026 Powered by <em>Hugo</em>. Theme crafted by <em>Mystiz</em> with Bootstrap 5, inspired from <em>Terminal</em>.</p>
  </footer>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css"
  integrity="sha384-Pu5+C18nP5dwykLJOhd2U4Xen7rjScHN/qusop27hdd2drI+lL5KvX7YntvT8yew" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js"
  integrity="sha384-2B8pfmZZ6JlVoScJm/5hQfNS2TI/6hPqDZInzzPc8oHpN5SgeNOf4LzREO6p5YtZ" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/contrib/auto-render.min.js"
  integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }], trust: true })"></script>

<script src="https://cdn.jsdelivr.net/npm/@viz-js/viz@3.24.0/dist/viz-global.min.js"></script>
<script>
Viz.instance().then(viz => {
  const unescape = function (s) {
    const t = s.replace(/&amp;/g, '&')
    return t.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&#34;/g, '"')
  }

  document.querySelectorAll('[class=graphviz]').forEach(node => {
    const source = unescape(node.innerText);
    const svg = viz.renderSVGElement(source, { engine: 'dot' });
    node.parentNode.appendChild(svg);
    node.style.display = 'none';
  });
});
</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.js"
  integrity="sha512-BZUSsJAPNtkd+kdY/bD7hvQKZ5zlgWt++KGy/Pa/5uEJNgs0jZ6JaX6MuclRUanowuxmhb5S3LRPEa3QmrUVfA==" crossorigin="anonymous"
  referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.36.4/tocbot.min.css"
  integrity="sha512-/ANQiHMqpRl+E0zEAd250N21OOmJsYbhiJWY0Y8yG0TII47yZn1+gDNobMlf+h/FTyImprLXYgXbX3bCYyq/vg==" crossorigin="anonymous"
  referrerpolicy="no-referrer" />
<script type="text/javascript">
tocbot.init({
  headingSelector: 'h1, h2, h3, h4',
  orderedList: false,
  collapseDepth: 2,
  headingsOffset: 60,
  scrollSmoothOffset: -60
})
</script>


<script>
  document.querySelectorAll('pre code').forEach(el => {
    const lang = Array.from(el.classList).find(className => className.startsWith('language-'));
    if (!lang) return;

    
    if (lang.startsWith('language-diff-')) {
      el.classList.add('diff-highlight');
    }
  })
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({
  startOnLoad: true,
  htmlLabels: true,
  securityLevel: "loose",
  theme: 'base',
  themeVariables: {
    background: '#22222c',
    primaryColor: '#33333c',
    primaryTextColor: '#ffe4e1',
  }
});
</script>

</body>
</html>
