<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>HKCERT CTF 2022 Postmortem (I): Easier Crypto Challenges :: Mystify</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This is the third year Black Bauhinia co-organized HKCERT CTF. This time I wrote nine challenges: Seven crypto, one reverse and one misc.
Similar to the last year, I have a series of three blog posts walking through the challenges that I wrote. We will discuss the four easier crypto challenges: Flawed ElGamal, Catch-22, Rogue Secret Assistant and Base64 encryption.
This is an index of the challenges I wrote for HKCERT CTF 2022." />
<meta name="keywords" content="ctf" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://mystiz.hk/posts/2022/2022-12-24-hkcert-ctf-1/" />




<link rel="stylesheet" href="https://mystiz.hk/assets/style.css">

  <link rel="stylesheet" href="https://mystiz.hk/assets/mystiz.css">






<link rel="apple-touch-icon" href="https://mystiz.hk/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://mystiz.hk/img/favicon/mystiz.png">





<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://mystiz.hk/images/2022-12-24-hkcert-ctf/catch-22-summary.png" />


  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="mystiz613" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="HKCERT CTF 2022 Postmortem (I): Easier Crypto Challenges">
<meta property="og:description" content="This is the third year Black Bauhinia co-organized HKCERT CTF. This time I wrote nine challenges: Seven crypto, one reverse and one misc.

Similar to the last year, I have a series of three blog posts walking through the challenges that I wrote. We will discuss the four easier crypto challenges: Flawed ElGamal, Catch-22, Rogue Secret Assistant and Base64 encryption." />
<meta property="og:url" content="https://mystiz.hk/posts/2022/2022-12-24-hkcert-ctf-1/" />
<meta property="og:site_name" content="Mystify" />

  <meta property="og:image" content="https://mystiz.hk/images/2022-12-24-hkcert-ctf/catch-22-summary.png">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-12-24 16:46:00 &#43;0800 &#43;0800" />












  <script data-ad-client="ca-pub-3220069814773012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


</head>
<body class="mystiz">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Mystify
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about-me">About Me</a></li>
        
      
        
          <li><a href="/blogroll">Blogroll</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">Show more ▾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/crypto-in-ctf">Crypto in CTF</a></li>
              
            
          </ul>
        </ul>
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about-me">About Me</a></li>
      
    
      
        <li><a href="/blogroll">Blogroll</a></li>
      
    
      
        <li><a href="/crypto-in-ctf">Crypto in CTF</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://mystiz.hk/posts/2022/2022-12-24-hkcert-ctf-1/">HKCERT CTF 2022 Postmortem (I): Easier Crypto Challenges</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-12-24 
      </span>
    
    
    <span class="post-author">:: Mystiz</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://mystiz.hk/tags/ctf/">ctf</a>&nbsp;
    
    #<a href="https://mystiz.hk/tags/hkcert-ctf/">hkcert-ctf</a>&nbsp;
    
    #<a href="https://mystiz.hk/tags/challenge-writing/">challenge-writing</a>&nbsp;
    
    #<a href="https://mystiz.hk/tags/crypto/">crypto</a>&nbsp;
    
  </span>
  

  

  
    <img src="https://mystiz.hk/images/2022-12-24-hkcert-ctf/catch-22-summary.png" class="post-cover center" alt="HKCERT CTF 2022 Postmortem (I): Easier Crypto Challenges" />
  

  <div class="post-content js-toc-content"><div>
        <p>This is the third year Black Bauhinia co-organized HKCERT CTF. This time I wrote nine challenges: Seven crypto, one reverse and one misc.</p>

<p>Similar to the last year, I have a series of three blog posts walking through the challenges that I wrote. We will discuss the four easier crypto challenges: <em>Flawed ElGamal</em>, <em>Catch-22</em>, <em>Rogue Secret Assistant</em> and <em>Base64 encryption</em>.</p>

<p>This is an index of the challenges I wrote for HKCERT CTF 2022. There are in total 309 teams participating:</p>

<ol>
<li><a href="#海山樓--flawed-elgamal-crypto">Flawed ElGamal (Crypto; 127 solves)</a></li>
<li><a href="#九龍公園--catch22-crypto">Catch-22 (Crypto; 136 solves)</a></li>
<li><a href="#獅子山二號棒球場--base64-encryption-crypto">Base64 Encryption (Crypto; 6 solves)</a></li>
<li><a href="#香港中文大學邵逸夫夫人樓--rogue-secret-assistant-crypto">Rogue Secret Assistant (Crypto; 7 solves)</a></li>
<li><a href="/posts/2022/2022-12-24-hkcert-ctf-2/#亞洲協會香港中心--mystiz-cant-code-crypto">Mystiz can't code (Crypto; 1 solve)</a></li>
<li><a href="/posts/2022/2022-12-24-hkcert-ctf-2/#澳洲牛奶公司--slow-keystream-crypto">Slow keystream (Crypto; 6 solves)</a></li>
<li><a href="/posts/2022/2022-12-24-hkcert-ctf-2/#海帆道--king-of-rock-paper-scissors-crypto">King of Rock, Paper, Scissors (Crypto; 1 solve)</a></li>
<li><a href="/posts/2022/2022-12-24-hkcert-ctf-3/#觀塘海濱音樂噴泉--numbers-go-brrr-reverse">Numbers go brrr (Reverse; 3 solves)</a></li>
<li><a href="/posts/2022/2022-12-24-hkcert-ctf-3/#cga-香港電競館--minecraft-geoguessr-misc">Minecraft Geoguessr (Misc; 4 solves)</a></li>
</ol>

<h2 id="海山樓--flawed-elgamal-crypto">海山樓 / Flawed ElGamal (Crypto)<a href="#海山樓--flawed-elgamal-crypto" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary">Challenge Summary<a href="#challenge-summary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p>Cryptography is difficult. It is hard to implement -- every small mistakes would lead to a total break down.</p>

<p>I tried my very best to implement the ElGamal according to the Wikipedia page. What can go wrong?</p>
</blockquote>

<p>The server will be returning an encrypted flag, $(c_1, c_2)$, every time a player connects to the server. This is the public key used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">p <span style="color:#f92672">=</span> <span style="color:#ae81ff">1444779821068309665607966047026245709114363505560724292470220924533941341173119282750461450104319554545087521581252757303050671443847680075401505584975539</span>
g <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
h <span style="color:#f92672">=</span> <span style="color:#ae81ff">679175474187312157096793918495021788380347146757928688295980599009809870413272456661249570962293053504169610388075260415234004679602069004959459298631976</span></code></pre></div>
<p>Note that the ciphertext is computed by a flawed ElGamal such that $(c_1, c_2)$:</p>

<ol>
<li>Generating a random $y \in [1, p-1]$,</li>
<li>Compute $s := h^y \ \text{mod}\ p$,</li>
<li>Compute $c_1 := g^y\ \text{mod}\ p$,</li>
<li>Compute $c_2 := m \cdot s$.</li>
</ol>

<p>The goal is to obtain the flag, $m$.</p>

<h3 id="solution">Solution<a href="#solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<p>An important observation is that $c_2 := m \cdot s$ is not taken modulo $p$, therefore it is a multiple of $m$. If we get many ciphertexts $(c_1, c_2)$, $(c_1', c_2')$, ... by connecting to the server multiple times, eventually we have</p>

<p><span  class="math">\[m = \gcd(c_2, c_2', ...).\]</span></p>

<p>We can use the Euclidean algorithm to compute the GCD of two numbers, given below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gcd</span>(a, b):
    <span style="color:#66d9ef">while</span> b <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
        a, b <span style="color:#f92672">=</span> b, a <span style="color:#f92672">%</span> b
    <span style="color:#66d9ef">return</span> a</code></pre></div>
<p>To compute GCD of multiple numbers ($a, b, ..., c$), we can apply GCD pairwise:</p>

<p><span  class="math">\[\gcd(a, b, ..., c) = \gcd(...\gcd(\gcd(a, b), ...), c).\]</span></p>

<p>After getting the number $m$, we can convert it into a string. From <code>chall.py</code>, the flag string is converted to a number by <code>m = int.from_bytes(flag, 'big')</code>. You may want to look at how a reverse operation can be done using <a href="https://docs.python.org/3/library/stdtypes.html#int.to_bytes"><code>int.to_bytes</code></a> in Python. Eventually, we have <code>hkcert22{4nd_th1s_t1m3_7h3_i5su3_1s_s0l31y_n0t_t4k1n9_m0du10s}</code>.</p>

<div class="alert danger">
  <strong>🏁 I am not getting the flag!</strong> That means the <code>m</code> you got is incorrect. The GCD you obtained is probably a small multiple of the actual $m$ - go get more $c_2$&rsquo;s and compute GCDs further!
</div>


<h2 id="九龍公園--catch22-crypto">九龍公園 / Catch-22 (Crypto)<a href="#九龍公園--catch22-crypto" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary-1">Challenge Summary<a href="#challenge-summary-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p>You need a key to open the door... but what if the key is in the room?</p>
</blockquote>

<p>We are given a web game. The player can navigate in the map and the goal is to access the flag.</p>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/catch-22-summary.png"   />
    
  </figure>



<p>Notably, the game state (example given below) is encrypted by AES-ECB and is stored in the cookie.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{<span style="color:#f92672">&#34;username&#34;</span>:<span style="color:#e6db74">&#34;mystiz&#34;</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">13</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>,<span style="color:#f92672">&#34;inventory&#34;</span>:[],<span style="color:#f92672">&#34;onMapItems&#34;</span>:[{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">0</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">3</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">4</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">0</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">3</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">4</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">4</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">5</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">6</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">0</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">15</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">1</span>}]}</code></pre></div>
<h3 id="solution-1">Solution<a href="#solution-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<div class="alert warning">
  <strong>Note.</strong> Copying the cookies from the write-up would not work. The encryption keys are different when I compile the write-up and for the actual challenge.
</div>


<h4 id="part-i-interacting-with-the-browser-s">Part I: Interacting with the browser 🍪s<a href="#part-i-interacting-with-the-browser-s" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>If you are using Google Chrome (probably the same for the common browsers), you can press F12 to open the developer tools and switch to the &quot;Console&quot; tab. You can read the cookies by typing the below snippet, and execute it by pressing Enter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">document.<span style="color:#a6e22e">cookie</span></code></pre></div>
<p>To set a cookie (for example, setting the value of the <code>game-token</code> to <code>bar</code>), type the below snippet and press Enter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">document.<span style="color:#a6e22e">cookie</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;game-token=bar&#34;</span></code></pre></div>
<p>That's it! You can manipulate cookies easily from your browser.</p>

<h4 id="part-ii-encrypting-messages-of-arbitrary-length-for-block-ciphers">Part II: Encrypting messages of arbitrary length for block ciphers<a href="#part-ii-encrypting-messages-of-arbitrary-length-for-block-ciphers" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>Block ciphers are only capable to encrypt messages of a fixed length. For instance, <em>Advanced Encryption Standard (AES)</em> can only encrypt messages of 16 bytes. To encrypt messages of variable length, the messages are first padded such that their length is a multiple of the block size. After that, a mode of operation is picked.</p>

<h5 id="the-electronic-codebook-ecb-mode-of-operation">The electronic codebook (ECB) mode of operation<a href="#the-electronic-codebook-ecb-mode-of-operation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/catch-22-ecb.png"   />
    
      <figcaption class="right" >Illustration of ECB. Source: <a href='https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Electronic_codebook_(ECB)'>Wikipedia</a></figcaption>
    
  </figure>



<p>We are using ECB in this challenge. As illustrated above, the message blocks are encrypted independently. Sounds intuitive?</p>

<p>Let's use a cookie as an example. It is encrypted in AES, which the block size is 16 bytes (equivalent to 32 hex characters):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">fff21bf4a7d27a027502b1e1a253b35f071efbc3642eea3269d634e6c984feebf89e4736ab5ba5b4ef81b78a57a889ba4cf06024a9c302947c9a620592c23a76476e8424c54f1f47216f45d903c1baa4d2bd6f06d268a81b9d30326c80f521249fdba79cf386395248f82a0236c0771ae4210d738aa474035eda8131cc3f384ac551a93538d21903eb1b717741df7e1b7ac7350304f0d7f6db588f809cf319706f0a09ededf7547fab175c8e132a832c878303dd6064ba98361cf4f9784a0699</code></pre></div>
<p>corresponds to the state</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{<span style="color:#f92672">&#34;username&#34;</span>:<span style="color:#e6db74">&#34;mystiz_&#34;</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">13</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>,<span style="color:#f92672">&#34;inventory&#34;</span>:[],<span style="color:#f92672">&#34;onMapItems&#34;</span>:[{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">0</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">3</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">4</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">4</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">5</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">6</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">0</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">15</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">1</span>}]}</code></pre></div>
<p>Let <code>_</code> be the padding character (ASCII value <code>0x0b</code>) according to PKCS5. These are the relations extracted between the plaintext and ciphertext blocks:</p>

<table>
<thead>
<tr>
<th>Plaintext Block</th>
<th>Ciphertext Block</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>{&quot;username&quot;:&quot;mys</code></td>
<td><code>fff21bf4a7d27a027502b1e1a253b35f</code></td>
</tr>

<tr>
<td><code>tiz_&quot;,&quot;x&quot;:13,&quot;y&quot;</code></td>
<td><code>071efbc3642eea3269d634e6c984feeb</code></td>
</tr>

<tr>
<td><code>:5,&quot;inventory&quot;:[</code></td>
<td><code>f89e4736ab5ba5b4ef81b78a57a889ba</code></td>
</tr>

<tr>
<td><code>],&quot;onMapItems&quot;:[</code></td>
<td><code>4cf06024a9c302947c9a620592c23a76</code></td>
</tr>

<tr>
<td><code>{&quot;item&quot;:0,&quot;x&quot;:3,</code></td>
<td><code>476e8424c54f1f47216f45d903c1baa4</code></td>
</tr>

<tr>
<td><code>&quot;y&quot;:4},{&quot;item&quot;:1</code></td>
<td><code>d2bd6f06d268a81b9d30326c80f52124</code></td>
</tr>

<tr>
<td><code>,&quot;x&quot;:4,&quot;y&quot;:5},{&quot;</code></td>
<td><code>9fdba79cf386395248f82a0236c0771a</code></td>
</tr>

<tr>
<td><code>item&quot;:1,&quot;x&quot;:5,&quot;y</code></td>
<td><code>e4210d738aa474035eda8131cc3f384a</code></td>
</tr>

<tr>
<td><code>&quot;:5},{&quot;item&quot;:1,&quot;</code></td>
<td><code>c551a93538d21903eb1b717741df7e1b</code></td>
</tr>

<tr>
<td><code>x&quot;:6,&quot;y&quot;:5},{&quot;it</code></td>
<td><code>7ac7350304f0d7f6db588f809cf31970</code></td>
</tr>

<tr>
<td><code>em&quot;:0,&quot;x&quot;:15,&quot;y&quot;</code></td>
<td><code>6f0a09ededf7547fab175c8e132a832c</code></td>
</tr>

<tr>
<td><code>:1}]}___________</code></td>
<td><code>878303dd6064ba98361cf4f9784a0699</code></td>
</tr>
</tbody>
</table>

<h4 id="part-iii-casting-the-cutandpaste-attack">Part III: Casting the cut-and-paste attack<a href="#part-iii-casting-the-cutandpaste-attack" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>There is an interesting property for electronic codebook (ECB). Since the blocks are independently encrypted, no one would be able to identify if we swap two blocks. For instance, this is a message-ciphertext pair that we can forge (given the above relations):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Message:     {&#34;username&#34;:&#34;mys{&#34;username&#34;:&#34;mys
Ciphertext:  fff21bf4a7d27a027502b1e1a253b35f fff21bf4a7d27a027502b1e1a253b35f</code></pre></div>
<p>This seemed to be useless, but we will use this idea to solve the challenge.</p>

<p>There are many ways to get the flag. My approach is to fill my inventory with keys. The <code>inventory</code> in the state is an array of item IDs. For instance, when there is two keys (ID = 0) in the inventory, the state would be <code>{...,&quot;inventory&quot;:[0,0],...}</code>.</p>

<p>If we register an account called <code>mys0,0,0,0,0,0,0,0 tiz_</code>, then we have the corresponding token:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">fff21bf4a7d27a027502b1e1a253b35ffb2333bf9573b1d240840aefb4f78b1e071efbc3642eea3269d634e6c984feebf89e4736ab5ba5b4ef81b78a57a889ba4cf06024a9c302947c9a620592c23a76476e8424c54f1f47216f45d903c1baa4d2bd6f06d268a81b9d30326c80f521249fdba79cf386395248f82a0236c0771ae4210d738aa474035eda8131cc3f384ac551a93538d21903eb1b717741df7e1b7ac7350304f0d7f6db588f809cf319706f0a09ededf7547fab175c8e132a832c878303dd6064ba98361cf4f9784a0699</code></pre></div>
<table>
<thead>
<tr>
<th>Plaintext Block</th>
<th>Ciphertext Block</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>{&quot;username&quot;:&quot;mys</code></td>
<td><code>fff21bf4a7d27a027502b1e1a253b35f</code></td>
</tr>

<tr>
<td><code>0,0,0,0,0,0,0,0&nbsp;</code></td>
<td><code>fb2333bf9573b1d240840aefb4f78b1e</code></td>
</tr>

<tr>
<td><code>tiz_&quot;,&quot;x&quot;:13,&quot;y&quot;</code></td>
<td><code>071efbc3642eea3269d634e6c984feeb</code></td>
</tr>

<tr>
<td><code>:5,&quot;inventory&quot;:[</code></td>
<td><code>f89e4736ab5ba5b4ef81b78a57a889ba</code></td>
</tr>

<tr>
<td><code>],&quot;onMapItems&quot;:[</code></td>
<td><code>4cf06024a9c302947c9a620592c23a76</code></td>
</tr>

<tr>
<td><code>{&quot;item&quot;:0,&quot;x&quot;:3,</code></td>
<td><code>476e8424c54f1f47216f45d903c1baa4</code></td>
</tr>

<tr>
<td><code>&quot;y&quot;:4},{&quot;item&quot;:1</code></td>
<td><code>d2bd6f06d268a81b9d30326c80f52124</code></td>
</tr>

<tr>
<td><code>,&quot;x&quot;:4,&quot;y&quot;:5},{&quot;</code></td>
<td><code>9fdba79cf386395248f82a0236c0771a</code></td>
</tr>

<tr>
<td><code>item&quot;:1,&quot;x&quot;:5,&quot;y</code></td>
<td><code>e4210d738aa474035eda8131cc3f384a</code></td>
</tr>

<tr>
<td><code>&quot;:5},{&quot;item&quot;:1,&quot;</code></td>
<td><code>c551a93538d21903eb1b717741df7e1b</code></td>
</tr>

<tr>
<td><code>x&quot;:6,&quot;y&quot;:5},{&quot;it</code></td>
<td><code>7ac7350304f0d7f6db588f809cf31970</code></td>
</tr>

<tr>
<td><code>em&quot;:0,&quot;x&quot;:15,&quot;y&quot;</code></td>
<td><code>6f0a09ededf7547fab175c8e132a832c</code></td>
</tr>

<tr>
<td><code>:1}]}___________</code></td>
<td><code>878303dd6064ba98361cf4f9784a0699</code></td>
</tr>
</tbody>
</table>

<p>If we move the second block between the fourth and the fifth blocks, then this is the new plaintext:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{<span style="color:#f92672">&#34;username&#34;</span>:<span style="color:#e6db74">&#34;mystiz_&#34;</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">13</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>,<span style="color:#f92672">&#34;inventory&#34;</span>:[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span> ],<span style="color:#f92672">&#34;onMapItems&#34;</span>:[{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">0</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">3</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">4</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">4</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">5</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">1</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">6</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">5</span>},{<span style="color:#f92672">&#34;item&#34;</span>:<span style="color:#ae81ff">0</span>,<span style="color:#f92672">&#34;x&#34;</span>:<span style="color:#ae81ff">15</span>,<span style="color:#f92672">&#34;y&#34;</span>:<span style="color:#ae81ff">1</span>}]}</code></pre></div>
<p>We can concatenate the ciphertext blocks and update the cookie accordingly. Now we can fill our inventory with eight keys, which is more than enough! One last thing is to walk to the doors, unlock them with the keys and finally grab the flag! 🎉</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">hkcert22{cu7_4nd_p45t3_1ik3_4_3ng1n3er}</code></pre></div>

  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/catch-22-multiple-keys.png"   />
    
      <figcaption class="right" >One man with eight keys.</figcaption>
    
  </figure>



<h3 id="final-words">Final Words<a href="#final-words" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<p>There are a lot of possible ways to solve the challenge. These are some more weird game states that we crafted:</p>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/catch-22-too-many-doors.png"   />
    
      <figcaption class="right" >What can I do with so many doors?</figcaption>
    
  </figure>




  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/catch-22-no-keys-required.png"   />
    
      <figcaption class="right" >I teleported!</figcaption>
    
  </figure>




  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/catch-22-full-of-keys.png"   />
    
      <figcaption class="right" >This might be hard: The map is flooded with keys.</figcaption>
    
  </figure>



<div class="alert success">
  <strong>💭 More ideas?</strong> Can you solve the challenge in a different way? Let me know!
</div>


<h2 id="獅子山二號棒球場--base64-encryption-crypto">獅子山二號棒球場 / Base64 Encryption (Crypto)<a href="#獅子山二號棒球場--base64-encryption-crypto" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary-2">Challenge Summary<a href="#challenge-summary-2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p>People said that base64 is an encoding, not an encryption. Did they have a misconception about that?</p>

<p>If you believe that base64 is just an encoding, then convince me that you are able to &quot;decode&quot; the article (which is in English).</p>
</blockquote>

<p>We are given an 1198-byte message (in English) encoded in base64, except that the charset is shuffled (without a mapping given). The goal is to recover the message.</p>

<h3 id="solution-2">Solution<a href="#solution-2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<div class="alert success">
  💬 <strong>Presentation?</strong> Some of you may prefer to read slides rather than words. If that&rsquo;s the case, please refer to the <a href="/images/2022-12-24-hkcert-ctf/20221119-hkcert-ctf-writeup.pdf">slides</a> I used for <em>HKCERT&rsquo;s livestream</em> dated November 19, 2022.
</div>


<h4 id="part-i-conservation-of-characters-for-substitution-ciphers">Part I: Conservation of &quot;characters&quot; for substitution ciphers<a href="#part-i-conservation-of-characters-for-substitution-ciphers" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>In short, this is a substitution cipher to the character set <code>A-Za-z0-9+/</code>. Also, for substitution ciphers, each letter is encrypted into another letter.</p>

<div class="alert info">
  💡 <strong>Observation.</strong> If <code>A</code> is encrypted to <code>b</code>, then the numbers of <code>A</code>&rsquo;s in the plaintext and the numbers of <code>b</code>&rsquo;s in the ciphertext would be the same. This also happens to every message character $m$ that encrypts to $c$ &ndash; the numbers of $m$ in the plaintext and the number of $c$ in the ciphertext are the same.
</div>


<p>For substitution ciphers, we can look at the frequencies for every character to recover the key. Say, if <code>w</code> appears the most in the ciphertext, it is probably encrypted from <code>e</code> because <code>e</code> is the most used letter in the English language. Can we apply the same to base64 encoded messages? Yes!</p>

<p>I will take <a href="https://ocw.mit.edu/ans7870/6/6.006/s08/lecturenotes/files/t8.shakespeare.txt">t8.shakespeare.txt</a> as the ground truth. To get started, I encoded it with base64 (the message begins with <code>VGhpcyBpcyB0aGUgMTAwdGggRXRleHQgZmlsZSBwcmVzZ</code>). After that, I partitioned the message into four groups, where group one contains the $4k+1$<sup>th</sup> characters (i.e., <code>VccaMd...</code>) of the encoded message for $k \geq 0$; group two contains the $4k+2$<sup>th</sup> characters (i.e., <code>GyyGTG...</code>); and so on.</p>

<p>Why four groups? This is because base64 encodes a message into strings with sizes being a multiple of 4. For instance, the $4k+1$<sup>th</sup> encoded character comes from the six upper bits of the $3k+1$<sup>th</sup> byte. Those characters always depend on the six most significant bits from the source bytes.</p>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/base64-conversion.png"   />
    
      <figcaption class="right" >An example of base64 encoding. Source: <a href='https://en.wikipedia.org/wiki/Base64'>Wikipedia</a>.</figcaption>
    
  </figure>



<p>The bar charts are the distributions of the four groups. The distributions looked pretty different amongst these groups:</p>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/base64-encryption-frequency-shakespeare.png"   />
    
      <figcaption class="right" >Frequency distributions on base64-encoded Shakespeare's text, in four groups.</figcaption>
    
  </figure>



<h4 id="part-ii-frequency-analysis--the-first-take">Part II: Frequency analysis - The first take<a href="#part-ii-frequency-analysis--the-first-take" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>After that, we can look at the distribution of the ciphertexts. These are the ten most frequent characters in the ciphertext:</p>

<table>
    <thead>
        <tr>
            <th style="width: 20%;" rowspan=2>Character</th>
            <th style="width: 80%;" colspan=4>Frequency in group</th>
        </tr>
        <tr>
            <th style="width: 20%;">1</th>
            <th style="width: 20%;">2</th>
            <th style="width: 20%;">3</th>
            <th style="width: 20%;">4</th>
        </tr>
    </thead>
    <tbody>
        <tr><td><code>w</code></td><td style="text-align: right;">0.0%</td><td style="text-align: right;">20.5%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">0.25%</td></tr>
        <tr><td><code>Y</code></td><td style="text-align: right;">18.5%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">1.0%</td><td style="text-align: right;">0.0%</td></tr>
        <tr><td><code>c</code></td><td style="text-align: right;">0.0%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">18.05%</td><td style="text-align: right;">0.25%</td></tr>
        <tr><td><code>6</code></td><td style="text-align: right;">0.0%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">5.01%</td><td style="text-align: right;">12.53%</td></tr>
        <tr><td><code>R</code></td><td style="text-align: right;">16.0%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">0.0%</td></tr>
        <tr><td><code>W</code></td><td style="text-align: right;">0.0%</td><td style="text-align: right;">0.75%</td><td style="text-align: right;">0.5%</td><td style="text-align: right;">14.29%</td></tr>
        <tr><td><code>z</code></td><td style="text-align: right;">1.0%</td><td style="text-align: right;">12.75%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">0.0%</td></tr>
        <tr><td><code>V</code></td><td style="text-align: right;">9.25%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">4.01%</td><td style="text-align: right;">0.0%</td></tr>
        <tr><td><code>0</code></td><td style="text-align: right;">12.0%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">1.25%</td><td style="text-align: right;">0.0%</td></tr>
        <tr><td><code>L</code></td><td style="text-align: right;">11.5%</td><td style="text-align: right;">0.0%</td><td style="text-align: right;">0.75%</td><td style="text-align: right;">0.0%</td></tr>
    </tbody>
</table>

<p>Why do we care about the most frequent characters? Well... who cares if you misspelt once in 1000 words. But it matters when you misspelt once every two words.</p>

<p>Anyway, let's guess the character that encrypts to <code>w</code>. Maybe <code>I</code>? It appears the most from the base64-encoded Shakespeare's text. Apparently not. The frequencies of <code>I</code> from the four groups are respectively 23.9%, 0.0%, 1.3% and 0.3%, which is not similar to the frequencies of encrypted <code>w</code>. Instead, it looks more like <code>G</code>, which has frequencies (0.0%, 17.6%, 0.0%, 2.1%).</p>

<p>We then continue to find the best guess that encrypts to <code>Y</code>. It is likely to be <code>b</code>, because the frequencies of the ciphertext <code>Y</code> and the plaintext <code>b</code> are respectively (18.5%, 0.0%, 1.0%, 0.0%) and (13.6%, 0.0%, 0.0%, 0.04%). Repeating the process, we have the plaintext-ciphertext mapping below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Plaintext:  ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
Ciphertext: 4czfHjwa9rl+Xds/1EbFuJioVRnYL0ym86UZ2WDMQPgBKGT5AN3Cqe7OShpvkxIt</code></pre></div>
<p>&quot;Decrypting&quot; the ciphertext and decoding the whole message with base64, we have:</p>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/base64-result-1.png"   />
    
      <figcaption class="right" >Credit: Background image by rawpixel.com on Freepik</figcaption>
    
  </figure>



<p>...which is not good at all.</p>

<h4 id="part-iii-improving-the-heuristic">Part III: Improving the heuristic<a href="#part-iii-improving-the-heuristic" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>Since the article is written in English, it might be safe to assume that the ASCII code for all characters is in $[0, 128)$. The most significant bit for each byte is zero. When encoded in base64, the below bits are zero:</p>

<ul>
<li>the first bit in group 1,</li>
<li>the third bit in group 2, and</li>
<li>the fifth bit in group 3.</li>
</ul>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/base64-conversion-msb.png"   />
    
      <figcaption class="right" >Those bits in red are zero.</figcaption>
    
  </figure>



<p>What does it mean? We will never see <code>ghijklmnopqrstuvwxyz0123456789+/</code> in group 1. Likewise, <code>IJKLMNOPYZabcdefopqrstuv456789+/</code> and <code>CDGHKLOPSTWXabefijmnqruvyz2367+/</code> will not appear in groups 2 and 3 respectively. To avoid those characters in the respective groups, we can add a <em>huge</em> penalty when those characters are picked.</p>

<p>Previously, we expected that <code>Y</code> decrypts to <code>b</code> as they have similar distributions. However, <code>b</code> will appear in group 3 and thus this is not a good choice. <code>I</code> may be a better corresponding plaintext in this case - the distributions are similar, and we are not penalised by picking it. Below are the new mapping and the plaintext:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Plaintext:  ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
Ciphertext: 4czIHjwaYd8F1St/xEb7rJioV0+RLnygf6UGZWDMQPuBClqKAX35Te9ONhsv2mkp</code></pre></div>

  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/base64-result-2.png"   />
    
  </figure>



<h4 id="part-iv-finetuning-for-the-win">Part IV: Fine-tuning for the win<a href="#part-iv-finetuning-for-the-win" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>Although the article is still unreadable, we can read some words from it. There is a clear spelling mistake: Instead of <code>that hs</code>, it should instead be <code>that is</code>.</p>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/base64-result-3.png"   />
    
  </figure>



<p>When encoded in base64, they are respectively <code>...aGF0IGhz...</code> and <code>...aGF0IGlz...</code>. Let's make <code>W</code> and <code>6</code> decrypt to <code>h</code> and <code>l</code> respectively (they were corresponding to <code>l</code> and <code>h</code>). The article looked a bit better.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Plaintext:  ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
Ciphertext: 4czIHjwaYd8F1St/xEb7rJioV0+RLnygfWUGZ6DMQPuBClqKAX35Te9ONhsv2mkp</code></pre></div>
<p>We can fix the plaintext-ciphertext mapping by looking at the spelling mistakes. For instance, spaces should appear more frequently.</p>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/base64-result-4.png"   />
    
  </figure>



<p>Eventually, it is quite manual work to recover the final message:</p>


  <figure class="center" >
    <img src="/images/2022-12-24-hkcert-ctf/base64-result-5.png"   />
    
  </figure>



<h2 id="香港中文大學邵逸夫夫人樓--rogue-secret-assistant-crypto">香港中文大學邵逸夫夫人樓 / Rogue Secret Assistant (Crypto)<a href="#香港中文大學邵逸夫夫人樓--rogue-secret-assistant-crypto" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary-3">Challenge Summary<a href="#challenge-summary-3" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p>Mystiz does not seem to give up using RSA to store his secrets. This time you are even allowed to send arbitrary public exponent, <em>e</em>. Can you unveil the secret flag?</p>
</blockquote>

<p>When connected to the server, a 2048-bit RSA public exponent $n$ and a 128-character long secret are generated (none of them is given to the players). Players can send three different $e$ such that $e \neq 1$. The message</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">The secret token is [SECRET] and it is encrypted with e = [E].</code></pre></div>
<p>is encrypted using RSA with the key $(n, e)$. The goal is to recover the secret.</p>

<h3 id="solution-3">Solution<a href="#solution-3" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<h4 id="part-i-connection-of-the-unknowns-by-a-congruence">Part I: Connection of the unknowns by a congruence<a href="#part-i-connection-of-the-unknowns-by-a-congruence" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>Let $m_0$, $m_1$ and $m_2$ be the constant parts of the message, $s$ be the secret and $e_\text{c}$ be the public exponent in ASCII (and $l$ be its length). Then the message would be</p>

<p><span  class="math">\[m := 256^{l + 159} \cdot m_0 + 256^{l + 31} \cdot s + 256^{l + 1} \cdot m_1 + 256 \cdot e_\text{c} + m_2.\]</span></p>

<p>Hereby the base message, $m_0$, $m_1$ and $m_2$, are constants given below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># m0 = &#34;The secret token is &#34;</span>
m0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5468652073656372657420746f6b656e2069732</span>
<span style="color:#75715e"># m1 = &#34; and it is encrypted with e = &#34;</span>
m1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20616e6420697420697320656e6372797074656420776974682065203d20</span>
<span style="color:#75715e"># m2 = &#34;.&#34;</span>
m2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2e</span></code></pre></div>
<p>You can imagine that <code>m</code> is a concatenation of <code>The secret token is&nbsp;</code>, followed by the secret, <code>&nbsp;and it is encrypted with e =&nbsp;</code>, $e$ and a fullstop.</p>

<p>If we let further $c$ be the ciphertext of $m$, then $c \equiv m^e\ (\text{mod}\ n)$.</p>

<p>Since $\mu_{l, e} := 256^{l + 159} \cdot m_0 + 256^{l + 1} \cdot m_1 + 256 \cdot e_\text{c} + m_2$ is known (we know $l$, $m_0$, $m_1$, $m_2$ and $e_\text{c}$), we will just use $\mu_{l, e}$ for simplicity. Connecting the two relations, we have the congruence</p>

<p><span  class="math">\[c \equiv (\mu_{l, e} + 256^{l + 31} \cdot s)^e \ (\text{mod}\ n).\]</span></p>

<p>Now, how do we get $n$ and $s$ by sending three different $e$s (with $e \neq 1$)? These are the congruences we have (the variables in red are unknown):</p>

<p><span  class="math">\[\left\{\begin{aligned}
c_1 = (\mu_{l_1, e_1} + 256^{l_1 + 31} \cdot {\color{red}s})^{e_1} \ (\text{mod}\ {\color{red}n}) \\
c_2 = (\mu_{l_2, e_2} + 256^{l_2 + 31} \cdot {\color{red}s})^{e_2} \ (\text{mod}\ {\color{red}n}) \\
c_3 = (\mu_{l_3, e_3} + 256^{l_3 + 31} \cdot {\color{red}s})^{e_3} \ (\text{mod}\ {\color{red}n})
\end{aligned}\right.\]</span></p>

<h4 id="part-ii-recovering-the-unknowns">Part II: Recovering the unknowns<a href="#part-ii-recovering-the-unknowns" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>Fortunately, $e$ does not need to be positive. We can set $e_1 = -1$ (i.e., $l_1 = 2$ because <code>-1</code> is two-character long), then</p>

<p><span  class="math">\[\begin{aligned}
& c_1 = (\mu_{2, -1} + 256^{33} \cdot s)^{-1} \ (\text{mod}\ n) \\
\Longrightarrow \ & (\mu_{2, -1} + 256^{33} \cdot s) \cdot c_1 = 1 \ (\text{mod}\ n) \\
\Longrightarrow \ & s = \frac{1 - \mu_{2, -1} \cdot c_1}{256^{33} \cdot c_1} \ (\text{mod}\ n)
\end{aligned}\]</span></p>

<p>Substitute the above congruence to the remaining two (assuming $l_2 = l_3 = 2$ for simplicity), then for $i = 2, 3$, we have:</p>

<p><span  class="math">\[\begin{aligned}
& c_i \equiv (\mu_{2, e_i} + 256^{33} \cdot \frac{1 - \mu_{2, -1} \cdot c_1}{256^{33} \cdot c_1})^{e_i} \equiv (\mu_{2, e_i} + \frac{1 - \mu_{2, -1} \cdot c_1}{c_1})^{e_i} \ (\text{mod}\ n) \\
\Longrightarrow \ & c_i - (\mu_{2, e_i} + \frac{1 - \mu_{2, -1} \cdot c_1}{c_1})^{e_i} \equiv 0 \ (\text{mod}\ n)
\end{aligned}\]</span></p>

<p>Thus we have two multiples of $n$. By taking its GCD, then we can recover $n$... but wait, how can we divide without the modulus? We can do multiplication instead. Now we assume further that $e_2 = -2$ and $e_3 = -3$. For $i = 2, 3$:</p>

<p><span  class="math">\[\begin{aligned}
& c_i - (\mu_{2, e_i} + \frac{1 - \mu_{2, -1} \cdot c_1}{c_1})^{e_i} \equiv 0 \ (\text{mod}\ n) \\
\Longrightarrow \ & c_i \cdot (\mu_{2, e_i} + \frac{1 - \mu_{2, -1} \cdot c_1}{c_1})^{-e_i} - 1 \equiv 0 \ (\text{mod}\ n) \\
\Longrightarrow \ & c_i \cdot (\mu_{2, e_i} + \frac{1 - \mu_{2, -1} \cdot c_1}{c_1})^{-e_i} \cdot {c_1}^{-e_i} - {c_1}^{-e_i} \equiv 0 \ (\text{mod}\ n) \\
\Longrightarrow \ & c_i \cdot (\mu_{2, e_i} \cdot c_1 + 1 - \mu_{2, -1} \cdot c_1)^{-e_i} - {c_1}^{-e_i} \equiv 0 \ (\text{mod}\ n)
\end{aligned}\]</span></p>

<p>Therefore, we have the two numbers</p>

<p><span  class="math">\[c_2 \cdot (\mu_{2, -2} \cdot c_1 + 1 - \mu_{2, -1} \cdot c_1)^2 - {c_1}^2 \quad\text{and}\quad c_3 \cdot (\mu_{2, -3} \cdot c_1 + 1 - \mu_{2, -1} \cdot c_1)^3 - {c_1}^3,\]</span></p>

<p>which are both multiples of $n$. We can finally compute the GCD. Since the GCD of the two numbers are not necessarily equal to $n$ (it could be a <em>small</em> multiple of $n$), I attempted to remove small factors from the GCD in the solve script.</p>

<p>It is very unlikely that the <code>n</code> obtained is not equal to the actual public modulus. If that's the case, we can simply re-run the script. Eventually, we will get the flag: <code>hkcert22{r5a_i5_ju5t_a_6unch_0f_m4th5}</code>.</p>

<h3 id="solve-script">Solve script<a href="#solve-script" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> math <span style="color:#f92672">import</span> gcd
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

r <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;chal.hkcert22.pwnable.hk&#39;</span>, <span style="color:#ae81ff">28101</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(e):
    r<span style="color:#f92672">.</span>sendline(str(e)<span style="color:#f92672">.</span>encode())
    r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;c = &#39;</span>)
    c <span style="color:#f92672">=</span> int(r<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>decode(), <span style="color:#ae81ff">16</span>)
    <span style="color:#66d9ef">return</span> c

c1, c2, c3 <span style="color:#f92672">=</span> encrypt(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>), encrypt(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>), encrypt(<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>)

µ1 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;The secret token is &#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">128</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; and it is encrypted with e = -1.&#39;</span>
µ2 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;The secret token is &#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">128</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; and it is encrypted with e = -2.&#39;</span>
µ3 <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;The secret token is &#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">128</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; and it is encrypted with e = -3.&#39;</span>

µ1, µ2, µ3 <span style="color:#f92672">=</span> [int<span style="color:#f92672">.</span>from_bytes(µ, <span style="color:#e6db74">&#39;big&#39;</span>) <span style="color:#66d9ef">for</span> µ <span style="color:#f92672">in</span> [µ1, µ2, µ3]]

n <span style="color:#f92672">=</span> gcd(
    c2 <span style="color:#f92672">*</span> (µ2 <span style="color:#f92672">*</span> c1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> µ1 <span style="color:#f92672">*</span> c1)<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> c1<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>,
    c3 <span style="color:#f92672">*</span> (µ3 <span style="color:#f92672">*</span> c1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> µ1 <span style="color:#f92672">*</span> c1)<span style="color:#f92672">**</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">-</span> c1<span style="color:#f92672">**</span><span style="color:#ae81ff">3</span>
)
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>n <span style="color:#e6db74">= }</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#75715e"># Eliminate small factors</span>
<span style="color:#66d9ef">for</span> k <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1000</span>):
    <span style="color:#66d9ef">while</span> n <span style="color:#f92672">%</span> k <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        n <span style="color:#f92672">//=</span> k

secret <span style="color:#f92672">=</span> pow(<span style="color:#ae81ff">256</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">33</span>, n) <span style="color:#f92672">*</span> (pow(c1, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, n) <span style="color:#f92672">-</span> µ1) <span style="color:#f92672">%</span> n
<span style="color:#66d9ef">assert</span> secret <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span><span style="color:#f92672">**</span><span style="color:#ae81ff">128</span>
secret <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>to_bytes(secret, <span style="color:#ae81ff">128</span>, <span style="color:#e6db74">&#39;big&#39;</span>)
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>secret <span style="color:#e6db74">= }</span><span style="color:#e6db74">&#39;</span>)
r<span style="color:#f92672">.</span>sendline(secret)

r<span style="color:#f92672">.</span>interactive()</code></pre></div>
      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://mystiz.hk/posts/2022/2022-12-24-hkcert-ctf-2/">
                <span class="button__icon">←</span>
                <span class="button__text">HKCERT CTF 2022 Postmortem (II): Harder Crypto Challenges</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://mystiz.hk/posts/2022/2022-10-19-h4ck1ng-g00gl3/">
                <span class="button__text">H4CK1NG G00GL3 - Ep 005 Ch 002: Project Zero Adventure</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>


<aside class="toc-container">
  <a href="#" style="text-decoration: none; font-weight: 700;">
    HKCERT CTF 2022 Postmortem (I): Easier Crypto Challenges
  </a>
  <div class="js-toc"></div>
</aside>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.css" integrity="sha512-SFw7k74K3983tyOlJIHa8atr9Ppef3Kix5cmifwzU7ZdtU2E0FRuOVRtd3ENpMJ8sNCie5hlb/0j23efcdQJXA==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.js" integrity="sha512-oD3xGN8YTxenx6tdS4D/RKqO4OtORBQtAb2/FseM17GGMIi6jMwKUBc8duX4A5RwMOGGXoFBZrsqbOk8GpXFgQ==" crossorigin="anonymous"></script>

<script type="text/javascript">
  tocbot.init({
      headingSelector: 'h1, h2, h3, h4',
      orderedList: false,
      headingLabelCallback: s => s.substr(0, s.length-2),
      collapseDepth: 2
  });
</script>



  </div>
  <aside class="ads">
    
  
  <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-3220069814773012"
    data-ad-slot="6927401005"
    data-ad-format="auto"
    data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>


  </aside>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2023 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://mystiz.hk/assets/main.js"></script>
<script src="https://mystiz.hk/assets/prism.js"></script>






<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }], trust: true })"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
<script>
var viz = new Viz();

document.querySelectorAll("[class=graphviz]").forEach(node => {
  const escape = function (s) {
    const t = s.replace(/&amp;/g, '&')
    return t.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&#34;/g, '"')
  }
  viz.renderSVGElement(escape(node.innerText), {
    engine: 'dot'
  }).then(function (element) {
    node.parentNode.appendChild(element)
    node.style.display = 'none'
  })
})
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({
    startOnLoad: true,
    htmlLabels: true,
    securityLevel: "loose",
    theme: 'base',
    themeVariables: {
        background: '#22222c',
        primaryColor: '#33333c',
        primaryTextColor: '#ffe4e1',
    }
});
</script>

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2VLBDVW913"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2VLBDVW913');
</script>



  
</div>

</body>
</html>
