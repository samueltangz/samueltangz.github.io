<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Aero CTF 2021 Writeup :: Mystify</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This time I am playing alone for @blackb6a and had all the crypto challenges solved (and nothing else). I found the crypto challenges in many of the CTFs this year are worth-trying, and these are no exceptions. I ended up at the 9th place. By the way, @SuperGuesser is the first to solve for all of the crypto challenges. Can we nerf @RBTree_ and @rkm0959?
Additionally, phoenix had seven solves and while horcrux and boggart had two." />
<meta name="keywords" content="ctf" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://mystiz.hk/posts/2021/2021-02-28-aeroctf/" />




<link rel="stylesheet" href="https://mystiz.hk/assets/style.css">

  <link rel="stylesheet" href="https://mystiz.hk/assets/mystiz.css">






<link rel="apple-touch-icon" href="https://mystiz.hk/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://mystiz.hk/img/favicon/mystiz.png">





<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://mystiz.hk/images/2021-02-28-aeroctf/scoreboard.png" />


  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="mystiz613" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Aero CTF 2021 Writeup">
<meta property="og:description" content="This time I am playing alone for @blackb6a and had all the crypto challenges solved (and nothing else). I found the crypto challenges in many of the CTFs this year are worth-trying, and these are no exceptions. I ended up at the 9th place. By the way, @SuperGuesser is the first to solve for all of the crypto challenges. Can we nerf @RBTree_ and @rkm0959?" />
<meta property="og:url" content="https://mystiz.hk/posts/2021/2021-02-28-aeroctf/" />
<meta property="og:site_name" content="Mystify" />

  <meta property="og:image" content="https://mystiz.hk/images/2021-02-28-aeroctf/scoreboard.png">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2021-02-28 19:35:00 &#43;0800 &#43;0800" />












  <script data-ad-client="ca-pub-3220069814773012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>


</head>
<body class="mystiz">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Mystify
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about-me">About Me</a></li>
        
      
        
          <li><a href="/blogroll">Blogroll</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">Show more ▾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/crypto-in-ctf">Crypto in CTF</a></li>
              
            
          </ul>
        </ul>
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about-me">About Me</a></li>
      
    
      
        <li><a href="/blogroll">Blogroll</a></li>
      
    
      
        <li><a href="/crypto-in-ctf">Crypto in CTF</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://mystiz.hk/posts/2021/2021-02-28-aeroctf/">Aero CTF 2021 Writeup</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2021-02-28 
      </span>
    
    
    <span class="post-author">:: Mystiz</span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://mystiz.hk/tags/ctf/">ctf</a>&nbsp;
    
    #<a href="https://mystiz.hk/tags/aero-ctf/">aero-ctf</a>&nbsp;
    
    #<a href="https://mystiz.hk/tags/crypto/">crypto</a>&nbsp;
    
  </span>
  

  

  
    <img src="https://mystiz.hk/images/2021-02-28-aeroctf/scoreboard.png" class="post-cover center" alt="Aero CTF 2021 Writeup" />
  

  <div class="post-content js-toc-content"><div>
        <p>This time I am playing alone for <a href="https://twitter.com/blackb6a" target="_blank" rel="nofollow">@blackb6a</a> and had all the crypto challenges solved (and nothing else). I found the crypto challenges in many of the CTFs this year are worth-trying, and these are no exceptions. I ended up at the 9th place. By the way, <a href="https://twitter.com/SuperGuesser" target="_blank" rel="nofollow">@SuperGuesser</a> is the first to solve for <em>all</em> of the crypto challenges. Can we nerf <a href="https://twitter.com/RBTree_" target="_blank" rel="nofollow">@RBTree_</a> and <a href="https://twitter.com/rkm0959" target="_blank" rel="nofollow">@rkm0959</a>?</p>

<p>Additionally, <em>phoenix</em> had seven solves and while <em>horcrux</em> and <em>boggart</em> had two. I think they deserved more solves. You can read a better writeup by the <em>super guessers</em> on <a href="https://rkm0959.tistory.com/211">rkm0959's blog</a>.</p>

<h2 id="horcrux">horcrux<a href="#horcrux" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary">Challenge Summary<a href="#challenge-summary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p>Imagine that you are a dark wizard (as dark as Voldemort). And you want to reach immortality.</p>

<p>What could be your plan?</p>

<p>Author: keltecc (Discord)</p>
</blockquote>

<p>We are given <code>horcrux.py</code> and <code>output.txt</code>. Suppose that there is a 3000-bit prime $p$ and three points on the elliptic curve $\mathcal{C}$ over $\text{GF}(p)$, namely, $G, P=(x_P, y_P)$ and $Q=(x_Q, y_Q)$. Let's denote $\tilde{P}=(\tilde{x}_P, \tilde{y}_P)$ and $\tilde{Q}=(\tilde{x}_Q, \tilde{y}_Q)$ and the errors $0 \leq \varepsilon_i &lt; 2^{32}$ for $i = 1, 2, 3, 4$ by</p>

<p><span  class="math">\[\varepsilon_1 = \tilde{x}_P\oplus x_P, \varepsilon_2 = \tilde{y}_P\oplus y_P, \varepsilon_3 = \tilde{x}_Q\oplus x_Q, \varepsilon_4 = \tilde{y}_Q\oplus y_Q.\]</span></p>

<p>In the challenge, we are given the prime $p, G, \tilde{P}$ and $\tilde{Q}$. The objective is to find $\varepsilon_i$'s which are used as a key to encrypt the flag.</p>

<p>In short, we are given three points on an elliptic curve $\mathcal{C}$. However there are <em>small</em> errors on two of them, making them not lying on the curve. The objective is to fix the errors for these points.</p>

<h3 id="solution">Solution<a href="#solution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<h4 id="part-i-working-on-the-math-part">Part I: Working on the math part<a href="#part-i-working-on-the-math-part" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<div class="alert info">
  <strong>Note.</strong> The operations are done over $\text{GF}(p)$. I won&rsquo;t mention mod <em>p</em> for simplicity.
</div>


<p>My approach is <em>really</em> tedious. Suppose that $\mathcal{C}: y^2 = x^3 + ax + b$. Then by definition,</p>

<p><span  class="math">\[
\begin{cases}\begin{aligned}
{y_G}^2 = {x_G}^3 + a{x_G} + b \\
{y_P}^2 = {x_P}^3 + a{x_P} + b \\
{y_Q}^2 = {x_Q}^3 + a{x_Q} + b \\
\end{aligned}\end{cases}.
\]</span></p>

<p>To begin, let's define $e_1 = x_P - \tilde{x}_P$, $e_2 = y_P - \tilde{y}_P$, $e_3 = x_Q - \tilde{x}_Q$ and $e_4 = y_Q - \tilde{y}_Q$.</p>

<div class="alert warning">
  <strong>Why using $e_i$&rsquo;s but not $\varepsilon_i$&rsquo;s those we defined?</strong> We would not use $\varepsilon_i$&rsquo;s since they involve <em>xor</em> operations. We don&rsquo;t know how to do it on elliptic curves.
</div>


<p>We can first eliminate $a$ and $b$ by combining the three equations like below. You can refer to <a href="/posts/2020/2020-07-22-uiuctf-nookcrypt/#part-i-recovering-the-curve-parameters-in-a-stupid-way">my writeup</a> for nookcrypt in UIUCTF for more details.</p>

<p><span  class="math">\[(y_G^2 - y_P^2 - x_G^3 + x_P^3)(x_G - x_Q) = (y_G^2 - y_Q^2 - x_G^3 + x_Q^3)(x_G - x_P).\]</span></p>

<p>Furthermore, we can substitute the $e_i$'s:</p>

<p><span  class="math">\[\begin{aligned}
& \left[y_G^2 - (\tilde{y}_P + e_2)^2 - x_G^3 + (\tilde{x}_P + e_1)^3\right]\left[x_G - (\tilde{x}_Q + e_3)\right] \\
& = \left[y_G^2 - (\tilde{y}_P + e_4)^2 - x_G^3 + (\tilde{x}_Q + e_3)^3\right]\left[x_G - (\tilde{x}_P + e_1)\right].
\end{aligned}\]</span></p>

<div class="alert info">
  <strong>What was my motivation?</strong> I tried to minimize the <em>entropy</em> by eliminating the 3000-bit unknowns, i.e., $a, b, x_P, y_P, x_Q$ and $y_Q$. I am either removing them by combining equations, or reducing the entropy by replacing them with smaller ones.
</div>


<h4 id="part-ii-retrieving-eis-via-lll">Part II: Retrieving $e_i$'s via LLL<a href="#part-ii-retrieving-eis-via-lll" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>I have to stress again that my approach is pretty tedious. What I did is to expand everything. The <em>unknowns</em> are marked in yellow. Also, the overbraces and the underbraces are their entropies.</p>

<p><span  class="math">\[\begin{aligned}
& [(y_G^2 - {\tilde{y}_P}^2 - x_G^3 + {\tilde{x}_P}^3) - \overbrace{2{\tilde{y}_P}\htmlStyle{color: yellow;}{e_2}}^{\text{32b}} - \overbrace{\htmlStyle{color: yellow;}{e_2}^2}^{\text{64b}} + \overbrace{3{\tilde{x}_P}^2\htmlStyle{color: yellow;}{e_1}}^{\text{32b}} + \overbrace{3{\tilde{x}_P}\htmlStyle{color: yellow;}{e_1}^2}^{\text{64b}} + \overbrace{\htmlStyle{color: yellow;}{e_1}^3}^{\text{96b}}][(x_G - \tilde{x}_Q) - \overbrace{\htmlStyle{color: yellow;}{e_3}}^{\text{32b}}] \\
& = [(y_G^2 - {\tilde{y}_Q}^2 - x_G^3 + {\tilde{x}_Q}^3) - \underbrace{2{\tilde{y}_Q}\htmlStyle{color: yellow;}{e_4}}_{\text{32b}} - \underbrace{\htmlStyle{color: yellow;}{e_4}^2}_{\text{64b}} + \underbrace{3{\tilde{x}_Q}^2\htmlStyle{color: yellow;}{e_3}}_{\text{32b}} + \underbrace{3{\tilde{x}_Q}\htmlStyle{color: yellow;}{e_3}^2}_{\text{64b}} + \underbrace{\htmlStyle{color: yellow;}{e_3}^3}_{\text{96b}}][(x_G - \tilde{x}_P) - \underbrace{\htmlStyle{color: yellow;}{e_1}}_{\text{32b}}].
\end{aligned}\]</span></p>

<p>Well, I am not done. Please bear with me. There are 12 terms on the both sides if they are expanded while grouped by $e_i$'s. The number of bits of entropy on one side is $(0 + 32 + 64 + 32 + 64 + 96) + (32 + 64 + 96 + 64 + 96 + 128) = 768$. Since the total entropy is $768 \times 2 = 1536 &lt; 3000$ bits, we can recover the whole thing with LLL.</p>

<p>We can construct a $25\times 25$ matrix. This is how I do it in Sagemath.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">multiplier  <span style="color:#f92672">=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">128</span>]
multiplier <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>]
multiplier <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">0</span>]
multiplier <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>]
multiplier <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">0</span>]

T <span style="color:#f92672">=</span> diagonal_matrix(multiplier)
A <span style="color:#f92672">=</span> Matrix(<span style="color:#ae81ff">25</span>)

A[ <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> ((Gy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> aPy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> (Gx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">-</span> aPx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span>)) <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> ((Gy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> aPy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> (Gx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">-</span> aPx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span>))
A[ <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> aPy <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> aPy
A[ <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
A[ <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aPx<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aPx<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>
A[ <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aPx <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aPx
A[<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (Gx <span style="color:#f92672">-</span> aQx)
A[<span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

A[<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>((Gy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> aQy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> (Gx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">-</span> aQx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span>)) <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>((Gy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> aQy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> (Gx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">-</span> aQx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span>))
A[<span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> aQy <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> aQy
A[<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>(Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">17</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
A[<span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aQx<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aQx<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>
A[<span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aQx <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aQx
A[<span style="color:#ae81ff">22</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>(Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">23</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">24</span>):
    A[i, i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

A[<span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> p
A <span style="color:#f92672">=</span> A <span style="color:#f92672">*</span> T
B <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>LLL()
B <span style="color:#f92672">=</span> B <span style="color:#f92672">/</span> T

<span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> B:
    <span style="color:#66d9ef">if</span> row[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>: <span style="color:#66d9ef">continue</span>
    <span style="color:#66d9ef">if</span> row[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>: row <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>row
    <span style="color:#66d9ef">if</span> row[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>: <span style="color:#66d9ef">continue</span>
    
    dPx <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">14</span>] <span style="color:#75715e"># e1</span>
    dPy <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">3</span>]  <span style="color:#75715e"># e2</span>
    dQx <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">2</span>]  <span style="color:#75715e"># e3</span>
    dQy <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">15</span>] <span style="color:#75715e"># e4</span>
    
    print(<span style="color:#e6db74">&#39;dP =&#39;</span>, (dPx, dPy))
    print(<span style="color:#e6db74">&#39;dQ =&#39;</span>, (dQx, dQy))
    <span style="color:#75715e"># dP = (1155305281, 62177711)</span>
    <span style="color:#75715e"># dQ = (1076744709, 30259545)</span>
    print()</code></pre></div>
<p>However, I have the parity messed up. Trying $(e_1, e_2, e_3, e_4)$, $(e_1, e_2, e_3, -e_4)$, ... and compute for the respective $a$ and $b$, we have a correct value for $e_i$'s:</p>

<p><span  class="math">\[(e_1, e_2, e_3, e_4) = (1155305281, -62177711, 1076744709, -30259545).\]</span></p>

<p>After all, we can derive $\varepsilon_i$'s</p>

<p><span  class="math">\[(\varepsilon_1, \varepsilon_2, \varepsilon_3, \varepsilon_4) = (3168768961, 2085996465, 3254637063, 36849519)\]</span></p>

<p>and thus have the key to decrypt the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Aero{&#34;Voldemort,&#34; said Riddle softly, &#34;is my past, present, and future, Harry Potter....&#34;}</code></pre></div>
<h3 id="addendum">Addendum<a href="#addendum" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<p><a href="https://twitter.com/keltecc" target="_blank" rel="nofollow">@keltecc</a> (the challenge author) and <a href="https://twitter.com/hellman1908" target="_blank" rel="nofollow">@hellman1908</a> had a similar approach as above. Meanwhile they need not to expand the polynomial by themselves.</p>

<ul>
<li><em>keltecc</em> wrote a function to handles the monomials. <a href="https://github.com/AeroCTF/aero-ctf-2021/blob/main/ideas/crypto/horcrux/solver.sage#L122">Link here</a>.</li>
<li><em>hellman</em> used resultants to deal with it. From his write-up, the size of unknown is 1408 bits. Since I have not group the terms, the unknown size is larger (1536 bits). <a href="https://nbviewer.jupyter.org/gist/hellman/a8c9a09b1ce6959226f9d75cf94b805f">Link here</a>.</li>
</ul>

<p>Thanks to <em>vishiswoz</em> who pointed out that the mistakes that I made when defining the <em>multipliers</em>. Since the amount of unknown bits are small (1536 bits) relatively to the size of the known bits (3000 bits), they did not affect the results. This is the patched lattice (with parity fixed, too):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">multiplier  <span style="color:#f92672">=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">128</span>]
multiplier <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>]
multiplier <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">0</span>]
multiplier <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>]
multiplier <span style="color:#f92672">+=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">96</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">0</span>]

T <span style="color:#f92672">=</span> diagonal_matrix(multiplier)
A <span style="color:#f92672">=</span> Matrix(<span style="color:#ae81ff">25</span>)

A[ <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> ((Gy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> aPy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> (Gx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">-</span> aPx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span>)) <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>((Gy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> aPy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> (Gx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">-</span> aPx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span>))
A[ <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> aPy <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> aPy
A[ <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>(Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
A[ <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aPx<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aPx<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>
A[ <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aPx <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aQx)
A[ <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aPx
A[<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (Gx <span style="color:#f92672">-</span> aQx)
A[<span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>

A[<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>((Gy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> aQy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> (Gx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">-</span> aQx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span>)) <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> ((Gy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> aQy<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>) <span style="color:#f92672">-</span> (Gx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">-</span> aQx<span style="color:#f92672">^</span><span style="color:#ae81ff">3</span>))
A[<span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> aQy <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> aQy
A[<span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">17</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
A[<span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aQx<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aQx<span style="color:#f92672">^</span><span style="color:#ae81ff">2</span>
A[<span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aQx <span style="color:#f92672">*</span> (Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> aQx
A[<span style="color:#ae81ff">22</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>(Gx <span style="color:#f92672">-</span> aPx)
A[<span style="color:#ae81ff">23</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">24</span>):
    A[i, i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

A[<span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> p
A <span style="color:#f92672">=</span> A <span style="color:#f92672">*</span> T
B <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>LLL()
B <span style="color:#f92672">=</span> B <span style="color:#f92672">/</span> T

<span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> B:
    <span style="color:#66d9ef">if</span> row[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>: <span style="color:#66d9ef">continue</span>
    <span style="color:#66d9ef">if</span> row[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>: row <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>row
    <span style="color:#66d9ef">if</span> row[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>: <span style="color:#66d9ef">continue</span>
    
    dPx <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">14</span>] <span style="color:#75715e"># e1</span>
    dPy <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">3</span>]  <span style="color:#75715e"># e2</span>
    dQx <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">2</span>]  <span style="color:#75715e"># e3</span>
    dQy <span style="color:#f92672">=</span> row[<span style="color:#ae81ff">15</span>] <span style="color:#75715e"># e4</span>

    print(<span style="color:#e6db74">&#39;dP =&#39;</span>, (dPx, dPy))
    print(<span style="color:#e6db74">&#39;dQ =&#39;</span>, (dQx, dQy))
    <span style="color:#75715e"># dP = (1155305281, -62177711)</span>
    <span style="color:#75715e"># dQ = (1076744709, -30259545)</span>
    print()</code></pre></div>
<h2 id="phoenix">phoenix<a href="#phoenix" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary-1">Challenge Summary<a href="#challenge-summary-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p>If you want to become a member of the Order of the Phoenix, you need to:</p>

<ul>
<li>be able to perfectly control the magic wand</li>
<li>be able to crack the following cipher</li>
</ul>

<p>...but maybe some of this is not needed</p>

<p>Author: keltecc (Discord)</p>
</blockquote>

<div class="alert info">
  <strong>Note:</strong> This time, we are working on $\text{GF}(2^{256})$. $+$ is equivalent to XOR now.
</div>

<p>We are given two polynomials over $A(x)$ and $B(x)$ over $\text{GF}(2^{256})$ with the polynomial $x^{256} + x^{10} + x^5 + x^2 + 1$. A key $\kappa(x)$ is also generated while kept secret. Suppose that we want to encrypt a message $(m_1, m_2, ..., m_l) \in \mathbb{Z}_2^l$. To encrypt the $i$<sup>th</sup> bit, we</p>

<ul>
<li>compute $R_i(x)$ given by</li>
</ul>

<p><span  class="math">\[R_i(x) := [A(x)]^k \kappa(x) + B(x) = r_{i0} + r_{i1}x + r_{i2}x^2 + ... + r_{i,255}x^{255},\]</span></p>

<ul>
<li>then, compute the $i$<sup>th</sup> bit of ciphertext, $c_i$, by</li>
</ul>

<p><span  class="math">\[c_i := m_i + (r_{i0} + r_{i2} + r_{i4} + r_{i6} + r_{i8}) + r_{i1} r_{i3} r_{i5} r_{i7} r_{i9}.\]</span></p>

<p>The objective is to find the key $\kappa(x)$, given a ciphertext $(c_1, c_2, ..., c_{1024})$ and knowing that $m_1 = m_2 = ... = m_{768} = 0$.</p>

<h3 id="solution-1">Solution<a href="#solution-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<p>$m_1 = m_2 = ... = m_{768} = 0$ is pretty suspicious. We know that for $i = 1, 2, ..., 768$,</p>

<p><span  class="math">\[c_i = r_{i0} + r_{i2} + r_{i4} + r_{i6} + r_{i8} + r_{i1} r_{i3} r_{i5} r_{i7} r_{i9}.\]</span></p>

<p>Since the probability for $r_{i1} r_{i3} r_{i5} r_{i7} r_{i9} = 1$ is only 1/32, we can approximate $c_i$ with</p>

<p><span  class="math">\[\tilde{c_i} = r_{i0} + r_{i2} + r_{i4} + r_{i6} + r_{i8}.\]</span></p>

<p>It is expected that $c_i = \tilde{c_i}$ for most of the cases. If we can express $R_i(x)$ in terms of $\kappa(x) := k_0 + k_1 x + ... + k_{255}x^{255}$, we have a set of simultaneous linear equations in terms of $k_i$'s, while around 24 of the equations are incorrect. Since there are 256 unknowns (i.e., $k_0, k_1, ..., k_{255}$), I am picking 256 equations from $c_i = \tilde{c_i}$ and hoped all of them are correct. The chances are not that low - it is $\left(\frac{31}{32}\right)^{256} \approx 0.000295$, which is around one in 3400. We can identify the correct solution by checking the number of equations with $c_i = \tilde{c_i}$. If it is correct, then there will be around 744 $i$'s satisfying the condition. Otherwise, there are only about 512. Eventually I have the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Aero{n1c3_ISD_4tt4ck_g00d_j0b!!}</code></pre></div>
<h2 id="boggart">boggart<a href="#boggart" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>

<h3 id="challenge-summary-2">Challenge Summary<a href="#challenge-summary-2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<blockquote>
<p>Welcome to another Defence Against the Dark Arts lesson.</p>

<p>Today I will show you a new powerful charm — Riddikulus. Enjoy!</p>

<p><code>nc 151.236.114.211 17101</code></p>

<p>Author: keltecc (Discord)</p>
</blockquote>

<p>There is a netcat service available in this challenge. We can get four numbers each time we connect: a modulus $n$, a mask $\sigma$, and a pair of ciphertexts $c_1$ and $c_2$. $c_1$ is encrypted by the known message <code>the boy who lived</code>, while $c_2$ is the encrypted flag. The modulus is a product of two primes $p$ and $q$. This time $p := \text{NextPrime}(\sigma\ |\ \Delta p)$ and $q := \text{NextPrime}(\sigma\ |\ \Delta q)$.</p>

<p>However, it performs 16 rounds of encryption algorithm $\mathcal{E}$. $\mathcal{E}$ looks man-made, which is a combination of <em>RSA</em> and <em>Lucas sequence</em>. Let's annotate the attachment <code>boggart.py</code> a bit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Wardrobe</span>:
    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_boggarts</span>(fear, danger):
        <span style="color:#75715e"># Return an array of public exponents</span>
        <span style="color:#66d9ef">while</span> danger <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
            fear <span style="color:#f92672">=</span> next_prime(fear)

            <span style="color:#66d9ef">if</span> getrandbits(<span style="color:#ae81ff">1</span>):
                <span style="color:#66d9ef">yield</span> fear
                danger <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Wizard</span>:
    <span style="color:#66d9ef">def</span> __init__(self, magic, year, experience):
        self<span style="color:#f92672">.</span>magic <span style="color:#f92672">=</span> magic           <span style="color:#75715e"># self.magic = n, the public modulus</span>
        self<span style="color:#f92672">.</span>knowledge <span style="color:#f92672">=</span> year <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>    <span style="color:#75715e"># self.knowledge = 2</span>
        self<span style="color:#f92672">.</span>experience <span style="color:#f92672">=</span> experience <span style="color:#75715e"># self.experience = message</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cast_riddikulus</span>(self, boggart):
        <span style="color:#75715e"># Encrypt the message, m, with the public exponent.</span>
        knowledge, experience <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>knowledge, self<span style="color:#f92672">.</span>experience

        <span style="color:#66d9ef">while</span> boggart <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
            knowledge, experience <span style="color:#f92672">=</span> experience, (experience <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>experience <span style="color:#f92672">-</span> knowledge) <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>magic
            boggart <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>

        self<span style="color:#f92672">.</span>experience <span style="color:#f92672">=</span> experience

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    <span style="color:#75715e"># ...omitted</span>

    harry_potter <span style="color:#f92672">=</span> Wizard(magic, year, bytes_to_long(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;the boy who lived&#39;</span>))
    you <span style="color:#f92672">=</span> Wizard(magic, year, bytes_to_long(flag))

    <span style="color:#75715e"># Perform 16 rounds of encryption</span>
    <span style="color:#66d9ef">for</span> boggart <span style="color:#f92672">in</span> Wardrobe<span style="color:#f92672">.</span>create_boggarts(boggart_fear, boggart_danger):
        harry_potter<span style="color:#f92672">.</span>cast_riddikulus(boggart)
        you<span style="color:#f92672">.</span>cast_riddikulus(boggart)

    <span style="color:#75715e"># ...omitted</span></code></pre></div>
<h3 id="solution-2">Solution<a href="#solution-2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>

<h4 id="part-i-factoring-n-with-sigma">Part I: Factoring $n$ with $\sigma$<a href="#part-i-factoring-n-with-sigma" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>I don't have any directions to begin with. Let's try to factorize $n$ first. Since there is a netcat service this time, we can be more picky on the numbers. For instance, we can find $\sigma$ such that their set bits are evenly spaced. Also, we can assume that the set bits for $\sigma$ are also set for $p$ and $q$ (except the least 20 bits). Denote $S = (s_1, s_2, ..., s_k)$ with $s_1 &lt; s_2 &lt; ... &lt; s_k$ are the set bits of $\sigma$, i.e., we have $\sigma = 2^{s_1} + 2^{s_2} + ... + 2^{s_k}$. Let's look at the algorithm I could think of.</p>

<p><strong>[Initialize]</strong> Let's pick the smallest $j$ such that $s_j \geq 20$. Initialize the set $F_j$ by</p>

<p><span  class="math">\[F_j := \left\{(p, q) \in \mathbb{Z}^2\ |\ pq \equiv n\ (\text{mod}\ 2^{s_j}) \right\}\]</span></p>

<p>What is this $F$? Ideally, I would like to maintain a set $F$ such that every $(p, q) \in F$ satisfies $pq \equiv 1\ (\text{mod}\ 2^s)$ (for a given $s$), while $p$ and $q$ having the set bits $\sigma$ had.</p>

<div class="alert info">
  <strong>Why $s_j \geq 20$?</strong> The set bits for $\sigma$ may not be set in $\text{NextPrime}(\sigma\ | \Delta p)$ because of carrying. In this case, I assumed that the carrying did not go too far.
</div>


<p><strong>[Update]</strong> We can define $F_i$ for $i = j+1, j+2, ..., k$ with the below algorithm.</p>

<ol>
<li>Initialize $F_i = \phi$, the empty set.</li>
<li>For each $(p_1, q_1) \in \mathbb{Z}^2$:

<ul>
<li>Exhaust $0 \leq u, v \le 2^{s_i}$ with $2^{s_{i-1}+1}\ |\ u$ and $2^{s_{i-1}+1}\ |\ v$.</li>
<li>Write $p_2 = p_1 + u + 2^{s_i}$ and $q_2 = q_1 + v + 2^{s_i}$ (Note: they have the $s_i$<sup>th</sup> bit set).</li>
<li>If $n \equiv p_2q_2\ (\text{mod}\ 2^{s_i})$, then update $F_i \leftarrow F_i \cup {(p_2, q_2)}$.</li>
</ul></li>
</ol>

<p><strong>[Finalize]</strong> For each $(p_1, q_1)$ in $F_k$,</p>

<ol>
<li>Exhaust $0 \leq u, v &lt; 2^{512}$ with $2^{s_k+1}\ |\ u$ and $2^{s_k+1}\ |\ v$.</li>
<li>Write $p_2 = p_1 + u + 2^{s_k}$ and $q_2 = q_1 + v + 2^{s_k}$.</li>
<li>If $n = p_2q_2$, then $p_2$ and $q_2$ are the prime factors for $n$.</li>
</ol>

<p>If you are interested, just have a look at <a href="https://gist.github.com/samueltangz/0f1da2de136bb89ef79858f590d9a8f4">the gist</a> on factoring $n$. Below is the $n$ I retrieved and the corresponding $p$ and $q$. There is a paper<sup class="footnote-ref" id="fnref:n-partial-info-1"><a class="footnote" href="#fn:n-partial-info-1">1</a></sup> (and its corresponding slides<sup class="footnote-ref" id="fnref:n-partial-info-2"><a class="footnote" href="#fn:n-partial-info-2">2</a></sup>) more tricks to factor $n$ given partial information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">n = 40740327153595270257184780086389953086261120133330698714430641164791044793765728073225136444807495004396268705143115221155717342774153766221474052678956440685995627998728286518422095251317829948639280532042852083900018149268443333895256994879066082385467247811575697036554762935124165948190148187259065768291
p = 6599104293714145478554177176803578568990396482282918390864510364381920295952993884789163942979610791954293100727323403846729255137773392428824686146334083
q = 6173614681677589793159076464182384333359578951775387735487730852029780858970587865352547693301144847551051384110518957280217521699817523617984210590793377</code></pre></div>
<div class="alert warning">
  <strong>An afterthought.</strong> My algorithm is pretty slow, and it could be sped up by computing $q_2$ from $p_2$ (instead of iterating them) on <em>update</em> and <em>finalize</em>. The complexity for each set update would be $\mathcal{O}(2^{s_{i+1} - s_i})$ instead of $\mathcal{O}(4^{s_{i+1} - s_i})$.
</div>


<h4 id="part-ii-identifying-the-cryptosystem-and-solving-for-the-flag">Part II: Identifying the cryptosystem and solving for the flag<a href="#part-ii-identifying-the-cryptosystem-and-solving-for-the-flag" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>

<p>Although I have $n$ factorized, I don't even how it helps. Maybe we shall investigate how $\mathcal{E}$ works. Let's look at the <code>Wizard</code> class, where <code>cast_riddikulus</code> is essentially the encryption function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Wizard</span>:
    <span style="color:#66d9ef">def</span> __init__(self, magic, year, experience):
        self<span style="color:#f92672">.</span>magic <span style="color:#f92672">=</span> magic           <span style="color:#75715e"># self.magic = n, the public modulus</span>
        self<span style="color:#f92672">.</span>knowledge <span style="color:#f92672">=</span> year <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>    <span style="color:#75715e"># self.knowledge = 2</span>
        self<span style="color:#f92672">.</span>experience <span style="color:#f92672">=</span> experience <span style="color:#75715e"># self.experience = message</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cast_riddikulus</span>(self, boggart):
        <span style="color:#75715e"># Encrypt the message, m, with the public exponent.</span>
        knowledge, experience <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>knowledge, self<span style="color:#f92672">.</span>experience

        <span style="color:#66d9ef">while</span> boggart <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
            knowledge, experience <span style="color:#f92672">=</span> experience, (experience <span style="color:#f92672">*</span> self<span style="color:#f92672">.</span>experience <span style="color:#f92672">-</span> knowledge) <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>magic
            boggart <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>

        self<span style="color:#f92672">.</span>experience <span style="color:#f92672">=</span> experience</code></pre></div>
<p>It can be expressed in a formula. Suppose that we have the message $m$, with the public key $(n, e)$. The ciphertext $c$ is computed as</p>

<p><span  class="math">\[
\begin{bmatrix}? \\ c\end{bmatrix} \equiv \begin{bmatrix}0 & 1 \\ -1 & m\end{bmatrix}^{e-1}\begin{bmatrix}2 \\ m\end{bmatrix}\ (\text{mod}\ n).
\]</span></p>

<p>It looked weird to me, since I did not expect that $m$ is also included in the transition matrix. However, learning from so much CTFs in the history, I think this cryptosystem is not designed solely for this CTF. I searched with the keywords <em>RSA</em>, <em>Lucas sequence</em> and <em>cryptosystem</em>, and found a paper on LUC cryptosystem<sup class="footnote-ref" id="fnref:luc-crypto"><a class="footnote" href="#fn:luc-crypto">3</a></sup>. To decrypt a message, we need to derive the private key from the ciphertext $c$ and the factorization of $n$. Now what we have done on the first part is useful. Since the public exponents are generated by the <code>Wardrobe</code>, let's look at how it works.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Wardrobe</span>:
    <span style="color:#a6e22e">@staticmethod</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_boggarts</span>(fear, danger): <span style="color:#75715e"># fear = 31337 and danger = 16</span>
        <span style="color:#75715e"># Return an array of public exponents</span>
        <span style="color:#66d9ef">while</span> danger <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
            fear <span style="color:#f92672">=</span> next_prime(fear)

            <span style="color:#66d9ef">if</span> getrandbits(<span style="color:#ae81ff">1</span>):
                <span style="color:#66d9ef">yield</span> fear
                danger <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span></code></pre></div>
<p>In short, 16 public exponents $e_1, e_2, ..., e_{16}$ such that $e_1 &lt; e_2 &lt; ... &lt; e_{16}$ are generated. It is computed as a subsequence of the prime sequence $(31357, 31379, 31387, 31391, ...)$.</p>

<p>Since we are given a message-ciphertext pair $(m_1, c_1)$, I used a <em>meet-in-the-middle</em> approach to find the $e_i$'s. Since each round of the encryption is independent, I can encrypt $m_1$ with $e_1, e_2, ..., e_{10}$ for middletexts. On the other hand, I will decrypt $c_1$ with the private exponents derived from $e_{16}, e_{15}, ..., e_{11}$ for middletexts, too. If they are equal, then $(e_1, e_2, ..., e_{16})$ is the chain of public exponents I want. To speed up, I am working under modulo $p$ instead of modulo $n$. Not only the modulus is smaller, the private exponents are also smaller.</p>

<div class="alert info">
  <strong>Why 10+6 but not 8+8 for MITM?</strong> The decryption is considerably slower (owing to large $d$&rsquo;s) and I think we should be encrypting more.
</div>


<p>After I have complete writing the program, I went to bed. The flag is sitting nicely when I am awake. Nice!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Aero{Do_you_know_Peter_Pettigrew?}</code></pre></div><div class="footnotes">

<hr>

<ol>
<li id="fn:n-partial-info-1"><a href="https://eprint.iacr.org/2020/1506.pdf">IACR 2020/1506: Recovering cryptographic keys from partial information, by example</a>
 <a class="footnote-return" href="#fnref:n-partial-info-1">↩</a></li>
<li id="fn:n-partial-info-2"><a href="https://www.kangacrypt.info/files/NH.pdf">Kangacrypt 2018: How to recover cryptographic keysfrom partial information</a>
 <a class="footnote-return" href="#fnref:n-partial-info-2">↩</a></li>
<li id="fn:luc-crypto"><a href="https://thescipub.com/pdf/jcssp.2008.1056.1060.pdf">A New Computation Algorithm for a Cryptosystem Based on Lucas Functions</a>
 <a class="footnote-return" href="#fnref:luc-crypto">↩</a></li>
</ol>
</div>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://mystiz.hk/posts/2021/2021-03-28-hkcert-ctf/">
                <span class="button__icon">←</span>
                <span class="button__text">HKCERT CTF 2020 Postmortem</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://mystiz.hk/posts/2021/2021-02-27-union-ctf-committee/">
                <span class="button__text">Union CTF 2021 (II): committee</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>


<aside class="toc-container">
  <a href="#" style="text-decoration: none; font-weight: 700;">
    Aero CTF 2021 Writeup
  </a>
  <div class="js-toc"></div>
</aside>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.css" integrity="sha512-SFw7k74K3983tyOlJIHa8atr9Ppef3Kix5cmifwzU7ZdtU2E0FRuOVRtd3ENpMJ8sNCie5hlb/0j23efcdQJXA==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.js" integrity="sha512-oD3xGN8YTxenx6tdS4D/RKqO4OtORBQtAb2/FseM17GGMIi6jMwKUBc8duX4A5RwMOGGXoFBZrsqbOk8GpXFgQ==" crossorigin="anonymous"></script>

<script type="text/javascript">
  tocbot.init({
      headingSelector: 'h1, h2, h3, h4',
      orderedList: false,
      headingLabelCallback: s => s.substr(0, s.length-2),
      collapseDepth: 2
  });
</script>



  </div>
  <aside class="ads">
    
  
  <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-3220069814773012"
    data-ad-slot="6927401005"
    data-ad-format="auto"
    data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>


  </aside>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2023 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://mystiz.hk/assets/main.js"></script>
<script src="https://mystiz.hk/assets/prism.js"></script>






<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }], trust: true })"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/viz.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/2.1.2/full.render.js"></script>
<script>
var viz = new Viz();

document.querySelectorAll("[class=graphviz]").forEach(node => {
  const escape = function (s) {
    const t = s.replace(/&amp;/g, '&')
    return t.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&#34;/g, '"')
  }
  viz.renderSVGElement(escape(node.innerText), {
    engine: 'dot'
  }).then(function (element) {
    node.parentNode.appendChild(element)
    node.style.display = 'none'
  })
})
</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({
    startOnLoad: true,
    htmlLabels: true,
    securityLevel: "loose",
    theme: 'base',
    themeVariables: {
        background: '#22222c',
        primaryColor: '#33333c',
        primaryTextColor: '#ffe4e1',
    }
});
</script>

  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-180181192-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-180181192-1');
</script>



  
</div>

</body>
</html>
